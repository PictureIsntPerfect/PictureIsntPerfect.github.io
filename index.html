<!DOCTYPE html>
<html lang="en" class="theme-default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StonerTalk - Video Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --text-main: #f9fafb; /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --accent-main: #06b6d4; /* cyan-500 */
            --accent-hover: #0891b2; /* cyan-600 */
            --accent-text: #ffffff;
        }

        html.theme-light {
            --bg-main: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e7eb; /* gray-200 */
            --text-main: #111827; /* gray-900 */
            --text-secondary: #4b5563; /* gray-600 */
            --accent-main: #3b82f6; /* blue-500 */
            --accent-hover: #2563eb; /* blue-600 */
            --accent-text: #ffffff;
        }
        
        html.theme-cyberpunk {
            --bg-main: #0c002b;
            --bg-secondary: #1a0552;
            --bg-tertiary: #2e0f80;
            --text-main: #f9ff5a;
            --text-secondary: #b0a8ff;
            --accent-main: #ff00ff; /* Magenta */
            --accent-hover: #c400c4;
            --accent-text: #f9ff5a;
        }

        html.theme-ocean {
             --bg-main: #0a2f4c;
            --bg-secondary: #0e446d;
            --bg-tertiary: #125b8f;
            --text-main: #e0f2fe; /* light-sky-50 */
            --text-secondary: #a8d5f3;
            --accent-main: #34d399; /* emerald-400 */
            --accent-hover: #10b981; /* emerald-500 */
            --accent-text: #0a2f4c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        video {
            transform: scaleX(-1);
        }
        #broadcast-message-container, #global-mute-banner {
            transition: opacity 0.5s, transform 0.5s;
            background-color: var(--accent-main);
            color: var(--accent-text);
        }
        .theme-btn.active, .filter-btn.active, .camera-btn.active {
            background-color: var(--accent-main);
            color: var(--accent-text);
        }
         /* Toggle Switch styles */
        .toggle-bg:after {
            content: '';
            @apply absolute top-0.5 left-0.5 bg-white border border-gray-300 rounded-full h-5 w-5 transition shadow-sm;
        }
        input:checked + .toggle-bg:after {
            @apply transform translate-x-full;
        }
        input:checked + .toggle-bg {
            @apply bg-green-500;
        }

    </style>
</head>
<body class="flex flex-col items-center min-h-screen antialiased">

    <!-- Banners -->
    <div id="broadcast-message-container" class="fixed top-0 left-0 right-0 p-4 text-center z-50 transform -translate-y-full opacity-0">
        <p id="broadcast-message-text"></p>
        <button id="close-broadcast" class="absolute top-2 right-4 text-2xl font-bold">&times;</button>
    </div>
    <div id="global-mute-banner" class="fixed top-0 left-0 right-0 p-4 text-center z-50 transform -translate-y-full opacity-0 bg-yellow-500 text-black">
        <p>All audio is currently muted by an administrator.</p>
    </div>


    <!-- Hidden elements for video processing -->
    <video id="rawVideo" class="hidden" autoplay muted></video>
    <canvas id="videoCanvas" class="hidden"></canvas>


    <!-- Main Application Wrapper -->
    <div id="app" class="w-full max-w-6xl mx-auto p-4 mt-24">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 id="main-title" class="text-4xl font-bold" style="color: var(--accent-main);">StonerTalk</h1>
            <p class="mt-2" style="color: var(--text-secondary);">Connect with strangers from around the world.</p>
        </header>
        
        <!-- Admin Login Button -->
        <div id="admin-login-button-container" class="text-center mb-4">
            <button id="adminLoginBtn" class="font-bold py-2 px-4 rounded-lg transition duration-300" style="background-color: var(--bg-tertiary); color: var(--text-main);">Admin Login</button>
        </div>

        <!-- Admin Login Modal -->
        <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden z-50">
            <div class="p-8 rounded-2xl shadow-2xl w-full max-w-sm" style="background-color: var(--bg-secondary);">
                <h2 class="text-2xl font-bold text-center mb-6">Admin Access</h2>
                <input id="username" type="text" placeholder="Username" class="w-full p-3 mb-4 rounded-lg border focus:outline-none focus:ring-2" style="background-color: var(--bg-tertiary); border-color: var(--accent-main); color: var(--text-main);">
                <input id="password" type="password" placeholder="Password" class="w-full p-3 mb-4 rounded-lg border focus:outline-none focus:ring-2" style="background-color: var(--bg-tertiary); border-color: var(--accent-main); color: var(--text-main);">
                <button id="loginSubmit" class="w-full font-bold py-3 rounded-lg transition duration-300" style="background-color: var(--accent-main); color: var(--accent-text);">Login</button>
                <button id="closeModal" class="w-full font-bold py-2 rounded-lg transition duration-300 mt-2" style="background-color: var(--bg-tertiary); color: var(--text-main);">Cancel</button>
                <p id="loginError" class="text-red-500 text-center mt-4 hidden">Invalid credentials.</p>
            </div>
        </div>

        <!-- Main Content: Chat or Admin Panel -->
        <main id="main-content" class="w-full">
            <!-- User Chat Interface -->
            <div id="chat-interface">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Local Video -->
                    <div class="rounded-2xl shadow-lg p-2 aspect-video flex flex-col" style="background-color: var(--bg-secondary);">
                        <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover rounded-lg"></video>
                        <span class="text-center pt-2" style="color: var(--text-secondary);">You</span>
                    </div>
                    <!-- Remote Video -->
                    <div class="rounded-2xl shadow-lg p-2 aspect-video flex flex-col" style="background-color: var(--bg-secondary);">
                        <div id="remote-video-container" class="w-full h-full flex items-center justify-center bg-black rounded-lg">
                             <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover rounded-lg hidden"></video>
                             <div id="waiting-message" style="color: var(--text-secondary);">Waiting for a partner...</div>
                        </div>
                        <span class="text-center pt-2" style="color: var(--text-secondary);">Stranger</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="mt-6 text-center space-x-2 flex flex-wrap justify-center gap-2">
                    <button id="startBtn" class="text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg text-lg" style="background-color: #16a34a;">Start Chat</button>
                    <button id="nextBtn" class="font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg text-lg hidden" style="background-color: var(--accent-main); color: var(--accent-text);">Next Chat</button>
                    <button id="cameraBtn" class="font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg text-lg" style="background-color: var(--bg-tertiary); color: var(--text-main);">Camera</button>
                    <button id="filtersBtn" class="font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg text-lg" style="background-color: var(--bg-tertiary); color: var(--text-main);">Filters</button>
                    <button id="themesBtn" class="font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg text-lg" style="background-color: var(--bg-tertiary); color: var(--text-main);">Themes</button>
                    <button id="stopBtn" class="text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg text-lg hidden" style="background-color: #dc2626;">Stop</button>
                </div>
                 <p id="status" class="text-center mt-4" style="color: var(--text-secondary);">Press 'Start Chat' to begin.</p>
            </div>

            <!-- Camera Options Modal -->
            <div id="camera-options" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-40">
                <div class="p-6 rounded-xl shadow-2xl w-full max-w-md" style="background-color: var(--bg-secondary);">
                     <h3 class="text-xl font-bold text-center mb-4">Select Camera</h3>
                     <div id="camera-list" class="flex flex-col gap-2">
                        <!-- Camera buttons will be inserted here -->
                     </div>
                     <button id="closeCameraBtn" class="mt-4 w-full font-bold py-2 rounded-lg transition duration-300" style="background-color: var(--bg-tertiary);">Close</button>
                </div>
            </div>

            <!-- Filter Options Modal -->
            <div id="filter-options" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-40">
                <div class="p-6 rounded-xl shadow-2xl" style="background-color: var(--bg-secondary);">
                     <h3 class="text-xl font-bold text-center mb-4">Camera Filters</h3>
                     <div class="grid grid-cols-3 gap-2">
                        <button class="filter-btn p-2 rounded-lg active" data-filter="none">None</button>
                        <button class="filter-btn p-2 rounded-lg" data-filter="grayscale(100%)">Grayscale</button>
                        <button class="filter-btn p-2 rounded-lg" data-filter="sepia(100%)">Sepia</button>
                        <button class="filter-btn p-2 rounded-lg" data-filter="invert(100%)">Invert</button>
                        <button class="filter-btn p-2 rounded-lg" data-filter="contrast(200%)">Contrast</button>
                        <button class="filter-btn p-2 rounded-lg" data-filter="brightness(150%)">Bright</button>
                        <button class="filter-btn p-2 rounded-lg" data-filter="blur(5px)">Blur</button>
                     </div>
                     <button id="closeFiltersBtn" class="mt-4 w-full font-bold py-2 rounded-lg transition duration-300" style="background-color: var(--bg-tertiary);">Close</button>
                </div>
            </div>

            <!-- Theme Options Modal -->
            <div id="theme-options" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-40">
                <div class="p-6 rounded-xl shadow-2xl" style="background-color: var(--bg-secondary);">
                     <h3 class="text-xl font-bold text-center mb-4">Color Themes</h3>
                     <div class="grid grid-cols-2 gap-2">
                        <button class="theme-btn p-2 rounded-lg active" data-theme="theme-default">Default</button>
                        <button class="theme-btn p-2 rounded-lg" data-theme="theme-light">Light</button>
                        <button class="theme-btn p-2 rounded-lg" data-theme="theme-cyberpunk">Cyberpunk</button>
                        <button class="theme-btn p-2 rounded-lg" data-theme="theme-ocean">Ocean</button>
                     </div>
                     <button id="closeThemesBtn" class="mt-4 w-full font-bold py-2 rounded-lg transition duration-300" style="background-color: var(--bg-tertiary);">Close</button>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-6" style="color: var(--accent-main);">Admin Dashboard</h2>

                <!-- Live Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4 rounded-lg text-center" style="background-color: var(--bg-secondary);">
                        <p class="text-2xl font-bold" id="stats-total">0</p>
                        <p style="color: var(--text-secondary);">Total Users Online</p>
                    </div>
                    <div class="p-4 rounded-lg text-center" style="background-color: var(--bg-secondary);">
                        <p class="text-2xl font-bold" id="stats-chatting">0</p>
                        <p style="color: var(--text-secondary);">Users in Chat</p>
                    </div>
                    <div class="p-4 rounded-lg text-center" style="background-color: var(--bg-secondary);">
                        <p class="text-2xl font-bold" id="stats-waiting">0</p>
                        <p style="color: var(--text-secondary);">Users Waiting</p>
                    </div>
                </div>
                
                <!-- Admin Controls -->
                <div class="p-4 rounded-lg mb-6" style="background-color: var(--bg-secondary);">
                    <h3 class="text-xl font-semibold mb-2">Moderation Tools</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                             <h4 class="font-semibold mb-1">Broadcast Message</h4>
                            <div class="flex gap-2">
                                <input type="text" id="broadcast-input" placeholder="Enter your message..." class="flex-grow p-2 rounded-lg border focus:outline-none focus:ring-2" style="background-color: var(--bg-tertiary); color: var(--text-main); border-color: var(--accent-main);">
                                <button id="send-broadcast-btn" class="font-bold py-2 px-4 rounded-lg transition duration-300" style="background-color: var(--accent-main); color: var(--accent-text);">Send</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-2 rounded-lg" style="background-color: var(--bg-tertiary);">
                             <h4 class="font-semibold">Global Audio Mute</h4>
                             <label for="globalMuteToggle" class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="globalMuteToggle" class="sr-only">
                                    <div class="block bg-gray-600 w-10 h-6 rounded-full toggle-bg"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <h3 class="text-2xl font-bold text-center mb-4" style="color: var(--accent-main);">Online Users</h3>
                <div id="admin-users-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Online users will be listed here -->
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBcKpDm14W4GZqQncV1LOtS3Hn5t1kK-hw",
          authDomain: "omegle-c7bdb.firebaseapp.com",
          projectId: "omegle-c7bdb",
          storageBucket: "omegle-c7bdb.appspot.com",
          messagingSenderId: "470349324814",
          appId: "1:470349324814:web:8271072b8d4cd0de01125f",
          measurementId: "G-P65WBJMXX3"
        };
        
        const appId = 'omegle-c7bdb';
        
        let app, db, auth;
        let userId;

        // --- DOM Elements ---
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const rawVideo = document.getElementById('rawVideo');
        const videoCanvas = document.getElementById('videoCanvas');
        const startBtn = document.getElementById('startBtn');
        const nextBtn = document.getElementById('nextBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminLoginButtonContainer = document.getElementById('admin-login-button-container');
        const closeModal = document.getElementById('closeModal');
        const loginSubmit = document.getElementById('loginSubmit');
        const chatInterface = document.getElementById('chat-interface');
        const adminPanel = document.getElementById('admin-panel');
        const adminUsersList = document.getElementById('admin-users-list');
        const waitingMessage = document.getElementById('waiting-message');
        const broadcastContainer = document.getElementById('broadcast-message-container');
        const broadcastText = document.getElementById('broadcast-message-text');
        const closeBroadcastBtn = document.getElementById('close-broadcast');
        const themesBtn = document.getElementById('themesBtn');
        const themeOptions = document.getElementById('theme-options');
        const closeThemesBtn = document.getElementById('closeThemesBtn');
        const filtersBtn = document.getElementById('filtersBtn');
        const filterOptions = document.getElementById('filter-options');
        const closeFiltersBtn = document.getElementById('closeFiltersBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        const cameraOptions = document.getElementById('camera-options');
        const cameraList = document.getElementById('camera-list');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        const globalMuteBanner = document.getElementById('global-mute-banner');
        const globalMuteToggle = document.getElementById('globalMuteToggle');

        // --- State Management ---
        let localStream; // This will now be the canvas stream
        let peerConnection;
        let currentChatId = null;
        let isFindingPartner = false;
        let isAdmin = false;
        let unsubscribeUser, unsubscribeChat, unsubscribeBroadcast, unsubscribeSettings;
        let currentVideoDeviceId = null;
        let currentFilter = 'none';
        let canvasCtx = videoCanvas.getContext('2d');
        let animationFrameId;

        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                {
                    urls: "turn:openrelay.metered.ca:80",
                    username: "openrelayproject",
                    credential: "openrelayproject",
                },
                {
                    urls: "turn:openrelay.metered.ca:443",
                    username: "openrelayproject",
                    credential: "openrelayproject",
                },
            ],
            iceCandidatePoolSize: 10,
        };

        // --- Initialization ---
        async function init() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    await setDoc(userRef, { id: userId, status: 'online' }, { merge: true });
                    
                    await startLocalVideo();
                    await getConnectedDevices('videoinput', cameraList);
                    listenForBroadcasts();
                    listenForSettings();
                    onSnapshot(userRef, (docSnap) => {
                        if(!docSnap.exists() && !isAdmin) {
                            handleKicked();
                        }
                    });
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        statusEl.textContent = "Authentication failed. Please refresh.";
                    });
                }
            });
        }
        
        function handleKicked() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center text-center p-8" style="background-color: var(--bg-main); color: var(--text-main);">
                <div>
                    <h2 class="text-3xl font-bold text-red-500">You have been disconnected</h2>
                    <p class="mt-4" style="color: var(--text-secondary);">An administrator has removed you from the service.</p>
                </div>
            </div>`;
        }

        // --- Video and Filter Processing ---
        function drawVideoOnCanvas() {
            if (rawVideo.paused || rawVideo.ended) {
                cancelAnimationFrame(animationFrameId);
                return;
            }
            
            canvasCtx.filter = currentFilter;
            canvasCtx.drawImage(rawVideo, 0, 0, videoCanvas.width, videoCanvas.height);
            
            animationFrameId = requestAnimationFrame(drawVideoOnCanvas);
        }

        async function startLocalVideo(deviceId = null) {
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            
            currentVideoDeviceId = deviceId;
            const constraints = {
                video: { deviceId: deviceId ? { exact: deviceId } : undefined, width: { ideal: 640 }, height: { ideal: 480 } },
                audio: true,
            };

            try {
                const rawStream = await navigator.mediaDevices.getUserMedia(constraints);
                rawVideo.srcObject = rawStream;
                await rawVideo.play();

                const videoTrackSettings = rawStream.getVideoTracks()[0].getSettings();
                videoCanvas.width = videoTrackSettings.width || 640;
                videoCanvas.height = videoTrackSettings.height || 480;

                drawVideoOnCanvas();
                const audioTracks = rawStream.getAudioTracks();
                const canvasStream = videoCanvas.captureStream();
                const canvasVideoTrack = canvasStream.getVideoTracks()[0];
                localStream = new MediaStream([canvasVideoTrack, ...audioTracks]);

                localVideo.srcObject = localStream;
                startBtn.disabled = false;
                statusEl.textContent = "Ready to connect.";

                if (peerConnection) {
                    const videoSender = peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if (videoSender) videoSender.replaceTrack(canvasVideoTrack);
                    
                    const audioSender = peerConnection.getSenders().find(s => s.track.kind === 'audio');
                    if (audioSender) audioSender.replaceTrack(audioTracks[0]);
                }
            } catch (error) {
                console.error("Error accessing media devices.", error);
                statusEl.textContent = "Could not access camera. Please allow permissions.";
                startBtn.disabled = true;
            }
        }

        async function getConnectedDevices(type, listElement) {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === type);
                listElement.innerHTML = '';
                
                videoDevices.forEach((device, index) => {
                    const button = document.createElement('button');
                    button.classList.add('camera-btn', 'p-2', 'rounded-lg', 'w-full', 'text-left');
                    button.style.backgroundColor = 'var(--bg-tertiary)';
                    button.dataset.deviceId = device.deviceId;
                    button.textContent = device.label || `Camera ${index + 1}`;
                    if( (currentVideoDeviceId === null && index === 0) || currentVideoDeviceId === device.deviceId){
                        button.classList.add('active');
                    }
                    listElement.appendChild(button);
                });
            } catch (error) {
                console.error("Error enumerating devices:", error);
            }
        }

        // --- Core Chat Functions ---
        async function startChat() {
            if (!userId || isFindingPartner) return;
            isFindingPartner = true;
            statusEl.textContent = "Searching for a partner...";
            startBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            stopBtn.classList.remove('hidden');

            await cleanupPreviousChat();
            await updateDoc(doc(db, `artifacts/${appId}/public/data/users`, userId), { status: 'waiting' });

            try {
                const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersRef, where("status", "==", "waiting"));
                const querySnapshot = await getDocs(q);
                
                let partnerId = null;
                querySnapshot.forEach(doc => {
                    if (doc.id !== userId && !partnerId) { partnerId = doc.id; }
                });

                if (partnerId) {
                    currentChatId = `${userId}_${partnerId}`;
                    const chatRef = doc(db, `artifacts/${appId}/public/data/chats`, currentChatId);
                    const batch = writeBatch(db);
                    batch.update(doc(db, `artifacts/${appId}/public/data/users`, userId), { status: 'chatting', chatId: currentChatId });
                    batch.update(doc(db, `artifacts/${appId}/public/data/users`, partnerId), { status: 'chatting', chatId: currentChatId });
                    batch.set(chatRef, { users: [userId, partnerId] });
                    await batch.commit();
                    await createPeerConnection(currentChatId, true);
                } else {
                    listenForChatInitiation();
                }
            } catch (error) {
                console.error("Error starting chat:", error);
                statusEl.textContent = "Error finding a partner. Please try again.";
                resetState();
            } finally {
                isFindingPartner = false;
            }
        }
        
        function listenForChatInitiation() {
            if (unsubscribeUser) unsubscribeUser();
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            unsubscribeUser = onSnapshot(userDocRef, async (docSnap) => {
                const data = docSnap.data();
                if (data && data.status === 'chatting' && data.chatId) {
                    if (unsubscribeUser) unsubscribeUser();
                    currentChatId = data.chatId;
                    statusEl.textContent = "Partner found! Connecting...";
                    await createPeerConnection(currentChatId, false);
                }
            });
        }

        async function createPeerConnection(chatId, isCaller) {
            peerConnection = new RTCPeerConnection(servers);

            peerConnection.oniceconnectionstatechange = () => {
                console.log(`ICE Connection State: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'closed') {
                    stopChat();
                }
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            peerConnection.ontrack = event => {
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    remoteVideo.classList.remove('hidden');
                    waitingMessage.classList.add('hidden');
                    statusEl.textContent = "Connected!";
                }
            };
            
            const chatRef = doc(db, `artifacts/${appId}/public/data/chats`, chatId);
            const offerCandidatesRef = collection(chatRef, 'offerCandidates');
            const answerCandidatesRef = collection(chatRef, 'answerCandidates');

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    const candidatesRef = isCaller ? offerCandidatesRef : answerCandidatesRef;
                    addDoc(candidatesRef, event.candidate.toJSON());
                }
            };
            
            if (isCaller) {
                const offerDescription = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offerDescription);
                const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
                await setDoc(chatRef, { offer }, { merge: true });
                unsubscribeChat = onSnapshot(chatRef, async (snapshot) => {
                    const data = snapshot.data();
                    if (data && data.answer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });
                onSnapshot(answerCandidatesRef, s => s.docChanges().forEach(c => c.type === 'added' && peerConnection.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            } else {
                unsubscribeChat = onSnapshot(chatRef, async (snapshot) => {
                    const data = snapshot.data();
                    if (data && data.offer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answerDescription = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answerDescription);
                        const answer = { sdp: answerDescription.sdp, type: answerDescription.type };
                        await updateDoc(chatRef, { answer });
                    }
                });
                onSnapshot(offerCandidatesRef, s => s.docChanges().forEach(c => c.type === 'added' && peerConnection.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            }
        }
        
        async function cleanupPreviousChat() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if(unsubscribeChat) unsubscribeChat();
            if(unsubscribeUser) unsubscribeUser();
            remoteVideo.srcObject = null;
            remoteVideo.classList.add('hidden');
            waitingMessage.classList.remove('hidden');
            if (currentChatId) {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/chats`, currentChatId)).catch(e => {});
                currentChatId = null;
            }
            if (userId && !isAdmin) {
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                const docSnap = await getDoc(userRef);
                if(docSnap.exists()){
                     await updateDoc(userRef, { status: 'online', chatId: null });
                }
            }
        }
        
        function resetState() {
             cleanupPreviousChat();
             isFindingPartner = false;
             startBtn.classList.remove('hidden');
             nextBtn.classList.add('hidden');
             stopBtn.classList.add('hidden');
             statusEl.textContent = "Ready to connect.";
        }
        
        async function stopChat() {
            await cleanupPreviousChat();
            resetState();
            statusEl.textContent = "Chat ended. Press 'Start Chat' to begin again.";
        }
        
        async function nextChat() {
            await stopChat();
            await startChat();
        }

        // --- Admin & Broadcast Functions ---
        function handleAdminLogin() {
            if (document.getElementById('username').value === 'KHEMIST' && document.getElementById('password').value === 'TEST2121') {
                isAdmin = true;
                adminLoginModal.classList.add('hidden');
                chatInterface.classList.add('hidden');
                adminLoginButtonContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                document.getElementById('send-broadcast-btn').addEventListener('click', sendBroadcast);
                globalMuteToggle.addEventListener('change', handleGlobalMuteToggle);
                startAdminView();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        async function sendBroadcast() {
            const input = document.getElementById('broadcast-input');
            const message = input.value.trim();
            if (message) {
                const broadcastRef = doc(db, `artifacts/${appId}/public/data/globals`, 'broadcast');
                await setDoc(broadcastRef, {
                    message: message,
                    timestamp: serverTimestamp()
                });
                input.value = '';
            }
        }

        function listenForBroadcasts() {
            if (unsubscribeBroadcast) unsubscribeBroadcast();
            const broadcastRef = doc(db, `artifacts/${appId}/public/data/globals`, 'broadcast');
            unsubscribeBroadcast = onSnapshot(broadcastRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    displayBroadcastMessage(data.message);
                }
            });
        }
        
        function displayBroadcastMessage(message) {
            if(isAdmin) return;
            broadcastText.textContent = message;
            broadcastContainer.classList.remove('opacity-0', '-translate-y-full');
            broadcastContainer.classList.add('opacity-100', 'translate-y-0');
        }
        
        closeBroadcastBtn.addEventListener('click', () => {
             broadcastContainer.classList.add('opacity-0', '-translate-y-full');
             broadcastContainer.classList.remove('opacity-100', 'translate-y-0');
        });

        async function kickUser(targetUserId) {
            const userRef = doc(db, `artifacts/${appId}/public/data/users`, targetUserId);
            await deleteDoc(userRef);
        }

        async function handleGlobalMuteToggle(e) {
            const isMuted = e.target.checked;
            const settingsRef = doc(db, `artifacts/${appId}/public/data/globals`, 'settings');
            await setDoc(settingsRef, { isMuted: isMuted }, { merge: true });
        }

        function listenForSettings() {
            const settingsRef = doc(db, `artifacts/${appId}/public/data/globals`, 'settings');
            unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
                const settings = docSnap.data() || {};
                const isMuted = settings.isMuted || false;
                
                if (isAdmin) {
                    globalMuteToggle.checked = isMuted;
                } else {
                    remoteVideo.muted = isMuted;
                    if(isMuted) {
                        globalMuteBanner.classList.remove('opacity-0', '-translate-y-full');
                        globalMuteBanner.classList.add('opacity-100', 'translate-y-0');
                    } else {
                         globalMuteBanner.classList.add('opacity-0', '-translate-y-full');
                         globalMuteBanner.classList.remove('opacity-100', 'translate-y-0');
                    }
                }
            });
        }

        function startAdminView() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            onSnapshot(usersRef, (snapshot) => {
                adminUsersList.innerHTML = '';
                let total = 0;
                let chatting = 0;
                let waiting = 0;

                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    if (user.id === userId) return; 
                    
                    total++;
                    if (user.status === 'chatting') chatting++;
                    if (user.status === 'waiting') waiting++;

                    const userCard = document.createElement('div');
                    userCard.className = 'p-4 rounded-lg shadow-lg flex flex-col justify-between';
                    userCard.style.backgroundColor = 'var(--bg-secondary)';
                    userCard.innerHTML = `
                        <div>
                            <p class="font-semibold truncate" title="${user.id}">User: ${user.id.substring(0,8)}...</p>
                            <p class="text-sm" style="color: var(--text-secondary);">Status: <span style="color: var(--accent-main);">${user.status}</span></p>
                        </div>
                        <button data-kick-id="${user.id}" class="kick-btn mt-2 w-full py-1 text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm">Kick</button>
                    `;
                    adminUsersList.appendChild(userCard);
                });

                document.getElementById('stats-total').textContent = total;
                document.getElementById('stats-chatting').textContent = chatting;
                document.getElementById('stats-waiting').textContent = waiting;
            });
        }
        
        adminUsersList.addEventListener('click', (e) => {
            if(e.target.classList.contains('kick-btn')) {
                const targetUserId = e.target.dataset.kickId;
                if (targetUserId) {
                    kickUser(targetUserId);
                }
            }
        });

        // --- UI Logic ---
        filtersBtn.addEventListener('click', () => filterOptions.classList.remove('hidden'));
        closeFiltersBtn.addEventListener('click', () => filterOptions.classList.add('hidden'));

        filterOptions.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                currentFilter = e.target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });
        
        function applyTheme(themeName) {
            document.documentElement.className = themeName;
        }

        themesBtn.addEventListener('click', () => themeOptions.classList.remove('hidden'));
        closeThemesBtn.addEventListener('click', () => themeOptions.classList.add('hidden'));

        themeOptions.addEventListener('click', (e) => {
            if(e.target.classList.contains('theme-btn')) {
                const theme = e.target.dataset.theme;
                applyTheme(theme);
                document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });
        
        cameraBtn.addEventListener('click', async () => {
            await getConnectedDevices('videoinput', cameraList);
            cameraOptions.classList.remove('hidden');
        });

        closeCameraBtn.addEventListener('click', () => cameraOptions.classList.add('hidden'));
        
        cameraList.addEventListener('click', (e) => {
             if (e.target.classList.contains('camera-btn')) {
                const deviceId = e.target.dataset.deviceId;
                document.querySelectorAll('.camera-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                startLocalVideo(deviceId);
                cameraOptions.classList.add('hidden');
            }
        });

        // --- Event Listeners ---
        startBtn.addEventListener('click', startChat);
        nextBtn.addEventListener('click', nextChat);
        stopBtn.addEventListener('click', stopChat);
        adminLoginBtn.addEventListener('click', () => adminLoginModal.classList.remove('hidden'));
        closeModal.addEventListener('click', () => adminLoginModal.classList.add('hidden'));
        loginSubmit.addEventListener('click', handleAdminLogin);

        window.addEventListener('beforeunload', async () => {
             if (userId) {
                const userRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await deleteDoc(userRef);
             }
        });

        // Initialize the app after the DOM is fully loaded.
        init();

    </script>
</body>
</html>
