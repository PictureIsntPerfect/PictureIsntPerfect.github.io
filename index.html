<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypebeast Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Roboto+Mono:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111111;
            --card-bg-color: #1a1a1a;
            --border-color: #333;
            --text-color: #e0e0e0;
            --accent-color: #00ff9d;
            --accent-glow: rgba(0, 255, 157, 0.5);
            --accent-hover: #00e68e;
            --red-color: #ff3b3b;
            --yellow-color: #ffcc00;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background 0.5s ease;
        }
        
        /* THEME STYLES */
        body.theme-default { background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXVדההדדההדדההדדההדדההדדההדדההדדההדדההדדההדדההd3d1dXV3d3d2d2d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3d3d3d3d1dXV3-'); }
        @keyframes vaporwave-scroll { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body.theme-vaporwave { background: linear-gradient(45deg, #ff71ce, #01cdfe, #05ffa1); background-size: 400% 400%; animation: vaporwave-scroll 15s ease infinite; }
        body.theme-fallout { background-color: #3E422B; background-image: repeating-linear-gradient(0deg, rgba(0,0,0,0.2), rgba(0,0,0,0.2) 1px, transparent 1px, transparent 2px); }
        body.theme-lofi { background-color: #2a2a44; background-image: url('https://www.transparenttextures.com/patterns/rain.png'); }

        .font-grunge { font-family: 'Permanent Marker', cursive; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 0 15px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 25px var(--accent-glow);
        }
        .btn {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--accent-color);
            color: #111;
            font-weight: bold;
            border: none;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%);
            transition: all 0.3s ease;
        }
        .btn:hover {
            background-color: var(--accent-hover);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .btn:disabled {
            background-color: #4a5568;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }
        .item-svg {
            width: 100%;
            height: 120px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .tab-active {
            background-color: var(--accent-color);
            color: #111;
            border-bottom: 2px solid var(--accent-color);
        }
        .tab-inactive {
            background-color: transparent;
            color: #a0aec0;
            border-bottom: 2px solid var(--border-color);
        }
        #admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: 450px;
        }
        .chat-message {
            padding: 4px 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            max-width: 90%;
        }
        .chat-name:hover {
            text-decoration: underline;
            cursor: pointer;
        }
        /* Animated Name Styles */
        @keyframes rainbow-text { 0% { color: #ff0000; } 15% { color: #ff7f00; } 30% { color: #ffff00; } 45% { color: #00ff00; } 60% { color: #0000ff; } 75% { color: #4b0082; } 90% { color: #9400d3; } 100% { color: #ff0000; } }
        .animate-rainbow { animation: rainbow-text 4s linear infinite; }
        @keyframes glow-text { 0%, 100% { text-shadow: 0 0 5px var(--glow-color, #fff), 0 0 10px var(--glow-color, #fff); } 50% { text-shadow: 0 0 10px var(--glow-color, #fff), 0 0 20px var(--glow-color, #fff); } }
        .animate-glow { animation: glow-text 2s ease-in-out infinite; }
        @keyframes pulse-text { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .animate-pulse-text { display: inline-block; animation: pulse-text 1.5s ease-in-out infinite; }
        @keyframes blink-text { 50% { opacity: 0; } }
        .animate-blink { animation: blink-text 1s linear infinite; }
        .gradient-text { background-clip: text; -webkit-background-clip: text; color: transparent; }
        
        /* Trippy/Troll Effects */
        @keyframes screen-shake { 0%, 100% { transform: translate(0, 0); } 10% { transform: translate(-2px, -3px); } 20% { transform: translate(3px, 2px); } 30% { transform: translate(-3px, 3px); } 40% { transform: translate(2px, -2px); } 50% { transform: translate(-3px, 2px); } 60% { transform: translate(3px, 3px); } 70% { transform: translate(-2px, -3px); } 80% { transform: translate(3px, -2px); } 90% { transform: translate(-2px, 3px); } }
        .screen-shake { animation: screen-shake 0.5s linear; }
        .invert-colors { filter: invert(1); }

        @keyframes smite-effect { 0%, 100% { opacity: 0; } 20%, 80% { opacity: 1; } }
        #smite-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; pointer-events: none; animation: smite-effect 0.3s linear; }
        
        h1, h2, h3 { font-family: 'Permanent Marker', cursive; text-shadow: 0 0 10px var(--accent-glow); }
        #game-container > header h1 { font-size: 3.5rem; }

    </style>
</head>
<body class="text-white theme-default">
    <!-- Overlays -->
    <div id="smite-overlay" class="hidden"></div>
    <div id="jumpscare-overlay" class="hidden fixed inset-0 bg-black z-[9999] flex items-center justify-center">
        <img id="jumpscare-image" src="https://i.imgflip.com/670q5z.jpg" class="max-w-full max-h-full">
    </div>
    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="font-grunge text-6xl text-cyan-400 mb-4 animate-pulse">HYPEBEAST SIMULATOR</div>
        <div id="loading-text" class="text-lg font-mono">Connecting to the server...</div>
    </div>
    
    <div id="global-image-container" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[200] flex items-center justify-center p-4">
        <img id="global-image-element" src="" alt="Global Broadcast" class="max-w-full max-h-full rounded-lg shadow-2xl border-4" style="border-color: var(--accent-color);">
    </div>
    
    <div id="global-message-banner" class="hidden fixed top-0 left-0 right-0 p-3 text-center font-bold text-xl z-[201]" style="background-color: var(--yellow-color); color: #111; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);"></div>

    <div class="container mx-auto p-4 max-w-screen-xl hidden" id="game-container">
        <!-- Header -->
        <header class="mb-6 p-4 rounded-lg bg-transparent border-b-4" style="border-color: var(--accent-color);">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-white">HYPEBEAST SIMULATOR</h1>
                    <p class="text-lg">Welcome, <span id="player-display-name" class="font-bold" style="color: var(--yellow-color);"></span></p>
                </div>
                <div class="text-right">
                    <button id="admin-login-btn" class="text-xs px-2 py-1 rounded-full mb-2" style="background-color: var(--red-color); color: white;">Admin</button>
                    <p class="text-sm">Player ID: <span id="player-id" class="font-mono text-gray-400"></span></p>
                    <p class="text-sm text-gray-400">(Share this ID for admin actions)</p>
                </div>
            </div>
        </header>
        
        <div id="event-banner" class="hidden mb-4 p-3 rounded-lg font-bold text-center fade-in text-2xl font-grunge" style="background-color: var(--accent-color); color: #111;"></div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-4 rounded-lg">
                    <h2 class="text-2xl border-b border-gray-600 pb-2 mb-4" style="color: var(--accent-color);">My Empire</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center"><span>Level:</span><span id="player-level" class="text-2xl font-bold" style="color: var(--yellow-color);">0</span></div>
                        <div class="flex justify-between items-center"><span>Cash:</span><span id="player-cash" class="text-2xl font-bold text-green-400">$0</span></div>
                        <div class="flex justify-between items-center"><span>Hype Points:</span><span id="player-hype-points" class="text-2xl font-bold text-orange-400">0</span></div>
                        <div class="flex justify-between items-center"><span>Net Worth:</span><span id="net-worth" class="text-lg font-bold" style="color: var(--yellow-color);">$0</span></div>
                        <div class="flex justify-between items-center"><span>Joined:</span><span id="join-date" class="text-sm text-gray-400"></span></div>
                    </div>
                    <button id="get-starter-pack" class="btn w-full mt-4">Get Starter Pack</button>
                    <button id="buy-loot-box" class="btn w-full mt-2">Buy Loot Box ($500)</button>
                </div>

                <div class="card p-4 rounded-lg">
                    <h2 class="text-2xl border-b border-gray-600 pb-2 mb-4" style="color: var(--accent-color);">My Closet</h2>
                    <div id="player-inventory" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                
                <div class="card p-4 rounded-lg">
                    <h2 class="text-2xl border-b border-gray-600 pb-2 mb-4" style="color: var(--accent-color);">Achievements</h2>
                    <div id="achievements-list" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Center Column -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex border-b" style="border-color: var(--border-color);">
                    <button id="tab-marketplace" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-active">Marketplace</button>
                    <button id="tab-accessories" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-inactive">Accessories</button>
                    <button id="tab-pawn-shop" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-inactive">Pawn Shop</button>
                    <button id="tab-exotic-wares" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-inactive">Exotic Wares</button>
                    <button id="tab-hype-shop" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-inactive">Hype Shop</button>
                </div>

                <div id="main-content-area">
                    <div id="marketplace-container" class="card p-4 rounded-lg"><div id="marketplace" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2"></div></div>
                    <div id="accessories-container" class="card p-4 rounded-lg hidden"><div id="accessories-shop" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2"></div></div>
                    <div id="pawn-shop-container" class="card p-4 rounded-lg hidden">
                         <div class="flex justify-between items-center mb-4">
                              <h3 class="text-xl" style="color: var(--yellow-color);">Second-Hand Goods</h3>
                              <button id="refresh-pawn-stock-btn" class="btn text-sm py-1 px-3">Refresh Stock</button>
                         </div>
                        <div id="pawn-shop" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[650px] overflow-y-auto pr-2"></div>
                    </div>
                    <div id="exotic-wares-container" class="card p-4 rounded-lg hidden">
                        <h3 class="text-xl text-green-400 mb-4">The Collector's Corner</h3>
                        <div id="exotic-wares" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2"></div>
                    </div>
                    <div id="hype-shop-container" class="card p-4 rounded-lg hidden">
                        <h3 class="text-xl text-orange-400 mb-4">Hype Rewards</h3>
                         <div id="hype-shop" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column (Chat & Log) -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card p-4 rounded-lg">
                    <h2 class="text-2xl border-b border-gray-600 pb-2 mb-4" style="color: var(--accent-color);">Activity Feed</h2>
                    <div id="game-log" class="text-sm space-y-2 h-64 overflow-y-auto pr-2"></div>
                </div>
                <div class="card p-4 rounded-lg flex flex-col h-[400px]">
                    <h2 class="text-2xl border-b border-gray-600 pb-2 mb-4" style="color: var(--accent-color);">Global Chat</h2>
                    <div id="chat-box" class="flex-grow flex flex-col space-y-2 overflow-y-auto pr-2 mb-2"></div>
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white" placeholder="Say something...">
                        <button type="submit" class="btn px-4">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="sell-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-40"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-lg mx-auto mt-20"><h3 class="text-2xl mb-4" style="color: var(--accent-color);">Sell Item</h3><div id="sell-item-display" class="mb-4"></div><div class="bg-gray-700 p-3 rounded-lg mb-4"><p class="font-bold">Option 1: List on Player Market</p><p class="text-sm text-gray-400 mb-2">Set your price and wait for another player to buy. High risk, high reward!</p><input type="number" id="sell-price" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white" placeholder="e.g., 500"><button id="confirm-sell" class="btn w-full mt-2">List on Market</button></div><div class="bg-gray-700 p-3 rounded-lg mb-4"><p class="font-bold">Option 2: Sell to AI Collector</p><p class="text-sm text-gray-400 mb-2">Sell instantly for a guaranteed price. Quick cash, but less profit.</p><button id="sell-to-ai-btn" class="btn w-full">Sell Now for <span id="ai-sell-price"></span></button></div><div class="flex justify-end"><button id="cancel-sell" class="btn bg-gray-500 hover:bg-gray-600 px-4 py-2">Cancel</button></div></div></div>
    <div id="message-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-40"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-lg mx-auto mt-20 text-center"><p id="message-text" class="text-lg mb-4"></p><button id="close-message" class="btn px-6 py-2">OK</button></div></div>
    <div id="admin-login-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-50"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-sm mx-auto mt-20"><h3 class="text-2xl mb-4" style="color: var(--red-color);">Admin Login</h3><input type="text" id="admin-user" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white mb-2" placeholder="Username"><input type="password" id="admin-pass" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white mb-4" placeholder="Password"><div class="flex justify-end gap-4"><button id="cancel-admin-login" class="btn bg-gray-500 hover:bg-gray-600">Cancel</button><button id="confirm-admin-login" class="btn" style="background-color: var(--red-color); color: white;">Login</button></div></div></div>
    <div id="confirmation-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-50"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-sm mx-auto mt-20"><h3 id="confirmation-title" class="text-xl mb-4" style="color: var(--yellow-color);">Are you sure?</h3><p id="confirmation-text" class="mb-4">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="cancel-confirmation" class="btn bg-gray-500 hover:bg-gray-600">Cancel</button><button id="confirm-action" class="btn" style="background-color: var(--red-color); color: white;">Confirm</button></div></div></div>
    <div id="player-profile-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-40"><div id="player-profile-content" class="card p-6 rounded-lg w-11/12 md:w-2/3 max-w-4xl mx-auto mt-20 max-h-[80vh] flex flex-col"></div></div>
    <div id="activity-log-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-50"><div class="card p-6 rounded-lg w-11/12 md:w-2/3 max-w-4xl mx-auto mt-20 max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl" style="color: var(--accent-color);">Player Activity Log</h3><button id="close-activity-log-btn" class="btn bg-gray-500 hover:bg-gray-600 px-4 py-2">Close</button></div><div id="activity-log-content" class="flex-grow bg-gray-800 p-3 rounded overflow-y-auto font-mono text-sm"></div></div></div>
    <div id="rickroll-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-[999]"><div class="card p-4 rounded-lg"><img src="https://media.tenor.com/x8v1oNUOmg4AAAAC/rickroll-roll.gif" class="rounded"><button id="close-rickroll-btn" class="btn w-full mt-2">CLOSE</button></div></div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="card p-4 rounded-lg hidden overflow-y-auto max-h-[90vh]">
        <h2 class="text-2xl border-b pb-2 mb-4" style="border-color: var(--red-color); color: var(--red-color);">Admin Controls</h2>
        <div class="space-y-2">
            <details class="bg-gray-700 rounded-lg p-2" open>
                <summary class="font-orbitron text-lg cursor-pointer text-red-400">Live Broadcast</summary>
                <div class="space-y-3 mt-2">
                    <p class="text-xs text-gray-400">Broadcast your camera and mic to all players.</p>
                    <div class="flex gap-2">
                        <button id="admin-start-stream-btn" class="btn w-full bg-green-500 hover:bg-green-600">Start Stream</button>
                    </div>
                </div>
            </details>
            <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg cursor-pointer text-teal-400">Server Stats</summary>
                <div id="admin-server-stats" class="space-y-2 mt-2 text-sm"><p>Loading stats...</p></div>
            </details>
            <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg cursor-pointer" style="color: var(--yellow-color);">Player Management</summary>
                <div class="space-y-3 mt-2">
                    <div>
                        <label class="font-bold">Search Player</label>
                        <div class="flex gap-2">
                           <input type="text" id="admin-player-search" class="w-full bg-gray-800 p-1 rounded" placeholder="Name or ID">
                           <button id="admin-player-search-btn" class="btn text-sm px-2">Find</button>
                        </div>
                        <div id="admin-player-search-results" class="mt-2 text-xs"></div>
                        <div id="admin-selected-player-info" class="mt-2 text-xs bg-gray-800 p-2 rounded hidden"></div>
                    </div>
                    <hr class="border-gray-600">
                    <div><label class="font-bold">Set Level</label><div class="flex gap-2"><input type="text" id="admin-level-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><input type="number" id="admin-level-amount" class="w-32 bg-gray-800 p-1 rounded" placeholder="Level"><button id="admin-set-level-btn" class="btn text-sm px-2">Set</button></div></div>
                    <div><label class="font-bold">Give Cash</label><div class="flex gap-2"><input type="text" id="admin-cash-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><input type="number" id="admin-cash-amount" class="w-32 bg-gray-800 p-1 rounded" placeholder="Amount"><button id="admin-give-cash-btn" class="btn text-sm px-2">Give</button></div></div>
                    <div><label class="font-bold">Take Cash</label><div class="flex gap-2"><input type="text" id="admin-take-cash-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><input type="number" id="admin-take-cash-amount" class="w-32 bg-gray-800 p-1 rounded" placeholder="Amount"><button id="admin-take-cash-btn" class="btn text-sm px-2 bg-red-500">Take</button></div></div>
                    <div><label class="font-bold">Give Hype Points</label><div class="flex gap-2"><input type="text" id="admin-hype-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><input type="number" id="admin-hype-amount" class="w-32 bg-gray-800 p-1 rounded" placeholder="Amount"><button id="admin-give-hype-btn" class="btn text-sm px-2">Give</button></div></div>
                    <div><label class="font-bold">Give Item</label><div class="flex gap-2"><input type="text" id="admin-item-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><select id="admin-item-select" class="w-full bg-gray-800 p-1 rounded"></select><button id="admin-give-item-btn" class="btn text-sm px-2">Give</button></div></div>
                    <hr class="border-gray-600">
                    <div><label class="font-bold">View Player Activity Log</label><div class="flex gap-2"><input type="text" id="admin-activity-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><button id="admin-view-activity-btn" class="btn text-sm px-2">View</button></div></div>
                </div>
            </details>
            <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg text-green-400 cursor-pointer">Cosmetics</summary>
                <div class="space-y-3 mt-2">
                    <div>
                        <label class="font-bold">Set Name Style</label>
                        <input type="text" id="admin-cosmetic-id" class="w-full bg-gray-800 p-1 rounded mb-1" placeholder="Player ID">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="admin-name-animation" class="w-full bg-gray-800 p-1 rounded">
                                <option value="">None</option>
                                <option value="animate-rainbow">Rainbow</option>
                                <option value="animate-glow">Glow</option>
                                <option value="animate-pulse-text">Pulse</option>
                                <option value="animate-blink">Blink</option>
                                <option value="gradient-text">Gradient</option>
                            </select>
                            <input type="text" id="admin-name-color" class="bg-gray-800 p-1 rounded" placeholder="Color/Gradient From">
                        </div>
                         <input type="text" id="admin-gradient-to" class="w-full bg-gray-800 p-1 rounded mt-1" placeholder="Gradient To (optional)">
                         <button id="admin-set-name-style-btn" class="btn text-sm px-2 w-full mt-1">Set Name Style</button>
                    </div>
                </div>
            </details>
            <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg text-cyan-400 cursor-pointer">World & Economy</summary>
                 <div class="space-y-3 mt-2">
                    <div>
                        <label class="font-bold">Global Message Broadcast</label>
                        <div class="flex gap-2">
                            <input type="text" id="admin-global-msg" class="w-full bg-gray-800 p-1 rounded" placeholder="Global Message...">
                            <button id="admin-broadcast-msg-btn" class="btn text-sm px-2">Send</button>
                        </div>
                    </div>
                    <div>
                        <label class="font-bold">Global Theme</label>
                         <select id="admin-theme-select" class="w-full bg-gray-800 p-1 rounded">
                            <option value="theme-default">Default</option>
                            <option value="theme-vaporwave">Vaporwave</option>
                            <option value="theme-fallout">Nuclear Fallout</option>
                            <option value="theme-lofi">Lofi Rain</option>
                        </select>
                        <button id="admin-set-theme-btn" class="btn text-sm px-2 w-full mt-1">Set Theme</button>
                    </div>
                     <div>
                        <label class="font-bold">Broadcast Global Image</label>
                        <input type="text" id="admin-image-url" class="w-full bg-gray-800 p-1 rounded mb-1" placeholder="Image URL">
                        <div class="flex gap-2">
                            <input type="number" id="admin-image-duration" class="w-full bg-gray-800 p-1 rounded" placeholder="Duration (s)">
                            <button id="admin-broadcast-image-btn" class="btn text-sm px-2">Show</button>
                        </div>
                    </div>
                    <div>
                        <label class="font-bold">Start Global Event</label>
                        <div class="flex gap-2">
                            <select id="admin-event-type" class="w-full bg-gray-800 p-1 rounded">
                                <option value="cashRain">Cash Rain (+$1k)</option>
                                <option value="hypeStorm">Hype Storm (+100 HP)</option>
                                <option value="doubleCash">Double Cash Weekend</option>
                                <option value="rareDrops">Increased Rare Drops</option>
                            </select>
                            <button id="admin-start-event-btn" class="btn text-sm px-2">Start</button>
                        </div>
                    </div>
                    <hr class="border-gray-600">
                    <div>
                        <label class="font-bold">Marketplace Control</label>
                        <div class="flex gap-2">
                           <button id="admin-lock-market-btn" class="btn text-sm px-2 w-full bg-yellow-500">Lock</button>
                           <button id="admin-unlock-market-btn" class="btn text-sm px-2 w-full bg-green-500">Unlock</button>
                        </div>
                    </div>
                    <div>
                        <label class="font-bold">Global Gifts</label>
                        <div class="flex gap-2"><input type="number" id="admin-give-all-cash" class="w-full bg-gray-800 p-1 rounded" placeholder="Cash Amount"><button id="admin-give-all-cash-btn" class="btn text-sm px-2">Give All</button></div>
                    </div>
                 </div>
            </details>
             <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg text-purple-400 cursor-pointer">Advanced Actions</summary>
                <div class="space-y-3 mt-2">
                    <div>
                        <label class="font-bold">Fuse Items for Player</label>
                        <div class="flex gap-2">
                            <input type="text" id="admin-fusion-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID">
                            <button id="admin-load-inventory-btn" class="btn text-sm px-2">Load</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="admin-fuse-item1" class="w-full bg-gray-800 p-1 rounded" disabled><option>Load Player First</option></select>
                        <select id="admin-fuse-item2" class="w-full bg-gray-800 p-1 rounded" disabled><option>Load Player First</option></select>
                    </div>
                    <button id="admin-fuse-items-btn" class="btn w-full" disabled>Fuse Items</button>
                    <hr class="border-gray-600">
                    <div><label class="font-bold">Grant All Achievements</label><div class="flex gap-2"><input type="text" id="admin-grant-ach-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><button id="admin-grant-ach-btn" class="btn text-sm px-2">Grant</button></div></div>
                </div>
            </details>
             <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg text-orange-400 cursor-pointer">Troll Menu</summary>
                <div class="space-y-3 mt-2">
                    <div><label class="font-bold">"Smite" Player</label><div class="flex gap-2"><input type="text" id="admin-troll-smite-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID or 'all'"><button id="admin-troll-smite-btn" class="btn text-sm px-2">Smite</button></div></div>
                    <div><label class="font-bold">Screen Shake</label><div class="flex gap-2"><input type="text" id="admin-troll-shake-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID or 'all'"><button id="admin-troll-shake-btn" class="btn text-sm px-2">Shake</button></div></div>
                    <div><label class="font-bold">Invert Colors</label><div class="flex gap-2"><input type="text" id="admin-troll-invert-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID or 'all'"><button id="admin-troll-invert-btn" class="btn text-sm px-2">Invert</button></div></div>
                    <div><label class="font-bold">Rickroll Player</label><div class="flex gap-2"><input type="text" id="admin-troll-rickroll-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID or 'all'"><button id="admin-troll-rickroll-btn" class="btn text-sm px-2">Roll</button></div></div>
                    <div><label class="font-bold">Give Cursed Item</label><div class="flex gap-2"><input type="text" id="admin-troll-curse-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><button id="admin-troll-curse-btn" class="btn text-sm px-2">Curse</button></div></div>
                    <div><label class="font-bold">Jumpscare</label><div class="flex gap-2"><input type="text" id="admin-troll-jumpscare-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID or 'all'"><button id="admin-troll-jumpscare-btn" class="btn text-sm px-2">Scare</button></div></div>
                    <div><label class="font-bold">Fake Ban</label><div class="flex gap-2"><input type="text" id="admin-troll-fakeban-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><button id="admin-troll-fakeban-btn" class="btn text-sm px-2">Fake Ban</button></div></div>
                    <div><label class="font-bold">Force Player Chat</label><div class="flex gap-2"><input type="text" id="admin-troll-forcechat-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><input type="text" id="admin-troll-forcechat-msg" class="w-full bg-gray-800 p-1 rounded" placeholder="Message"><button id="admin-troll-forcechat-btn" class="btn text-sm px-2">Send</button></div></div>
                    <div><label class="font-bold">Play Global Sound</label><div class="flex gap-2"><select id="admin-troll-globalsound-select" class="w-full bg-gray-800 p-1 rounded"><option value="error">Error</option><option value="achievement">Achievement</option><option value="jumpscare">Jumpscare</option></select><button id="admin-troll-globalsound-btn" class="btn text-sm px-2">Play</button></div></div>
                </div>
            </details>
            <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg text-blue-400 cursor-pointer">IP Log</summary>
                <div class="space-y-3 mt-2">
                    <p class="text-xs text-gray-400">Logs player IPs and location info.</p>
                    <button id="admin-fetch-ips-btn" class="btn w-full text-sm px-2">Fetch IP Logs</button>
                    <div id="admin-ip-log-output" class="text-xs max-h-48 overflow-y-auto bg-gray-800 p-2 rounded">Click the button to load logs...</div>
                </div>
            </details>
            <details class="bg-gray-700 rounded-lg p-2">
                <summary class="font-orbitron text-lg cursor-pointer" style="color: var(--red-color);">Danger Zone</summary>
                <div class="space-y-3 mt-2">
                    <div>
                        <label class="font-bold">Punishments</label>
                        <div class="flex gap-2">
                           <input type="text" id="admin-punish-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID">
                           <button id="admin-mute-btn" class="btn text-sm px-2 bg-yellow-500">Mute</button>
                           <button id="admin-ban-btn" class="btn text-sm px-2 bg-red-700 text-white">Ban</button>
                        </div>
                         <div class="flex gap-2 mt-1">
                           <button id="admin-unmute-btn" class="btn text-sm px-2 bg-yellow-300 w-full">Un-Mute</button>
                           <button id="admin-unban-btn" class="btn text-sm px-2 bg-red-400 w-full">Un-Ban</button>
                        </div>
                         <div class="flex gap-2 mt-1">
                           <button id="admin-freeze-btn" class="btn text-sm px-2 bg-blue-500 w-full">Freeze</button>
                           <button id="admin-unfreeze-btn" class="btn text-sm px-2 bg-blue-300 w-full">Un-Freeze</button>
                        </div>
                    </div>
                    <hr class="border-gray-600">
                    <div class="flex gap-2"><input type="text" id="admin-wipe-inv-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID to Wipe Inv"><button id="admin-wipe-inv-btn" class="btn text-sm px-2 w-full" style="background-color: var(--red-color); color: white;">Wipe Inventory</button></div>
                    <div class="flex gap-2 mt-2"><input type="text" id="admin-reset-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID to Reset"><button id="admin-reset-btn" class="btn text-sm px-2 w-full" style="background-color: var(--red-color); color: white;">RESET Player</button></div>
                    <button id="admin-clear-chat-btn" class="btn w-full my-2" style="background-color: var(--red-color); color: white;">Clear Global Chat</button>
                    <button id="admin-clear-economy-btn" class="btn w-full" style="background-color: var(--red-color); color: white;">RESET ENTIRE ECONOMY</button>
                </div>
            </details>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, runTransaction, increment, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit, collectionGroup, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdZ9FVhqazqUdAs72H5PmCzBVsEaqswPI",
            authDomain: "hypebeastgame.firebaseapp.com",
            projectId: "hypebeastgame",
            storageBucket: "hypebeastgame.appspot.com",
            messagingSenderId: "788150739009",
            appId: "1:788150739009:web:9c06e6ae1c5ec15c4c66c0",
        };
        const appId = 'hypebeast-simulator-v2';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentPlayer = null;
        let currentUserId = null;
        let itemToSellId = null;
        let isAdmin = false;
        let confirmationCallback = null;
        let globalImageTimeout = null;
        let globalMessageTimeout = null;
        let ui;

        const BANNED_WORDS = [/nigger/i, /faggot/i, /retard/i]; 

        const clothingItems = {
            'tee01': { name: 'Plain White Tee', baseValue: 15, svg: `<svg viewBox="0 0 100 100" class="item-svg"><path d="M20 30 L80 30 L85 80 L15 80 Z" fill="#fff" stroke="#ccc" stroke-width="1"/><path d="M40 30 C40 15 60 15 60 30" fill="none" stroke="#ccc" stroke-width="1"/></svg>`, category: 'clothing' },
            'hoodie01': { name: 'Graphic Hoodie', baseValue: 80, svg: `<svg viewBox="0 0 100 100" class="item-svg"><path d="M20 40 L80 40 L80 90 L20 90 Z" fill="#555"/><path d="M30 40 C30 20 70 20 70 40" fill="#444"/><text x="50" y="70" font-size="20" fill="#fff" text-anchor="middle" font-family="Orbitron">HYPE</text></svg>`, category: 'clothing' },
            'jacket01': { name: 'Techwear Bomber', baseValue: 400, svg: `<svg viewBox="0 0 100 90" class="item-svg"><path d="M10 20 L90 20 L80 80 L20 80 Z" fill="#111" stroke="#0f0" stroke-width="1"/><path d="M10 20 L0 5 L30 20" fill="#222"/><path d="M90 20 L100 5 L70 20" fill="#222"/></svg>`, category: 'clothing' },
            'jacket02': { name: 'Holographic Puffer', baseValue: 2500, svg: `<svg viewBox="0 0 100 100" class="item-svg"><defs><linearGradient id="holo" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ff00ff"/><stop offset="100%" stop-color="#00ffff"/></linearGradient></defs><path d="M10 30 L90 30 L80 90 L20 90 Z" fill="url(#holo)"/><path d="M10 30 C10 10 90 10 90 30" fill="url(#holo)"/></svg>`, category: 'clothing' },
            'sneaker01': { name: 'Retro Runners', baseValue: 120, svg: `<svg viewBox="0 0 100 50" class="item-svg"><path d="M10 40 L40 40 L50 30 L80 30 L90 40 L95 45 L5 45 Z" fill="#eee" stroke="#000" stroke-width="1"/><path d="M55 30 L60 20 L70 20 L75 30" fill="none" stroke="red" stroke-width="2"/></svg>`, category: 'shoes' },
            'sneaker02': { name: 'Cosmic Kicks', baseValue: 550, svg: `<svg viewBox="0 0 200 100" class="item-svg"><path d="M20 70 L50 70 L60 50 L100 50 L110 70 L180 70 L170 90 L30 90 Z" fill="none" stroke="#FFD700" stroke-width="3"/><path d="M60 50 L70 30 L90 30 L100 50" fill="none" stroke="#FFD700" stroke-width="3"/><path d="M50 70 Q 40 60 40 50 Q 50 40 60 50" fill="#00FFFF" opacity="0.5"/><path d="M110 70 Q 120 60 120 50 Q 110 40 100 50" fill="#FF00FF" opacity="0.5"/></svg>`, category: 'shoes' },
        };
        const accessoryItems = {
            'cap01': { name: 'Basic Dad Cap', baseValue: 20, svg: `<svg viewBox="0 0 100 50" class="item-svg"><path d="M10 25 C 10 10, 90 10, 90 25 L 10 25 Z" fill="#333"/><path d="M10 25 L 90 25 L 100 25 L 0 25 Z" fill="#333" stroke="#000" stroke-width="1"/></svg>`, category: 'accessory' },
            'chain01': { name: 'Gold Chain', baseValue: 800, svg: `<svg viewBox="0 0 100 100" class="item-svg"><g fill="none" stroke="gold" stroke-width="5"><circle cx="50" cy="50" r="40"/><circle cx="50" cy="50" r="30"/><circle cx="50" cy="50" r="20"/></g></svg>`, category: 'accessory' },
            'watch01': { name: 'Iced-Out Watch', baseValue: 5000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><circle cx="50" cy="50" r="30" fill="#eee" stroke="#aaa" stroke-width="2"/><rect x="40" y="5" width="20" height="90" fill="#ccc" rx="5"/><text x="50" y="55" font-size="12" text-anchor="middle" fill="black">💎</text></svg>`, category: 'accessory' },
        };
        const exoticItems = {
            'crystal01': { name: 'Crimson Crystal', cost: 5000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><path d="M50 10 L20 40 L30 90 L70 90 L80 40 Z" fill="#DC143C" stroke="#FF6347" stroke-width="3"/><path d="M50 10 L50 90 M20 40 L80 40 M30 90 L50 40 L70 90" stroke="#FF0000" stroke-width="1.5" opacity="0.7"/></svg>`, category: 'exotic' },
            'orb01': { name: 'Floating Orb', cost: 10000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><defs><radialGradient id="orbGlow" cx="50%" cy="50%" r="50%"><stop offset="60%" stop-color="rgba(255,215,0,1)"/><stop offset="100%" stop-color="rgba(255,165,0,0)"/></radialGradient></defs><circle cx="50" cy="50" r="25" fill="gold"/><circle cx="50" cy="50" r="40" fill="url(#orbGlow)"/><path d="M30 75 Q 50 65, 70 75" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"/></svg>`, category: 'exotic' },
            'datamosh01': { name: 'Datamosh Glitch', cost: 25000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><defs><filter id="glitch"><feTurbulence type="fractalNoise" baseFrequency="0.1 0.4" numOctaves="1" result="warp" /><feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="30" in="SourceGraphic" in2="warp" /></filter></defs><text x="50" y="60" font-size="40" text-anchor="middle" fill="#0f0" filter="url(#glitch)">DATA</text></svg>`, category: 'exotic' },
        };
        const hypeShopItems = {
            'jetpack01': { name: 'Personal Jetpack', points: 50000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><g fill="#FF4500"><rect x="25" y="20" width="20" height="60" rx="10"/><rect x="55" y="20" width="20" height="60" rx="10"/></g><rect x="20" y="50" width="60" height="10" fill="#696969"/><path d="M35 80 L25 100 M65 80 L75 100" stroke="#FFD700" stroke-width="5"/></svg>`, category: 'hype' },
            'namecolor01': { name: 'Custom Name Color', points: 10000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><defs><linearGradient id="name-grad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#ff00ff"/><stop offset="50%" stop-color="#ffff00"/><stop offset="100%" stop-color="#00ffff"/></linearGradient></defs><text x="50" y="60" font-size="24" text-anchor="middle" fill="url(#name-grad)" font-family="Permanent Marker">Style</text></svg>`, category: 'hype' },
        };
        const allItems = {...clothingItems, ...accessoryItems, ...exoticItems, ...hypeShopItems};
        
        const achievements = {
            'first_sale': { name: 'First Sale', description: 'Sell your first item on the marketplace.' },
            'net_worth_10k': { name: 'Baller', description: 'Reach a net worth of $10,000.' },
            'net_worth_100k': { name: 'High Roller', description: 'Reach a net worth of $100,000.' },
            'fused_item': { name: 'Mad Scientist', description: 'Own a fused item.' },
            'exotic_owner': { name: 'Collector', description: 'Own an exotic item.' },
        };

        const sound = {
            synth: new Tone.Synth().toDestination(),
            buy: () => sound.synth.triggerAttackRelease("C5", "8n"),
            sell: () => sound.synth.triggerAttackRelease("G5", "8n"),
            error: () => sound.synth.triggerAttackRelease("C3", "8n"),
            lootbox: () => { const notes = ["C4", "E4", "G4", "C5"]; const now = Tone.now(); notes.forEach((note, i) => sound.synth.triggerAttackRelease(note, "16n", now + i * 0.1)); },
            achievement: () => { const notes = ["C5", "G5", "C6"]; const now = Tone.now(); notes.forEach((note, i) => sound.synth.triggerAttackRelease(note, "8n", now + i * 0.1)); },
            smite: () => new Tone.NoiseSynth().toDestination().triggerAttackRelease("2n"),
            jumpscare: () => { const noise = new Tone.Noise("pink").toDestination(); noise.start(); setTimeout(() => noise.stop(), 500); const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease("A4", "8n"); }
        };

        const formatCash = (amount) => `$${Math.floor(amount).toLocaleString()}`;
        const showMessage = (msg, isTroll = false) => { ui.messageText.innerHTML = msg; ui.messageModal.style.display = 'flex'; if(isTroll) ui.messageText.classList.add('text-red-400'); else ui.messageText.classList.remove('text-red-400'); };
        const showConfirmation = (title, text, callback) => { document.getElementById('confirmation-title').textContent = title; document.getElementById('confirmation-text').innerHTML = text; confirmationCallback = callback; ui.confirmationModal.style.display = 'flex'; };
        const logToGame = async (message) => { try { await addDoc(collection(db, `apps/${appId}/globalLog`), { message, timestamp: serverTimestamp() }); } catch (error) { console.error("Error writing to global log:", error); } };
        const logToPlayerActivity = async (userId, message) => { if (!userId) return; try { const activityRef = collection(db, `apps/${appId}/players/${userId}/activityLog`); await addDoc(activityRef, { message, timestamp: serverTimestamp() }); } catch (error) { console.error(`Error writing to activity log for ${userId}:`, error); } };

        const applyNameStyle = (element, nameStyle) => {
            element.className = 'font-bold';
            element.style.cssText = '';
            if (!nameStyle) { element.style.color = 'var(--yellow-color)'; return; }
            if (nameStyle.animation) element.classList.add(nameStyle.animation);
            if (nameStyle.decoration) element.style.textDecoration = nameStyle.decoration;
            if (nameStyle.shadow) element.style.textShadow = nameStyle.shadow;
            if (nameStyle.animation === 'gradient-text' && nameStyle.color && nameStyle.gradientTo) { element.style.backgroundImage = `linear-gradient(to right, ${nameStyle.color}, ${nameStyle.gradientTo})`; } 
            else if (nameStyle.color) { if (nameStyle.animation === 'animate-glow') element.style.setProperty('--glow-color', nameStyle.color); element.style.color = nameStyle.color; }
        };
        
        const grantAchievement = async (achievementId) => {
            if (!currentPlayer.achievements || !currentPlayer.achievements[achievementId]) {
                try {
                    await updateDoc(doc(db, `apps/${appId}/players`, currentUserId), { [`achievements.${achievementId}`]: true });
                    const achievement = achievements[achievementId];
                    const message = `Unlocked achievement: ${achievement.name}`;
                    showMessage(`🏆 Achievement Unlocked: ${achievement.name}!`);
                    logToGame(`${currentPlayer.displayName} ${message.toLowerCase()}`);
                    logToPlayerActivity(currentUserId, message);
                    sound.achievement();
                } catch (error) { console.error("Error granting achievement:", error); }
            }
        };

        const renderItem = (item, id, container, buttons) => {
            const itemData = allItems[item.itemId] || item;
            if (!itemData || !itemData.name || !itemData.svg) return '';
            const value = item.price || itemData.baseValue || item.points;
            const valueDisplay = container === 'hype-shop' ? `${value.toLocaleString()} HP` : formatCash(value);
            const sellerInfo = item.sellerName ? `<p class="text-xs text-gray-400 truncate">Seller: ${item.sellerName}</p>` : '';
            const categoryInfo = itemData.isCursed ? `<p class="text-xs text-red-500 font-bold">CURSED</p>` : itemData.category === 'fused' ? `<p class="text-xs text-purple-400 font-bold">FUSED</p>` : '';

            return `<div class="card p-3 rounded-lg flex flex-col justify-between fade-in" data-item-id="${id}" data-item-type="${item.itemId || 'custom'}"><div>${itemData.svg}<h4 class="font-bold text-md truncate mt-2">${itemData.name}</h4>${sellerInfo} ${categoryInfo}</div><div class="mt-2"><p class="text-lg font-orbitron" style="color: var(--accent-color);">${valueDisplay}</p>${buttons}</div></div>`;
        };
        
        const updatePlayerUI = (playerData) => {
            if (!playerData) return;
            const wasFrozen = currentPlayer?.isFrozen;
            currentPlayer = playerData;

            if (playerData.isFrozen && !wasFrozen) {
                showMessage("You have been frozen by an admin! You cannot perform actions.", true);
            } else if (!playerData.isFrozen && wasFrozen) {
                showMessage("You have been unfrozen.");
            }

            ui.playerDisplayName.textContent = playerData.displayName;
            applyNameStyle(ui.playerDisplayName, playerData.nameStyle);
            
            ui.playerLevel.textContent = playerData.level || 0;
            ui.playerCash.textContent = formatCash(playerData.cash || 0);
            ui.playerHypePoints.textContent = (playerData.hypePoints || 0).toLocaleString();
            ui.joinDate.textContent = playerData.createdAt?.seconds ? new Date(playerData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
            
            const inventoryVal = Object.values(playerData.inventory || {}).reduce((acc, item) => { const itemData = allItems[item.itemId] || item; return acc + (itemData.baseValue || 0); }, 0);
            const netWorth = (playerData.cash || 0) + inventoryVal;
            ui.netWorth.textContent = formatCash(netWorth);

            ui.getStarterPackBtn.disabled = playerData.hasStarterPack || playerData.isFrozen;
            ui.buyLootBoxBtn.disabled = (playerData.cash || 0) < 500 || playerData.isFrozen;

            ui.playerInventory.innerHTML = Object.entries(playerData.inventory || {}).map(([id, item]) => renderItem(item, id, 'inventory', `<button class="btn sell-btn w-full text-sm mt-1" ${playerData.isFrozen ? 'disabled' : ''}>Sell</button>`)).join('');
                        
            ui.achievementsList.innerHTML = Object.keys(achievements).map(id => {
                const achieved = playerData.achievements && playerData.achievements[id];
                const ach = achievements[id];
                return `<div class="flex items-center ${achieved ? 'text-green-400' : 'text-gray-500'}"><span class="mr-2">${achieved ? '🏆' : '🔒'}</span><div><p class="font-bold">${ach.name}</p><p class="text-xs">${ach.description}</p></div></div>`;
            }).join('');

            // Check achievements
            if (netWorth >= 10000) grantAchievement('net_worth_10k');
            if (netWorth >= 100000) grantAchievement('net_worth_100k');
            if (Object.values(playerData.inventory || {}).some(item => (allItems[item.itemId] || item).category === 'fused')) grantAchievement('fused_item');
            if (Object.values(playerData.inventory || {}).some(item => (allItems[item.itemId] || item).category === 'exotic')) grantAchievement('exotic_owner');
        };
        
        const updateMarketplaceUI = (listings, isLocked) => { ui.marketplace.innerHTML = Object.entries(listings).map(([id, item]) => { const buyButton = item.sellerId !== currentUserId ? `<button class="btn buy-btn w-full text-sm mt-1" ${isLocked ? 'disabled' : ''}>Buy</button>` : `<button class="btn delist-btn w-full text-sm mt-1" style="background-color: var(--red-color); color: white;" ${isLocked ? 'disabled' : ''}>Delist</button>`; return renderItem(item, id, 'marketplace', buyButton); }).join(''); };
        const updateShopUI = (shopId, element, items, buttonClass, buttonText, valueType) => { element.innerHTML = Object.entries(items).map(([id, itemData]) => { const value = itemData.cost || itemData.points || itemData.baseValue; const item = { itemId: id, [valueType]: value }; const buttons = `<button class="btn ${buttonClass} w-full text-sm mt-1">${buttonText}</button>`; return renderItem(item, id, shopId, buttons); }).join(''); };
        const updateGameLogUI = (logs) => { ui.gameLog.innerHTML = logs.map(log => `<div class="fade-in">${log.message}</div>`).join(''); ui.gameLog.scrollTop = ui.gameLog.scrollHeight; };
        const updateChatUI = (messages) => {
            ui.chatBox.innerHTML = messages.map(msg => {
                const align = msg.userId === currentUserId ? 'self-end' : 'self-start';
                const bgColor = msg.userId === currentUserId ? 'bg-green-900' : 'bg-gray-700';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${msg.displayName}: `;
                nameSpan.dataset.userId = msg.userId;
                if (msg.nameStyle) applyNameStyle(nameSpan, msg.nameStyle);
                else nameSpan.className = `chat-name font-bold ${msg.isAdmin ? 'text-red-400' : 'text-yellow-300'}`;
                const messageSpan = document.createElement('span');
                messageSpan.className = 'text-white';
                messageSpan.textContent = msg.message;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${align} ${bgColor} fade-in`;
                messageDiv.appendChild(nameSpan);
                messageDiv.appendChild(messageSpan);
                return messageDiv.outerHTML;
            }).join('');
            ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
        };

        async function initializePlayer(user) {
            try {
                currentUserId = user.uid;
                ui.playerId.textContent = currentUserId;
                const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                let playerSnap = await getDoc(playerRef);
                
                if (playerSnap.exists() && playerSnap.data().isBanned) {
                    document.getElementById("loading-text").textContent = "Your account has been banned.";
                    document.getElementById("loading-text").classList.add('text-red-500');
                    return;
                }

                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    const ip = data.ip;
                    const ipLogRef = doc(db, `apps/${appId}/ipLogs`, currentUserId);
                    await setDoc(ipLogRef, { ip: ip, lastSeen: serverTimestamp(), userId: currentUserId, displayName: playerSnap.exists() ? playerSnap.data().displayName : `Player-${currentUserId.substring(0, 5)}` }, { merge: true });
                } catch (ipError) { console.error("Could not log IP address:", ipError); }

                if (!playerSnap.exists()) {
                    const initialData = { displayName: `Player-${currentUserId.substring(0, 5)}`, cash: 100, level: 1, hypePoints: 0, itemsSold: 0, inventory: {}, hasStarterPack: false, nameStyle: null, achievements: {}, createdAt: serverTimestamp(), lastLogin: serverTimestamp(), isMuted: false, isBanned: false, isFrozen: false };
                    await setDoc(playerRef, initialData);
                    logToGame(`A new player has arrived: ${initialData.displayName}`);
                    logToPlayerActivity(currentUserId, "Initial player profile created.");
                } else {
                    const playerData = playerSnap.data();
                    if (playerData.lastLogin && typeof playerData.lastLogin.toDate === 'function') {
                        const now = new Date();
                        const lastLogin = playerData.lastLogin.toDate();
                        if (now.getDate() !== lastLogin.getDate() || now.getMonth() !== lastLogin.getMonth() || now.getFullYear() !== lastLogin.getFullYear()) {
                            const cashBonus = 500;
                            const hypeBonus = 50;
                            await updateDoc(playerRef, { lastLogin: serverTimestamp(), cash: increment(cashBonus), hypePoints: increment(hypeBonus) });
                            const message = `Received daily login bonus of ${formatCash(cashBonus)} and ${hypeBonus} HP.`;
                            showMessage(`Welcome back! You received a daily login bonus of ${formatCash(cashBonus)} and ${hypeBonus} Hype Points!`);
                            logToPlayerActivity(currentUserId, message);
                        }
                    } else { await updateDoc(playerRef, { lastLogin: serverTimestamp() }); }
                    logToPlayerActivity(currentUserId, "Player logged in.");
                }
                
                onSnapshot(playerRef, (doc) => updatePlayerUI(doc.data()));
            } catch (error) {
                console.error("Critical error during player initialization:", error);
                const loadingText = document.getElementById("loading-text");
                if (loadingText) { loadingText.textContent = "Error loading your profile. Please refresh and try again."; loadingText.classList.add('text-red-500'); }
            }
        }
        
        function setupEventListeners() {
            const isPlayerActionDisabled = () => {
                if(currentPlayer.isFrozen) {
                    showMessage("You are frozen and cannot perform this action.", true);
                    return true;
                }
                return false;
            }

            ui.getStarterPackBtn.addEventListener('click', async () => {
                if (isPlayerActionDisabled() || currentPlayer.hasStarterPack) return;
                try {
                    await updateDoc(doc(db, `apps/${appId}/players`, currentUserId), { hasStarterPack: true, cash: increment(200), [`inventory.item_${Date.now()}_1`]: { itemId: 'tee01' }, [`inventory.item_${Date.now()}_2`]: { itemId: 'cap01' }, });
                    const message = "Received starter pack (+200 Cash, White Tee, Dad Cap).";
                    logToGame(`${currentPlayer.displayName} got a starter pack!`);
                    logToPlayerActivity(currentUserId, message);
                    showMessage("Starter pack received!");
                    sound.buy();
                } catch (error) { console.error("Starter Pack Error: ", error); showMessage("Could not get starter pack."); sound.error(); }
            });

            ui.buyLootBoxBtn.addEventListener('click', async () => {
                if (isPlayerActionDisabled() || currentPlayer.cash < 500) return;
                try {
                    const lootTable = { ...clothingItems, ...accessoryItems, ...exoticItems };
                    const itemKeys = Object.keys(lootTable);
                    const randomItemId = itemKeys[Math.floor(Math.random() * itemKeys.length)];
                    await updateDoc(doc(db, `apps/${appId}/players`, currentUserId), { cash: increment(-500), [`inventory.item_${Date.now()}`]: { itemId: randomItemId } });
                    const itemName = allItems[randomItemId].name;
                    const message = `Opened a loot box (-$500) and found a ${itemName}.`;
                    logToGame(`${currentPlayer.displayName} ${message.toLowerCase()}`);
                    logToPlayerActivity(currentUserId, message);
                    showMessage(`You found a ${itemName}!`);
                    sound.lootbox();
                } catch (error) { console.error("Loot Box Error: ", error); showMessage("Failed to open loot box."); sound.error(); }
            });

            ui.playerInventory.addEventListener('click', (e) => {
                if (isPlayerActionDisabled()) return;
                if (e.target.classList.contains('sell-btn')) {
                    const itemEl = e.target.closest('[data-item-id]');
                    itemToSellId = itemEl.dataset.itemId;
                    const itemData = allItems[itemEl.dataset.itemType] || currentPlayer.inventory[itemToSellId];
                    if (itemData.isCursed) { showMessage("You cannot sell a cursed item!"); sound.error(); return; }
                    ui.sellItemDisplay.innerHTML = renderItem(itemData, itemToSellId, 'sell-modal', '');
                    const aiPrice = Math.floor((itemData.baseValue || 0) * 0.7);
                    ui.aiSellPrice.textContent = formatCash(aiPrice);
                    ui.sellToAIBtn.dataset.price = aiPrice;
                    ui.sellPriceInput.value = itemData.baseValue || 0;
                    ui.sellModal.style.display = 'flex';
                }
            });

            ui.cancelSellBtn.addEventListener('click', () => ui.sellModal.style.display = 'none');
            ui.closeMessageBtn.addEventListener('click', () => ui.messageModal.style.display = 'none');

            ui.confirmSellBtn.addEventListener('click', async () => {
                if (isPlayerActionDisabled()) return;
                const price = parseInt(ui.sellPriceInput.value);
                if (!itemToSellId || isNaN(price) || price <= 0) { showMessage("Invalid price."); return; }
                try {
                    const itemData = currentPlayer.inventory[itemToSellId];
                    const itemName = (allItems[itemData.itemId] || itemData).name;
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                        const playerDoc = await transaction.get(playerRef);
                        const inventory = playerDoc.data().inventory;
                        const itemToSell = inventory[itemToSellId];
                        if (!itemToSell) throw "Item not found.";
                        if ((allItems[itemToSell.itemId] || itemToSell).isCursed) throw "Cannot sell a cursed item.";
                        const newListingRef = doc(collection(db, `apps/${appId}/marketplace`));
                        transaction.set(newListingRef, { ...itemToSell, price, sellerId: currentUserId, sellerName: currentPlayer.displayName });
                        delete inventory[itemToSellId];
                        transaction.update(playerRef, { inventory });
                    });
                    const message = `Listed a ${itemName} on the marketplace for ${formatCash(price)}.`;
                    logToGame(`${currentPlayer.displayName} ${message.toLowerCase()}`);
                    logToPlayerActivity(currentUserId, message);
                    showMessage("Item listed!");
                    ui.sellModal.style.display = 'none';
                    sound.sell();
                    grantAchievement('first_sale');
                } catch (error) { console.error("Listing Error: ", error); showMessage(`Failed to list item: ${error}`); sound.error(); }
            });
            
            ui.sellToAIBtn.addEventListener('click', async () => {
                if (isPlayerActionDisabled()) return;
                const price = parseInt(ui.sellToAIBtn.dataset.price);
                 if (!itemToSellId || isNaN(price) || price < 0) return;
                try {
                    const itemData = currentPlayer.inventory[itemToSellId];
                    if (!itemData) throw new Error("Item not in inventory");
                    const itemName = (allItems[itemData.itemId] || itemData).name;
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                        const playerDoc = await transaction.get(playerRef);
                        const inventory = playerDoc.data().inventory;
                        if (!inventory[itemToSellId]) throw "Item not in inventory";
                        delete inventory[itemToSellId];
                        transaction.update(playerRef, { inventory, cash: increment(price) });
                    });
                    const message = `Quick-sold a ${itemName} for ${formatCash(price)}.`;
                    logToGame(`${currentPlayer.displayName} ${message.toLowerCase()}`);
                    logToPlayerActivity(currentUserId, message);
                    showMessage("Item sold!");
                    ui.sellModal.style.display = 'none';
                    sound.sell();
                    grantAchievement('first_sale');
                } catch(e) { console.error("AI Sell Error: ", e); showMessage("Failed to sell item."); sound.error(); }
            });

            ui.marketplace.addEventListener('click', async (e) => {
                if (isPlayerActionDisabled()) return;
                const listingEl = e.target.closest('[data-item-id]');
                if (!listingEl) return;
                const listingId = listingEl.dataset.itemId;
                if (e.target.classList.contains('buy-btn')) {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const listingRef = doc(db, `apps/${appId}/marketplace`, listingId);
                            const listingDoc = await transaction.get(listingRef);
                            if (!listingDoc.exists()) throw "Listing no longer available.";
                            const listing = listingDoc.data();
                            const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                            const playerDoc = await transaction.get(playerRef);
                            if (playerDoc.data().cash < listing.price) throw "Not enough cash.";
                            const sellerRef = doc(db, `apps/${appId}/players`, listing.sellerId);
                            const { price, sellerId, sellerName, ...itemData } = listing;
                            transaction.update(playerRef, { cash: increment(-listing.price), [`inventory.item_${Date.now()}`]: itemData });
                            transaction.update(sellerRef, { cash: increment(listing.price) });
                            transaction.delete(listingRef);
                            const itemName = (allItems[itemData.itemId] || itemData).name;
                            const message = `Bought a ${itemName} from ${sellerName} for ${formatCash(price)}.`;
                            logToPlayerActivity(currentUserId, message);
                            logToPlayerActivity(sellerId, `Sold a ${itemName} to ${currentPlayer.displayName} for ${formatCash(price)}.`);
                            logToGame(`${currentPlayer.displayName} bought a ${itemName}.`);
                        });
                        showMessage("Purchase successful!");
                        sound.buy();
                    } catch (error) { console.error("Purchase Error:", error); showMessage(`Purchase failed: ${error}`); sound.error(); }
                } else if (e.target.classList.contains('delist-btn')) {
                     try {
                        await runTransaction(db, async (transaction) => {
                            const listingRef = doc(db, `apps/${appId}/marketplace`, listingId);
                            const listingDoc = await transaction.get(listingRef);
                            if (!listingDoc.exists()) throw "Listing not found.";
                            const listing = listingDoc.data();
                            if(listing.sellerId !== currentUserId) throw "Not your listing.";
                            const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                            const { price, sellerId, sellerName, ...itemData } = listing;
                            transaction.update(playerRef, { [`inventory.item_${Date.now()}`]: itemData });
                            transaction.delete(listingRef);
                            const itemName = (allItems[itemData.itemId] || itemData).name;
                            logToPlayerActivity(currentUserId, `Delisted a ${itemName}.`);
                        });
                        showMessage("Item delisted.");
                    } catch (error) { console.error("Delist Error:", error); showMessage(`Failed to delist: ${error}`); sound.error(); }
                }
            });

            Object.keys(ui.tabs).forEach(tabKey => {
                ui.tabs[tabKey].addEventListener('click', () => {
                    Object.values(ui.tabs).forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
                    Object.values(ui.containers).forEach(c => c.classList.add('hidden'));
                    ui.tabs[tabKey].classList.replace('tab-inactive', 'tab-active');
                    ui.containers[tabKey].classList.remove('hidden');
                });
            });

            const setupShopListener = (containerId, buttonClass, shopItems, valueType, costField) => {
                document.getElementById(containerId).addEventListener('click', async (e) => {
                    if (isPlayerActionDisabled() || !e.target.classList.contains(buttonClass)) return;
                    const itemEl = e.target.closest('[data-item-id]');
                    const itemId = itemEl.dataset.itemType;
                    const itemData = shopItems[itemId];
                    const cost = itemData[costField];
                    if (currentPlayer[valueType] < cost) { showMessage(`Not enough ${valueType === 'cash' ? 'Cash' : 'Hype Points'}.`); sound.error(); return; }
                    try {
                        await updateDoc(doc(db, `apps/${appId}/players`, currentUserId), { [valueType]: increment(-cost), [`inventory.item_${Date.now()}`]: { itemId } });
                        const message = `Bought a ${itemData.name} from a shop.`;
                        showMessage(`You bought a ${itemData.name}!`);
                        logToGame(`${currentPlayer.displayName} ${message.toLowerCase()}`);
                        logToPlayerActivity(currentUserId, message);
                        sound.buy();
                    } catch (error) { console.error("Shop purchase error:", error); showMessage("Purchase failed."); sound.error(); }
                });
            };

            setupShopListener('accessories-container', 'buy-accessory-item-btn', accessoryItems, 'cash', 'baseValue');
            setupShopListener('pawn-shop-container', 'buy-pawn-item-btn', clothingItems, 'cash', 'baseValue');
            setupShopListener('exotic-wares-container', 'buy-exotic-item-btn', exoticItems, 'cash', 'cost');
            setupShopListener('hype-shop-container', 'buy-hype-item-btn', hypeShopItems, 'hypePoints', 'points');

            ui.refreshPawnStockBtn.addEventListener('click', () => { updateShopUI('pawn-shop', ui.pawnShop, clothingItems, 'buy-pawn-item-btn', 'Buy', 'baseValue'); showMessage("Pawn shop stock refreshed."); });

            ui.chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (isPlayerActionDisabled() || currentPlayer.isMuted) { showMessage("You are muted and cannot send messages."); return; }
                const messageText = ui.chatInput.value.trim();
                if (messageText === '' || !currentUserId || !currentPlayer) return;
                for (const pattern of BANNED_WORDS) { if (pattern.test(messageText)) { showMessage("Your message contains inappropriate language."); ui.chatInput.value = ''; return; } }
                try {
                    await addDoc(collection(db, `apps/${appId}/globalChat`), { userId: currentUserId, displayName: currentPlayer.displayName, message: messageText, timestamp: serverTimestamp(), isAdmin, nameStyle: currentPlayer.nameStyle || null });
                    ui.chatInput.value = '';
                } catch (error) { console.error("Error sending chat message: ", error); showMessage(`Error sending message.`); }
            });
            
            document.getElementById('cancel-confirmation').addEventListener('click', () => { ui.confirmationModal.style.display = 'none'; confirmationCallback = null; });
            document.getElementById('confirm-action').addEventListener('click', () => { if (confirmationCallback) confirmationCallback(); ui.confirmationModal.style.display = 'none'; confirmationCallback = null; });
            
            ui.chatBox.addEventListener('click', async (e) => {
                if(e.target.classList.contains('chat-name')) {
                    const targetId = e.target.dataset.userId;
                    if (!targetId) return;
                    try {
                        const playerSnap = await getDoc(doc(db, `apps/${appId}/players`, targetId));
                        if (!playerSnap.exists()) { showMessage("Could not find player profile."); return; }
                        const pData = playerSnap.data();
                        const invVal = Object.values(pData.inventory || {}).reduce((acc, item) => acc + (allItems[item.itemId] || item).baseValue || 0, 0);
                        const profileNameSpan = document.createElement('span');
                        profileNameSpan.textContent = pData.displayName;
                        applyNameStyle(profileNameSpan, pData.nameStyle);
                        if (!pData.nameStyle) profileNameSpan.className = 'font-bold text-2xl text-yellow-300';
                        ui.playerProfileContent.innerHTML = `<div class="flex justify-between items-start"><div><h3 class="text-3xl font-grunge mb-2">${profileNameSpan.outerHTML}</h3><p class="text-gray-400">Joined: ${pData.createdAt ? new Date(pData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p><p class="text-lg">Net Worth: <span class="font-bold text-yellow-400">${formatCash((pData.cash || 0) + invVal)}</span></p></div><button id="close-profile-btn" class="btn bg-gray-500 hover:bg-gray-600 px-4 py-2">Close</button></div><hr class="border-gray-600 my-4"><h4 class="text-xl font-grunge" style="color: var(--accent-color);">Inventory</h4><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto pr-2">${Object.entries(pData.inventory || {}).map(([id, item]) => renderItem(item, id, 'profile', '')).join('') || '<p class="text-gray-500 col-span-full">This player has no items.</p>'}</div>`;
                        ui.playerProfileModal.style.display = 'flex';
                        document.getElementById('close-profile-btn').addEventListener('click', () => ui.playerProfileModal.style.display = 'none');
                    } catch (err) { console.error("Profile load error", err); showMessage("Error loading profile."); }
                }
            });
        }

        function setupAdminEventListeners() {
            document.getElementById('confirm-admin-login').addEventListener('click', () => { const user = document.getElementById('admin-user').value; const pass = document.getElementById('admin-pass').value; if (user === 'DAVE' && pass === 'CATS') { isAdmin = true; ui.adminPanel.classList.remove('hidden'); ui.adminLoginModal.style.display = 'none'; logToGame('Admin access granted.'); showMessage('Admin access granted.'); fetchServerStats(); } else { showMessage('Invalid admin credentials.'); } });
            ui.adminLoginBtn.addEventListener('click', () => ui.adminLoginModal.style.display = 'flex');
            document.getElementById('cancel-admin-login').addEventListener('click', () => ui.adminLoginModal.style.display = 'none');

            const setupAdminAction = (buttonId, idInputId, valueInputId, action) => { document.getElementById(buttonId).addEventListener('click', async () => { const targetId = document.getElementById(idInputId)?.value.trim(); const valueEl = document.getElementById(valueInputId); const value = valueEl ? (valueEl.type === 'number' ? parseInt(valueEl.value) : valueEl.value) : null; if (!targetId && idInputId) { showMessage("Player ID is required."); return; } await action(targetId, value); }); };

            setupAdminAction('admin-set-level-btn', 'admin-level-id', 'admin-level-amount', async (id, amount) => { if (isNaN(amount) || amount < 1) { showMessage("Valid level is required."); return; } const message = `Admin set level to ${amount}.`; await updateDoc(doc(db, `apps/${appId}/players`, id), { level: amount }); logToPlayerActivity(id, message); showMessage(`Player ${id}'s level set to ${amount}.`); });
            setupAdminAction('admin-give-cash-btn', 'admin-cash-id', 'admin-cash-amount', async (id, amount) => { if (isNaN(amount)) { showMessage("Valid amount is required."); return; } const message = `Admin gave ${formatCash(amount)}.`; await updateDoc(doc(db, `apps/${appId}/players`, id), { cash: increment(amount) }); logToPlayerActivity(id, message); showMessage(`Gave ${formatCash(amount)} to player ${id}.`); });
            setupAdminAction('admin-take-cash-btn', 'admin-take-cash-id', 'admin-take-cash-amount', async (id, amount) => { if (isNaN(amount)) { showMessage("Valid amount is required."); return; } const message = `Admin took ${formatCash(amount)}.`; await updateDoc(doc(db, `apps/${appId}/players`, id), { cash: increment(-amount) }); logToPlayerActivity(id, message); showMessage(`Took ${formatCash(amount)} from player ${id}.`); });
            setupAdminAction('admin-give-hype-btn', 'admin-hype-id', 'admin-hype-amount', async (id, amount) => { if (isNaN(amount)) { showMessage("Valid amount is required."); return; } const message = `Admin gave ${amount.toLocaleString()} Hype Points.`; await updateDoc(doc(db, `apps/${appId}/players`, id), { hypePoints: increment(amount) }); logToPlayerActivity(id, message); showMessage(`Gave ${amount.toLocaleString()} HP to player ${id}.`); });
            setupAdminAction('admin-give-item-btn', 'admin-item-id', 'admin-item-select', async (id, itemId) => { const message = `Admin gave item: ${allItems[itemId].name}.`; await updateDoc(doc(db, `apps/${appId}/players`, id), { [`inventory.item_${Date.now()}`]: { itemId } }); logToPlayerActivity(id, message); showMessage(`Gave ${allItems[itemId].name} to player ${id}.`); });

            document.getElementById('admin-set-name-style-btn').addEventListener('click', async () => { const targetId = document.getElementById('admin-cosmetic-id').value.trim(); if (!targetId) { showMessage("Player ID is required."); return; } const animation = document.getElementById('admin-name-animation').value; const color = document.getElementById('admin-name-color').value.trim(); const gradientTo = document.getElementById('admin-gradient-to').value.trim(); const nameStyle = { animation: animation || null, color: color || null, gradientTo: gradientTo || null }; try { await updateDoc(doc(db, `apps/${appId}/players`, targetId), { nameStyle }); logToPlayerActivity(targetId, `Admin updated name style.`); showMessage(`Style updated for player ${targetId}.`); } catch (error) { console.error("Error setting name style:", error); showMessage("Failed to set style."); } });
            document.getElementById('admin-broadcast-image-btn').addEventListener('click', async () => { const imageUrl = document.getElementById('admin-image-url').value.trim(); const duration = parseInt(document.getElementById('admin-image-duration').value); if (!imageUrl || isNaN(duration) || duration <= 0) { showMessage("Valid URL and duration required."); return; } try { await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { globalImage: { url: imageUrl, expiry: Date.now() + (duration * 1000) } }, { merge: true }); showMessage(`Broadcasting image for ${duration}s.`); } catch (error) { console.error("Error broadcasting image:", error); showMessage("Broadcast failed."); } });
            document.getElementById('admin-broadcast-msg-btn').addEventListener('click', async () => { const msg = document.getElementById('admin-global-msg').value.trim(); if (!msg) { showMessage("Message cannot be empty."); return; } try { await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { globalMessage: { text: msg, expiry: Date.now() + (30 * 1000) } }, { merge: true }); showMessage(`Broadcasting message.`); } catch (error) { console.error("Error broadcasting message:", error); showMessage("Broadcast failed."); } });
            document.getElementById('admin-set-theme-btn').addEventListener('click', async () => { const theme = document.getElementById('admin-theme-select').value; try { await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { theme: theme || 'theme-default' }, { merge: true }); showMessage(`Theme set to: ${theme}.`); } catch (error) { console.error("Error setting theme:", error); showMessage("Failed to set theme."); } });
            document.getElementById('admin-start-event-btn').addEventListener('click', async () => { const eventType = document.getElementById('admin-event-type').value; const durationMinutes = 5; try { await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { activeEvent: { type: eventType, expiry: Date.now() + (durationMinutes * 60 * 1000) } }, { merge: true }); showMessage(`${eventType} event started for ${durationMinutes} minutes!`); logToGame(`Admin started a ${eventType} event.`); } catch (error) { console.error("Error starting event:", error); showMessage("Failed to start event."); } });
            document.getElementById('admin-lock-market-btn').addEventListener('click', async () => { await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { marketplaceLocked: true }, { merge: true }); showMessage("Marketplace Locked."); });
            document.getElementById('admin-unlock-market-btn').addEventListener('click', async () => { await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { marketplaceLocked: false }, { merge: true }); showMessage("Marketplace Unlocked."); });
            setupAdminAction('admin-give-all-cash-btn', null, 'admin-give-all-cash', async (_, amount) => { if (isNaN(amount) || amount <= 0) { showMessage("Valid amount required."); return; } showConfirmation(`Give ${formatCash(amount)} to ALL players?`, "This will give cash to every player in the database.", async () => { const playersSnap = await getDocs(collection(db, `apps/${appId}/players`)); const batch = writeBatch(db); playersSnap.forEach(playerDoc => { batch.update(playerDoc.ref, { cash: increment(amount) }); }); await batch.commit(); logToGame(`Admin gave ${formatCash(amount)} to ALL players.`); showMessage("Gave cash to all players."); }); });

            document.getElementById('admin-load-inventory-btn').addEventListener('click', async () => { const targetId = document.getElementById('admin-fusion-id').value.trim(); if (!targetId) { showMessage("Player ID required."); return; } const fuseBtn = document.getElementById('admin-fuse-items-btn'); const item1Select = document.getElementById('admin-fuse-item1'); const item2Select = document.getElementById('admin-fuse-item2'); item1Select.innerHTML = item2Select.innerHTML = '<option>Loading...</option>'; item1Select.disabled = item2Select.disabled = fuseBtn.disabled = true; try { const playerSnap = await getDoc(doc(db, `apps/${appId}/players`, targetId)); if (!playerSnap.exists()) throw new Error("Player not found."); const inventory = playerSnap.data().inventory || {}; const options = Object.entries(inventory).map(([invId, item]) => { const itemData = allItems[item.itemId] || item; return `<option value="${invId}">${itemData.name}</option>` }).join(''); if (options) { item1Select.innerHTML = item2Select.innerHTML = options; item1Select.disabled = item2Select.disabled = fuseBtn.disabled = false; } else { item1Select.innerHTML = item2Select.innerHTML = '<option>Inventory Empty</option>'; } } catch (error) { console.error("Fusion load error:", error); showMessage(`Load failed: ${error.message}`); } });
            document.getElementById('admin-fuse-items-btn').addEventListener('click', async () => { const targetId = document.getElementById('admin-fusion-id').value.trim(); const item1Id = document.getElementById('admin-fuse-item1').value; const item2Id = document.getElementById('admin-fuse-item2').value; if (!targetId || !item1Id || !item2Id) { showMessage("Player and two items must be selected."); return; } if (item1Id === item2Id) { showMessage("Cannot fuse an item with itself."); return; } try { let newName = ''; await runTransaction(db, async (transaction) => { const playerRef = doc(db, `apps/${appId}/players`, targetId); const playerDoc = await transaction.get(playerRef); if (!playerDoc.exists()) throw new Error("Player not found."); const inventory = playerDoc.data().inventory; const item1 = inventory[item1Id], item2 = inventory[item2Id]; if (!item1 || !item2) throw new Error("Items not in inventory."); const data1 = allItems[item1.itemId] || item1; const data2 = allItems[item2.itemId] || item2; const name1Parts = data1.name.split(' '), name2Parts = data2.name.split(' '); newName = `${name1Parts[0]} ${name2Parts.slice(1).join(' ')}`; const svg1 = data1.svg.match(/<svg[^>]*>([\s\S]*)<\/svg>/)[1]; const svg2 = data2.svg.match(/<svg[^>]*>([\s\S]*)<\/svg>/)[1]; const newSvg = `<svg viewBox="0 0 100 100" class="item-svg"><g transform="scale(0.9) translate(5 5)">${svg1}</g><g opacity="0.75" transform="scale(0.7) translate(15 15) rotate(10)">${svg2}</g></svg>`; const newValue = Math.floor(((data1.baseValue || 0) + (data2.baseValue || 0)) * 1.5); delete inventory[item1Id]; delete inventory[item2Id]; inventory[`fused_${Date.now()}`] = { name: newName, svg: newSvg, baseValue: newValue, category: 'fused' }; transaction.update(playerRef, { inventory }); }); const message = `Admin fused items to create: ${newName}.`; logToGame(`An admin created a new fused item: ${newName} for player ${targetId}`); logToPlayerActivity(targetId, message); showMessage("Fusion successful!"); } catch (error) { console.error("Fusion Error:", error); showMessage(`Fusion failed: ${error.message}`); } });
            setupAdminAction('admin-grant-ach-btn', 'admin-grant-ach-id', null, async(id) => { const allAchievements = Object.keys(achievements).reduce((acc, key) => ({...acc, [key]: true}), {}); await updateDoc(doc(db, `apps/${appId}/players`, id), { achievements: allAchievements }); showMessage(`Granted all achievements to ${id}.`); logToPlayerActivity(id, "Admin granted all achievements."); });
            
            const setupTrollAction = (buttonId, idInputId, effect, valueInputId) => { document.getElementById(buttonId).addEventListener('click', async () => { const targetId = document.getElementById(idInputId)?.value.trim(); if (!targetId && idInputId) { showMessage("Player ID required."); return; } const valueEl = document.getElementById(valueInputId); const value = valueEl ? valueEl.value : null; try { await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { troll: { id: targetId, effect, value, timestamp: Date.now() } }, { merge: true }); logToPlayerActivity(targetId, `Admin used "${effect}".`); showMessage(`Troll action "${effect}" sent to player ${targetId}!`); } catch (e) { showMessage("Failed to send troll action."); } }); };
            setupTrollAction('admin-troll-smite-btn', 'admin-troll-smite-id', 'smite');
            setupTrollAction('admin-troll-shake-btn', 'admin-troll-shake-id', 'shake');
            setupTrollAction('admin-troll-invert-btn', 'admin-troll-invert-id', 'invert');
            setupTrollAction('admin-troll-rickroll-btn', 'admin-troll-rickroll-id', 'rickroll');
            setupTrollAction('admin-troll-jumpscare-btn', 'admin-troll-jumpscare-id', 'jumpscare');
            setupTrollAction('admin-troll-fakeban-btn', 'admin-troll-fakeban-id', 'fakeban');
            setupTrollAction('admin-troll-forcechat-btn', 'admin-troll-forcechat-id', 'forcechat', 'admin-troll-forcechat-msg');
            setupTrollAction('admin-troll-globalsound-btn', null, 'globalsound', 'admin-troll-globalsound-select');

            document.getElementById('admin-troll-curse-btn').addEventListener('click', async () => { const targetId = document.getElementById('admin-troll-curse-id').value.trim(); if(!targetId) { showMessage("Player ID required."); return; } const cursedItem = { name: "Cursed Potato", baseValue: 0, isCursed: true, svg: `<svg viewBox="0 0 100 100" class="item-svg"><path d="M30 60 Q 50 40 70 60 Q 90 80 50 90 Q 10 80 30 60" fill="#8B4513"/><circle cx="45" cy="70" r="3" fill="black"/><circle cx="55" cy="70" r="3" fill="black"/><path d="M40 80 Q 50 85 60 80" fill="none" stroke="black" stroke-width="2"/></svg>` }; try { await updateDoc(doc(db, `apps/${appId}/players`, targetId), { [`inventory.cursed_${Date.now()}`]: cursedItem }); const message = `Admin gave Cursed Potato.`; logToPlayerActivity(targetId, message); showMessage(`Player ${targetId} has been cursed with a potato!`); logToGame(`An admin cursed ${targetId} with a potato.`); } catch(e) { showMessage("Failed to curse player."); } });

            document.getElementById('admin-view-activity-btn').addEventListener('click', async () => { const targetId = document.getElementById('admin-activity-id').value.trim(); if (!targetId) { showMessage("Player ID required."); return; } const logContent = ui.activityLogContent; logContent.innerHTML = 'Loading logs...'; ui.activityLogModal.style.display = 'flex'; try { const activityRef = collection(db, `apps/${appId}/players/${targetId}/activityLog`); const q = query(activityRef, orderBy("timestamp", "desc"), limit(100)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { logContent.innerHTML = 'No activity found for this player.'; return; } let logHTML = ''; querySnapshot.forEach(doc => { const data = doc.data(); const timestamp = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A'; logHTML += `<div class="p-1 border-b border-gray-700"><span class="text-cyan-400">${timestamp}:</span> ${data.message}</div>`; }); logContent.innerHTML = logHTML; } catch (error) { console.error("Error fetching activity log:", error); logContent.innerHTML = 'Error loading logs.'; } });
            document.getElementById('admin-fetch-ips-btn').addEventListener('click', async () => { const outputDiv = document.getElementById('admin-ip-log-output'); outputDiv.innerHTML = 'Fetching...'; try { const ipLogsRef = collection(db, `apps/${appId}/ipLogs`); const q = query(ipLogsRef, orderBy("lastSeen", "desc")); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { outputDiv.innerHTML = 'No IP logs found.'; return; } let ipData = []; const ipMap = {}; querySnapshot.forEach(doc => { const data = doc.data(); ipData.push(data); if (!ipMap[data.ip]) ipMap[data.ip] = []; ipMap[data.ip].push(data.displayName); }); let tableHTML = '<table class="w-full text-left"><thead><tr><th class="p-1">Player</th><th class="p-1">IP</th><th class="p-1">Location</th><th class="p-1">Last Seen</th></tr></thead><tbody>'; for(const data of ipData) { const lastSeen = data.lastSeen ? new Date(data.lastSeen.seconds * 1000).toLocaleString() : 'N/A'; const isDuplicate = ipMap[data.ip].length > 1; const ipColor = isDuplicate ? 'text-red-400' : ''; let geoInfo = 'N/A'; try { const geoResponse = await fetch(`https://ipapi.co/${data.ip}/json/`); const geoData = await geoResponse.json(); if(geoData && !geoData.error) { geoInfo = `${geoData.city || ''}, ${geoData.region || ''} (${geoData.org || ''})`; } } catch (e) { /* ignore geo fetch errors */ } tableHTML += `<tr class="border-t border-gray-600"><td class="p-1 truncate">${data.displayName}</td><td class="p-1 ${ipColor}">${data.ip}</td><td class="p-1">${geoInfo}</td><td class="p-1">${lastSeen}</td></tr>`; } tableHTML += '</tbody></table>'; outputDiv.innerHTML = tableHTML; } catch (error) { console.error("Error fetching IP logs:", error); outputDiv.innerHTML = 'Error fetching logs.'; } });

            ui.adminClearChatBtn.addEventListener('click', () => { showConfirmation("Clear Global Chat?", "This will permanently delete all messages.", async () => { if (!isAdmin) { showMessage("Not authorized."); return; } const chatCollectionRef = collection(db, `apps/${appId}/globalChat`); const qSnapshot = await getDocs(chatCollectionRef); const batch = writeBatch(db); qSnapshot.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); logToGame("Global chat cleared by an admin."); showMessage("Global chat cleared."); }); });
            ui.adminResetBtn.addEventListener('click', () => { const targetId = document.getElementById('admin-reset-id').value.trim(); if (!targetId) { showMessage("Player ID required."); return; } showConfirmation(`RESET Player ${targetId}?`, "This will wipe their data. This cannot be undone.", async () => { if (!isAdmin) { showMessage("Not authorized."); return; } const initialData = { displayName: `Player-${targetId.substring(0, 5)}`, cash: 100, level: 1, hypePoints: 0, itemsSold: 0, inventory: {}, hasStarterPack: false, nameStyle: null, achievements: {}, createdAt: serverTimestamp(), lastLogin: serverTimestamp(), isMuted: false, isBanned: false, isFrozen: false }; await setDoc(doc(db, `apps/${appId}/players`, targetId), initialData); logToGame(`Player ${targetId} was reset by an admin.`); logToPlayerActivity(targetId, "PLAYER RESET BY ADMIN."); showMessage(`Player ${targetId} was reset.`); }); });
            ui.adminWipeInvBtn.addEventListener('click', () => { const targetId = document.getElementById('admin-wipe-inv-id').value.trim(); if (!targetId) { showMessage("Player ID required."); return; } showConfirmation(`Wipe ${targetId}'s Inventory?`, "This will delete all items. This cannot be undone.", async () => { await updateDoc(doc(db, `apps/${appId}/players`, targetId), {inventory: {}}); showMessage(`Inventory wiped for ${targetId}.`); logToPlayerActivity(targetId, "Admin wiped inventory."); }); });
            ui.adminClearEconomyBtn.addEventListener('click', () => { showConfirmation("RESET ENTIRE ECONOMY?", "This will reset ALL players' cash to $100 and wipe the marketplace. <b class='text-red-500'>THIS CANNOT BE UNDONE.</b>", async () => { if (!isAdmin) { showMessage("Not authorized."); return; } showMessage("Resetting economy... this may take a moment."); const batch = writeBatch(db); const playersSnap = await getDocs(collection(db, `apps/${appId}/players`)); playersSnap.forEach(playerDoc => { batch.update(playerDoc.ref, { cash: 100 }); }); const marketSnap = await getDocs(collection(db, `apps/${appId}/marketplace`)); marketSnap.forEach(listingDoc => { batch.delete(listingDoc.ref); }); await batch.commit(); logToGame("ADMIN RESET THE ENTIRE ECONOMY."); showMessage("Economy has been reset."); }); });
            
            const setupPunishmentAction = (buttonId, idInputId, field, value, logMessage) => { document.getElementById(buttonId).addEventListener('click', async () => { const targetId = document.getElementById(idInputId).value.trim(); if (!targetId) { showMessage("Player ID is required."); return; } try { await updateDoc(doc(db, `apps/${appId}/players`, targetId), { [field]: value }); const message = `Admin action: ${logMessage}.`; logToPlayerActivity(targetId, message); showMessage(`Player ${targetId} has been ${logMessage.toLowerCase()}.`); } catch (error) { console.error(`Error with ${logMessage}:`, error); showMessage(`Failed to ${logMessage.toLowerCase()} player.`); } }); };
            setupPunishmentAction('admin-mute-btn', 'admin-punish-id', 'isMuted', true, 'Muted');
            setupPunishmentAction('admin-unmute-btn', 'admin-punish-id', 'isMuted', false, 'Un-muted');
            setupPunishmentAction('admin-ban-btn', 'admin-punish-id', 'isBanned', true, 'Banned');
            setupPunishmentAction('admin-unban-btn', 'admin-punish-id', 'isBanned', false, 'Un-banned');
            setupPunishmentAction('admin-freeze-btn', 'admin-punish-id', 'isFrozen', true, 'Frozen');
            setupPunishmentAction('admin-unfreeze-btn', 'admin-punish-id', 'isFrozen', false, 'Un-frozen');

            document.getElementById('admin-player-search-btn').addEventListener('click', async () => { const searchTerm = document.getElementById('admin-player-search').value.trim(); const resultsDiv = document.getElementById('admin-player-search-results'); resultsDiv.innerHTML = 'Searching...'; if (!searchTerm) { resultsDiv.innerHTML = ''; return; } try { const playersRef = collection(db, `apps/${appId}/players`); const nameQuery = query(playersRef, where("displayName", ">=", searchTerm), where("displayName", "<=", searchTerm + '\uf8ff')); const nameSnapshot = await getDocs(nameQuery); let players = {}; nameSnapshot.forEach(doc => players[doc.id] = doc.data()); try { const idDoc = await getDoc(doc(playersRef, searchTerm)); if(idDoc.exists()) players[idDoc.id] = idDoc.data(); } catch (e) { /* ID might not exist, that's fine */ } if (Object.keys(players).length === 0) { resultsDiv.innerHTML = 'No players found.'; return; } resultsDiv.innerHTML = Object.entries(players).map(([id, p]) => `<div class="p-1 hover:bg-gray-600 cursor-pointer" data-player-id="${id}">${p.displayName} (${id.substring(0,5)}...)</div>`).join(''); } catch (error) { console.error("Player search error:", error); resultsDiv.innerHTML = 'Error searching players.'; } });
            document.getElementById('admin-player-search-results').addEventListener('click', async (e) => { if (e.target.dataset.playerId) { const playerId = e.target.dataset.playerId; ['admin-level-id', 'admin-cash-id', 'admin-take-cash-id', 'admin-hype-id', 'admin-item-id', 'admin-activity-id', 'admin-cosmetic-id', 'admin-fusion-id', 'admin-grant-ach-id', 'admin-troll-smite-id', 'admin-troll-shake-id', 'admin-troll-invert-id', 'admin-troll-rickroll-id', 'admin-troll-curse-id', 'admin-troll-jumpscare-id', 'admin-troll-fakeban-id', 'admin-troll-forcechat-id', 'admin-punish-id', 'admin-wipe-inv-id', 'admin-reset-id'].forEach(id => { document.getElementById(id).value = playerId; }); const infoDiv = document.getElementById('admin-selected-player-info'); infoDiv.classList.remove('hidden'); infoDiv.innerHTML = `Loading info for ${playerId}...`; const playerSnap = await getDoc(doc(db, `apps/${appId}/players`, playerId)); if (playerSnap.exists()) { const pData = playerSnap.data(); infoDiv.innerHTML = `<b>${pData.displayName}</b> | Cash: ${formatCash(pData.cash)} | Muted: ${pData.isMuted} | Banned: ${pData.isBanned}`; } else { infoDiv.innerHTML = 'Could not load player info.'; } } });
        }

        async function fetchServerStats() {
            if (!isAdmin) return;
            const statsDiv = document.getElementById('admin-server-stats');
            try {
                const playersSnap = await getDocs(collection(db, `apps/${appId}/players`));
                const marketSnap = await getDocs(collection(db, `apps/${appId}/marketplace`));
                
                const totalPlayers = playersSnap.size;
                let totalCash = 0;
                playersSnap.forEach(doc => { totalCash += doc.data().cash || 0; });

                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const onlineQuery = query(collection(db, `apps/${appId}/players`), where("lastLogin", ">", fiveMinutesAgo));
                const onlineSnap = await getDocs(onlineQuery);

                statsDiv.innerHTML = `<p><strong>Online Players:</strong> ${onlineSnap.size}</p><p><strong>Total Players:</strong> ${totalPlayers}</p><p><strong>Market Listings:</strong> ${marketSnap.size}</p><p><strong>Total Cash in Economy:</strong> ${formatCash(totalCash)}</p>`;
            } catch (error) {
                console.error("Error fetching server stats:", error);
                statsDiv.innerHTML = `<p class="text-red-500">Error loading stats.</p>`;
            }
        }

        async function main() {
            ui = {
                loadingScreen: document.getElementById('loading-screen'), gameContainer: document.getElementById('game-container'), playerId: document.getElementById('player-id'), playerDisplayName: document.getElementById('player-display-name'), playerLevel: document.getElementById('player-level'), playerCash: document.getElementById('player-cash'), playerHypePoints: document.getElementById('player-hype-points'), netWorth: document.getElementById('net-worth'), joinDate: document.getElementById('join-date'), playerInventory: document.getElementById('player-inventory'), marketplace: document.getElementById('marketplace'), gameLog: document.getElementById('game-log'), getStarterPackBtn: document.getElementById('get-starter-pack'), buyLootBoxBtn: document.getElementById('buy-loot-box'), sellModal: document.getElementById('sell-modal'), sellItemDisplay: document.getElementById('sell-item-display'), sellPriceInput: document.getElementById('sell-price'), cancelSellBtn: document.getElementById('cancel-sell'), confirmSellBtn: document.getElementById('confirm-sell'), sellToAIBtn: document.getElementById('sell-to-ai-btn'), aiSellPrice: document.getElementById('ai-sell-price'), messageModal: document.getElementById('message-modal'), messageText: document.getElementById('message-text'), closeMessageBtn: document.getElementById('close-message'), confirmationModal: document.getElementById('confirmation-modal'), eventBanner: document.getElementById('event-banner'), chatBox: document.getElementById('chat-box'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), 
                tabs: { marketplace: document.getElementById('tab-marketplace'), accessories: document.getElementById('tab-accessories'), pawnShop: document.getElementById('tab-pawn-shop'), exoticWares: document.getElementById('tab-exotic-wares'), hypeShop: document.getElementById('tab-hype-shop') }, 
                containers: { marketplace: document.getElementById('marketplace-container'), accessories: document.getElementById('accessories-container'), pawnShop: document.getElementById('pawn-shop-container'), exoticWares: document.getElementById('exotic-wares-container'), hypeShop: document.getElementById('hype-shop-container') },
                accessoriesShop: document.getElementById('accessories-shop'), hypeShop: document.getElementById('hype-shop'), exoticWares: document.getElementById('exotic-wares'), pawnShop: document.getElementById('pawn-shop'), refreshPawnStockBtn: document.getElementById('refresh-pawn-stock-btn'), adminLoginBtn: document.getElementById('admin-login-btn'), adminLoginModal: document.getElementById('admin-login-modal'), adminPanel: document.getElementById('admin-panel'), adminItemSelect: document.getElementById('admin-item-select'), adminClearChatBtn: document.getElementById('admin-clear-chat-btn'), adminResetBtn: document.getElementById('admin-reset-btn'), achievementsList: document.getElementById('achievements-list'), playerProfileModal: document.getElementById('player-profile-modal'), playerProfileContent: document.getElementById('player-profile-content'), smiteOverlay: document.getElementById('smite-overlay'), activityLogModal: document.getElementById('activity-log-modal'), activityLogContent: document.getElementById('activity-log-content'), rickrollModal: document.getElementById('rickroll-modal'),
                jumpscareOverlay: document.getElementById('jumpscare-overlay'), globalMessageBanner: document.getElementById('global-message-banner'), adminClearEconomyBtn: document.getElementById('admin-clear-economy-btn'), adminWipeInvBtn: document.getElementById('admin-wipe-inv-btn')
            };

            document.getElementById('close-activity-log-btn').addEventListener('click', () => ui.activityLogModal.style.display = 'none');
            document.getElementById('close-rickroll-btn').addEventListener('click', () => ui.rickrollModal.style.display = 'none');
            document.getElementById('admin-start-stream-btn').addEventListener('click', () => {
                showMessage("The live stream feature is currently under maintenance for a performance and reliability upgrade. Please check back later!");
            });

            const itemOptions = Object.keys(allItems).map(id => `<option value="${id}">${allItems[id].name}</option>`).join('');
            ui.adminItemSelect.innerHTML = itemOptions;
            
            updateShopUI('accessories-shop', ui.accessoriesShop, accessoryItems, 'buy-accessory-item-btn', 'Buy', 'baseValue');
            updateShopUI('pawn-shop', ui.pawnShop, clothingItems, 'buy-pawn-item-btn', 'Buy', 'baseValue');
            updateShopUI('exotic-wares', ui.exoticWares, exoticItems, 'buy-exotic-item-btn', 'Buy', 'cost');
            updateShopUI('hype-shop', ui.hypeShop, hypeShopItems, 'buy-hype-item-btn', 'Claim', 'points');
            
            setupEventListeners();
            setupAdminEventListeners();

            onSnapshot(query(collection(db, `apps/${appId}/globalLog`), orderBy("timestamp", "desc"), limit(50)), (snapshot) => { const logs = snapshot.docs.map(doc => doc.data()).reverse(); updateGameLogUI(logs); });
            onSnapshot(query(collection(db, `apps/${appId}/globalChat`), orderBy("timestamp", "asc"), limit(100)), (snapshot) => { const messages = snapshot.docs.map(doc => doc.data()); updateChatUI(messages); });
            
            // This listener now handles all global state changes.
            onSnapshot(doc(db, `apps/${appId}/globalState`, 'main'), (docSnap) => {
                if (!docSnap.exists()) return;
                const state = docSnap.data();
                const now = Date.now();

                document.body.className = 'text-white';
                document.body.classList.add(state.theme || 'theme-default');

                // We need to re-fetch marketplace data here to check the lock status
                onSnapshot(query(collection(db, `apps/${appId}/marketplace`), orderBy("price", "asc")), (snapshot) => { const listings = {}; snapshot.forEach(doc => listings[doc.id] = doc.data()); updateMarketplaceUI(listings, state.marketplaceLocked); });

                if (globalImageTimeout) clearTimeout(globalImageTimeout);
                if (state.globalImage && state.globalImage.url && state.globalImage.expiry > now) { 
                    if(ui.globalImageContainer) {
                        ui.globalImageContainer.querySelector('img').src = state.globalImage.url; 
                        ui.globalImageContainer.classList.replace('hidden', 'flex'); 
                        globalImageTimeout = setTimeout(() => ui.globalImageContainer.classList.replace('flex','hidden'), state.globalImage.expiry - now); 
                    }
                } else if(ui.globalImageContainer) { 
                    ui.globalImageContainer.classList.replace('flex','hidden'); 
                }
                
                if (globalMessageTimeout) clearTimeout(globalMessageTimeout);
                if (state.globalMessage && state.globalMessage.text && state.globalMessage.expiry > now) { 
                    if(ui.globalMessageBanner) {
                        ui.globalMessageBanner.textContent = state.globalMessage.text; 
                        ui.globalMessageBanner.classList.remove('hidden'); 
                        globalMessageTimeout = setTimeout(() => ui.globalMessageBanner.classList.add('hidden'), state.globalMessage.expiry - now); 
                    }
                } else if(ui.globalMessageBanner) { 
                    ui.globalMessageBanner.classList.add('hidden'); 
                }

                if (state.activeEvent && state.activeEvent.expiry > now) { 
                    if(ui.eventBanner) {
                        ui.eventBanner.textContent = `EVENT ACTIVE: ${state.activeEvent.type}!`;
                        ui.eventBanner.classList.remove('hidden'); 
                    }
                } else if(ui.eventBanner) { 
                    ui.eventBanner.classList.add('hidden'); 
                }

                if (state.troll && now - state.troll.timestamp < 5000) {
                    if (state.troll.id === 'all' || state.troll.id === currentUserId) {
                        const { effect, value } = state.troll;
                        if (effect === 'smite' && ui.smiteOverlay) { ui.smiteOverlay.classList.remove('hidden'); sound.smite(); setTimeout(() => ui.smiteOverlay.classList.add('hidden'), 300); }
                        if (effect === 'shake') { document.body.classList.add('screen-shake'); setTimeout(() => document.body.classList.remove('screen-shake'), 500); }
                        if (effect === 'invert') { document.body.classList.add('invert-colors'); setTimeout(() => document.body.classList.remove('invert-colors'), 2000); }
                        if (effect === 'rickroll' && ui.rickrollModal) { ui.rickrollModal.style.display = 'flex'; }
                        if (effect === 'jumpscare' && ui.jumpscareOverlay) { ui.jumpscareOverlay.classList.remove('hidden'); sound.jumpscare(); setTimeout(() => ui.jumpscareOverlay.classList.add('hidden'), 500); }
                        if (effect === 'fakeban') { showMessage("<b>Connection Error</b><br>Your account has been permanently banned for violating terms of service. Reason: Extreme Toxicity. This is not an appealable offense.", true); }
                        if (effect === 'forcechat' && value) { addDoc(collection(db, `apps/${appId}/globalChat`), { userId: currentUserId, displayName: currentPlayer.displayName, message: value, timestamp: serverTimestamp(), isAdmin: false, nameStyle: currentPlayer.nameStyle || null }); }
                    }
                    if (state.troll.effect === 'globalsound') { sound[state.troll.value]?.(); }
                }
            });
            
            try {
                onAuthStateChanged(auth, async (user) => {
                    if (user) { 
                        await initializePlayer(user); 
                        if (!currentPlayer || !currentPlayer.isBanned) {
                            // Defensive check to prevent the TypeError on load
                            if (ui.loadingScreen) ui.loadingScreen.style.display = 'none'; 
                            if (ui.gameContainer) ui.gameContainer.classList.remove('hidden');
                        }
                    } 
                    else { await signInAnonymously(auth); }
                });
            } catch (error) {
                console.error("Critical error during authentication:", error);
                const loadingText = document.getElementById("loading-text");
                if (loadingText) { loadingText.textContent = "Authentication failed. Please refresh."; loadingText.classList.add('text-red-500'); }
            }
            
            setInterval(() => {
                if (isAdmin) fetchServerStats();
            }, 30000);
        }

        window.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
