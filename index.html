<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypebeast Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            transition: background 0.5s ease;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: #2a2a2a;
            border: 1px solid #444;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 255, 255, 0.2);
        }
        .btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: -100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        .btn:hover:after {
            left: 100%;
        }
        .btn:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.8);
        }
        .item-svg {
            width: 100%;
            height: 120px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .tab-active {
            background-color: #06b6d4;
            color: white;
            border-bottom: 2px solid #06b6d4;
        }
        .tab-inactive {
            background-color: transparent;
            color: #a0aec0;
            border-bottom: 2px solid #444;
        }
        #admin-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: 450px;
        }
        .chat-message {
            padding: 4px 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            max-width: 90%;
        }
        /* Animated Name Styles */
        @keyframes rainbow-text {
            0% { color: #ff0000; } 15% { color: #ff7f00; } 30% { color: #ffff00; } 45% { color: #00ff00; } 60% { color: #0000ff; } 75% { color: #4b0082; } 90% { color: #9400d3; } 100% { color: #ff0000; }
        }
        .animate-rainbow { animation: rainbow-text 4s linear infinite; }

        @keyframes glow-text {
            0%, 100% { text-shadow: 0 0 5px var(--glow-color, #fff), 0 0 10px var(--glow-color, #fff); }
            50% { text-shadow: 0 0 10px var(--glow-color, #fff), 0 0 20px var(--glow-color, #fff); }
        }
        .animate-glow { animation: glow-text 2s ease-in-out infinite; }

        @keyframes pulse-text {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); }
        }
        .animate-pulse-text { display: inline-block; animation: pulse-text 1.5s ease-in-out infinite; }
        
        .gradient-text {
             background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }

        /* Trippy Background Effects */
        @keyframes matrix-scroll {
            0% { background-position: 0 0; }
            100% { background-position: 0 -1000px; }
        }
        .bg-matrix {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><text x="0" y="15" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">01</text><text x="10" y="35" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">10</text><text x="20" y="95" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">00</text><text x="30" y="55" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">11</text><text x="40" y="75" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">10</text><text x="50" y="25" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">01</text><text x="60" y="85" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">11</text><text x="70" y="45" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">01</text><text x="80" y="5" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">10</text><text x="90" y="65" font-family="monospace" font-size="12" fill="rgba(0,255,0,0.7)">00</text></svg>');
            animation: matrix-scroll 20s linear infinite;
        }
        @keyframes psychedelic-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .bg-psychedelic {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: psychedelic-bg 15s ease infinite;
        }

    </style>
</head>
<body class="text-white">

    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="font-orbitron text-4xl text-cyan-400 mb-4 animate-pulse">HYPEBEAST SIMULATOR</div>
        <div class="text-lg">Connecting to the server...</div>
    </div>
    
    <!-- Global Image Display -->
    <div id="global-image-container" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[200] flex items-center justify-center p-4">
        <img id="global-image-element" src="" alt="Global Broadcast" class="max-w-full max-h-full rounded-lg shadow-2xl border-4 border-cyan-400">
    </div>

    <div class="container mx-auto p-4 max-w-screen-xl hidden" id="game-container">
        <!-- Header -->
        <header class="mb-6 p-4 rounded-lg bg-gray-800 border border-cyan-400 shadow-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-4xl font-orbitron text-cyan-400">HYPEBEAST SIMULATOR</h1>
                    <p class="text-lg">Welcome, <span id="player-display-name" class="font-bold text-yellow-300"></span></p>
                </div>
                <div class="text-right">
                    <button id="admin-login-btn" class="text-xs bg-red-800 hover:bg-red-700 px-2 py-1 rounded-full mb-2">Admin</button>
                    <p class="text-sm">Player ID: <span id="player-id" class="font-mono text-gray-400"></span></p>
                    <p class="text-sm text-gray-400">(Share this ID for admin actions)</p>
                </div>
            </div>
        </header>
        
        <!-- Banners -->
        <div id="event-banner" class="hidden mb-4 p-3 rounded-lg bg-yellow-500 text-black font-bold text-center fade-in"></div>
        <div id="bet-banner" class="hidden mb-4 p-4 rounded-lg bg-purple-800 border border-purple-400 text-white font-bold text-center fade-in"></div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Player Stats -->
                <div class="card p-4 rounded-lg">
                    <h2 class="text-2xl font-orbitron border-b border-gray-600 pb-2 mb-4 text-cyan-300">My Empire</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center"><span>Level:</span><span id="player-level" class="text-2xl font-bold text-yellow-400">0</span></div>
                        <div class="flex justify-between items-center"><span>Cash:</span><span id="player-cash" class="text-2xl font-bold text-green-400">$0</span></div>
                        <div class="flex justify-between items-center"><span>Hype Points:</span><span id="player-hype-points" class="text-2xl font-bold text-orange-400">0</span></div>
                        <div class="flex justify-between items-center"><span>Inventory Value:</span><span id="inventory-value" class="text-lg font-bold text-purple-400">$0</span></div>
                        <div class="flex justify-between items-center"><span>Net Worth:</span><span id="net-worth" class="text-lg font-bold text-yellow-400">$0</span></div>
                        <div class="flex justify-between items-center"><span>Player Sales:</span><span id="items-sold" class="text-lg font-bold text-cyan-400">0</span></div>
                    </div>
                    <button id="get-starter-pack" class="btn w-full mt-4 bg-green-500 hover:bg-green-600">Get Starter Pack</button>
                    <button id="buy-loot-box" class="btn w-full mt-2 bg-purple-500 hover:bg-purple-600">Buy Loot Box ($500)</button>
                </div>

                <!-- My Inventory -->
                <div class="card p-4 rounded-lg">
                    <h2 class="text-2xl font-orbitron border-b border-gray-600 pb-2 mb-4 text-cyan-300">My Closet</h2>
                    <div id="player-inventory" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Center Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Tabs -->
                <div class="flex border-b border-gray-600">
                    <button id="tab-marketplace" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-active">Marketplace</button>
                    <button id="tab-pawn-shop" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-inactive">Pawn Shop</button>
                    <button id="tab-exotic-wares" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-inactive">Exotic Wares</button>
                    <button id="tab-hype-shop" class="tab-btn flex-1 py-2 px-4 font-orbitron tab-inactive">Hype Shop</button>
                </div>

                <!-- Main Content Panes -->
                <div id="main-content-area">
                    <div id="marketplace-container" class="card p-4 rounded-lg"><div id="marketplace" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2"></div></div>
                    <div id="pawn-shop-container" class="card p-4 rounded-lg hidden">
                         <div class="flex justify-between items-center mb-4">
                              <h3 class="text-xl font-orbitron text-yellow-400">Second-Hand Goods</h3>
                              <button id="refresh-pawn-stock-btn" class="btn bg-yellow-600 text-sm py-1 px-3">Refresh Stock</button>
                         </div>
                        <div id="pawn-shop" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[650px] overflow-y-auto pr-2"></div>
                    </div>
                    <div id="exotic-wares-container" class="card p-4 rounded-lg hidden">
                        <h3 class="text-xl font-orbitron text-green-400 mb-4">The Collector's Corner</h3>
                        <div id="exotic-wares" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2"></div>
                    </div>
                    <div id="hype-shop-container" class="card p-4 rounded-lg hidden">
                        <h3 class="text-xl font-orbitron text-orange-400 mb-4">Hype Rewards</h3>
                         <div id="hype-shop" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column (Chat & Log) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Game Log -->
                <div class="card p-4 rounded-lg">
                    <h2 class="text-2xl font-orbitron border-b border-gray-600 pb-2 mb-4 text-cyan-300">Activity Feed</h2>
                    <div id="game-log" class="text-sm space-y-2 h-64 overflow-y-auto pr-2 font-mono"></div>
                </div>
                <!-- Global Chat -->
                <div class="card p-4 rounded-lg flex flex-col h-[400px]">
                    <h2 class="text-2xl font-orbitron border-b border-gray-600 pb-2 mb-4 text-cyan-300">Global Chat</h2>
                    <div id="chat-box" class="flex-grow flex flex-col space-y-2 overflow-y-auto pr-2 mb-2"></div>
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-input" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white" placeholder="Say something...">
                        <button type="submit" class="btn bg-cyan-600 px-4">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="sell-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-40"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-lg mx-auto mt-20"><h3 class="text-2xl font-orbitron mb-4 text-cyan-300">Sell Item</h3><div id="sell-item-display" class="mb-4"></div><div class="bg-gray-700 p-3 rounded-lg mb-4"><p class="font-bold">Option 1: List on Player Market</p><p class="text-sm text-gray-400 mb-2">Set your price and wait for another player to buy. High risk, high reward!</p><input type="number" id="sell-price" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white" placeholder="e.g., 500"><button id="confirm-sell" class="btn w-full mt-2 bg-cyan-500 hover:bg-cyan-600">List on Market</button></div><div class="bg-gray-700 p-3 rounded-lg mb-4"><p class="font-bold">Option 2: Sell to AI Collector</p><p class="text-sm text-gray-400 mb-2">Sell instantly for a guaranteed price. Quick cash, but less profit.</p><button id="sell-to-ai-btn" class="btn w-full bg-green-600 hover:bg-green-700">Sell Now for <span id="ai-sell-price"></span></button></div><div class="flex justify-end"><button id="cancel-sell" class="btn bg-gray-500 hover:bg-gray-600 px-4 py-2">Cancel</button></div></div></div>
    <div id="message-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-40"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-lg mx-auto mt-20 text-center"><p id="message-text" class="text-lg mb-4"></p><button id="close-message" class="btn bg-cyan-500 hover:bg-cyan-600 px-6 py-2">OK</button></div></div>
    <div id="admin-login-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-50"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-sm mx-auto mt-20"><h3 class="text-2xl font-orbitron mb-4 text-red-500">Admin Login</h3><input type="text" id="admin-user" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white mb-2" placeholder="Username"><input type="password" id="admin-pass" class="w-full bg-gray-800 border border-gray-500 rounded p-2 text-white mb-4" placeholder="Password"><div class="flex justify-end gap-4"><button id="cancel-admin-login" class="btn bg-gray-500 hover:bg-gray-600">Cancel</button><button id="confirm-admin-login" class="btn bg-red-500 hover:bg-red-600">Login</button></div></div></div>
    <div id="confirmation-modal" class="fixed inset-0 modal-bg items-center justify-center hidden z-50"><div class="card p-6 rounded-lg w-11/12 md:w-1/3 max-w-sm mx-auto mt-20"><h3 id="confirmation-title" class="text-xl font-orbitron mb-4 text-yellow-400">Are you sure?</h3><p id="confirmation-text" class="mb-4">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="cancel-confirmation" class="btn bg-gray-500 hover:bg-gray-600">Cancel</button><button id="confirm-action" class="btn bg-red-500 hover:bg-red-600">Confirm</button></div></div></div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="card p-4 rounded-lg hidden overflow-y-auto max-h-[90vh]">
        <h2 class="text-2xl font-orbitron border-b border-red-500 pb-2 mb-4 text-red-400">Admin Controls</h2>
        <div class="space-y-3">
            <div><label class="font-bold">Change Username</label><div class="flex gap-2"><input type="text" id="admin-name-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><input type="text" id="admin-new-name" class="w-full bg-gray-800 p-1 rounded" placeholder="New Name"><button id="admin-change-name-btn" class="btn bg-yellow-600 text-sm px-2">Set</button></div></div>
            <div><label class="font-bold">Give Cash</label><div class="flex gap-2"><input type="text" id="admin-cash-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><input type="number" id="admin-cash-amount" class="w-32 bg-gray-800 p-1 rounded" placeholder="Amount"><button id="admin-give-cash-btn" class="btn bg-green-600 text-sm px-2">Give</button></div></div>
            <div><label class="font-bold">Give Item</label><div class="flex gap-2"><input type="text" id="admin-item-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID"><select id="admin-item-select" class="w-full bg-gray-800 p-1 rounded"></select><button id="admin-give-item-btn" class="btn bg-purple-600 text-sm px-2">Give</button></div></div>
            
            <!-- Cosmetic Controls -->
            <div class="border-t border-red-500 pt-3 mt-3 space-y-3">
                <h3 class="text-lg font-orbitron text-cyan-400">Cosmetics & Effects</h3>
                <div>
                    <label class="font-bold">Set Animated Name</label>
                    <input type="text" id="admin-cosmetic-id" class="w-full bg-gray-800 p-1 rounded mb-1" placeholder="Player ID">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="admin-name-animation" class="w-full bg-gray-800 p-1 rounded">
                            <option value="">None</option>
                            <option value="animate-rainbow">Rainbow</option>
                            <option value="animate-glow">Glow</option>
                            <option value="animate-pulse-text">Pulse</option>
                            <option value="gradient-text">Gradient</option>
                        </select>
                        <input type="text" id="admin-name-color" class="bg-gray-800 p-1 rounded" placeholder="Color/Gradient From">
                    </div>
                     <input type="text" id="admin-gradient-to" class="w-full bg-gray-800 p-1 rounded mt-1" placeholder="Gradient To (optional)">
                     <button id="admin-set-name-style-btn" class="btn bg-cyan-600 text-sm px-2 w-full mt-1">Set Name Style</button>
                </div>
                 <div>
                    <label class="font-bold">Broadcast Global Image</label>
                    <input type="text" id="admin-image-url" class="w-full bg-gray-800 p-1 rounded mb-1" placeholder="Image URL">
                    <div class="flex gap-2">
                        <input type="number" id="admin-image-duration" class="w-full bg-gray-800 p-1 rounded" placeholder="Duration (seconds)">
                        <button id="admin-broadcast-image-btn" class="btn bg-cyan-600 text-sm px-2">Show</button>
                    </div>
                </div>
                 <div>
                    <label class="font-bold">Global Background Effect</label>
                     <select id="admin-bg-effect" class="w-full bg-gray-800 p-1 rounded">
                        <option value="">None</option>
                        <option value="bg-matrix">Matrix</option>
                        <option value="bg-psychedelic">Psychedelic</option>
                    </select>
                    <button id="admin-set-bg-effect-btn" class="btn bg-purple-600 text-sm px-2 w-full mt-1">Set BG Effect</button>
                </div>
            </div>
            
            <!-- Item Fusion -->
            <div class="border-t border-red-500 pt-3 mt-3 space-y-3">
                <h3 class="text-lg font-orbitron text-purple-400">Fusion Chamber</h3>
                <div>
                    <label class="font-bold">Fuse Items for Player</label>
                    <div class="flex gap-2">
                        <input type="text" id="admin-fusion-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID">
                        <button id="admin-load-inventory-btn" class="btn bg-yellow-600 text-sm px-2">Load</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="admin-fuse-item1" class="w-full bg-gray-800 p-1 rounded" disabled><option>Load Player First</option></select>
                    <select id="admin-fuse-item2" class="w-full bg-gray-800 p-1 rounded" disabled><option>Load Player First</option></select>
                </div>
                <button id="admin-fuse-items-btn" class="btn w-full bg-purple-700 hover:bg-purple-800" disabled>Fuse Items</button>
            </div>


            <div class="border-t border-red-500 pt-3 mt-3 space-y-3">
                <h3 class="font-bold text-red-500">Danger Zone</h3>
                <button id="admin-clear-chat-btn" class="btn w-full bg-red-700 mb-2">Clear Global Chat</button>
                <div class="flex gap-2 mt-2"><input type="text" id="admin-reset-id" class="w-full bg-gray-800 p-1 rounded" placeholder="Player ID to Reset"><button id="admin-reset-btn" class="btn bg-red-800 text-sm px-2">RESET</button></div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, runTransaction, increment, getDocs, writeBatch, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdZ9FVhqazqUdAs72H5PmCzBVsEaqswPI",
            authDomain: "hypebeastgame.firebaseapp.com",
            projectId: "hypebeastgame",
            storageBucket: "hypebeastgame.appspot.com",
            messagingSenderId: "788150739009",
            appId: "1:788150739009:web:9c06e6ae1c5ec15c4c66c0",
            measurementId: "G-T1YL986BMB"
        };
        const appId = 'hypebeast-simulator-v2';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GAME STATE ---
        let currentPlayer = null;
        let currentUserId = null;
        let itemToSellId = null;
        let isAdmin = false;
        let confirmationCallback = null;
        let globalImageTimeout = null;


        // --- UI ELEMENTS ---
        const loadingScreen = document.getElementById('loading-screen');
        const gameContainer = document.getElementById('game-container');
        const playerIdEl = document.getElementById('player-id');
        const playerDisplayNameEl = document.getElementById('player-display-name');
        const playerLevelEl = document.getElementById('player-level');
        const playerCashEl = document.getElementById('player-cash');
        const playerHypePointsEl = document.getElementById('player-hype-points');
        const inventoryValueEl = document.getElementById('inventory-value');
        const netWorthEl = document.getElementById('net-worth');
        const itemsSoldEl = document.getElementById('items-sold');
        const playerInventoryEl = document.getElementById('player-inventory');
        const marketplaceEl = document.getElementById('marketplace');
        const gameLogEl = document.getElementById('game-log');
        const getStarterPackBtn = document.getElementById('get-starter-pack');
        const buyLootBoxBtn = document.getElementById('buy-loot-box');
        const sellModal = document.getElementById('sell-modal');
        const sellItemDisplay = document.getElementById('sell-item-display');
        const sellPriceInput = document.getElementById('sell-price');
        const cancelSellBtn = document.getElementById('cancel-sell');
        const confirmSellBtn = document.getElementById('confirm-sell');
        const sellToAIBtn = document.getElementById('sell-to-ai-btn');
        const aiSellPriceEl = document.getElementById('ai-sell-price');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message');
        const confirmationModal = document.getElementById('confirmation-modal');
        const eventBanner = document.getElementById('event-banner');
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        
        const tabs = { marketplace: document.getElementById('tab-marketplace'), pawnShop: document.getElementById('tab-pawn-shop'), exoticWares: document.getElementById('tab-exotic-wares'), hypeShop: document.getElementById('tab-hype-shop') };
        const containers = { marketplace: document.getElementById('marketplace-container'), pawnShop: document.getElementById('pawn-shop-container'), exoticWares: document.getElementById('exotic-wares-container'), hypeShop: document.getElementById('hype-shop-container') };
        const hypeShopEl = document.getElementById('hype-shop');
        const exoticWaresEl = document.getElementById('exotic-wares');
        const pawnShopEl = document.getElementById('pawn-shop');
        const refreshPawnStockBtn = document.getElementById('refresh-pawn-stock-btn');

        // Admin UI
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminPanel = document.getElementById('admin-panel');
        const adminItemSelect = document.getElementById('admin-item-select');
        const adminClearChatBtn = document.getElementById('admin-clear-chat-btn');
        const adminResetBtn = document.getElementById('admin-reset-btn');

        // --- CHAT FILTER ---
        const BANNED_WORDS = [/nigger/i]; 

        // --- ITEM DATABASES ---
        const clothingItems = {
            'tee01': { name: 'Plain White Tee', baseValue: 15, svg: `<svg viewBox="0 0 100 100" class="item-svg"><path d="M20 30 L80 30 L85 80 L15 80 Z" fill="#fff" stroke="#ccc" stroke-width="1"/><path d="M40 30 C40 15 60 15 60 30" fill="none" stroke="#ccc" stroke-width="1"/></svg>`, category: 'clothing' },
            'cap01': { name: 'Basic Dad Cap', baseValue: 20, svg: `<svg viewBox="0 0 100 50" class="item-svg"><path d="M10 25 C 10 10, 90 10, 90 25 L 10 25 Z" fill="#333"/><path d="M10 25 L 90 25 L 100 25 L 0 25 Z" fill="#333" stroke="#000" stroke-width="1"/></svg>`, category: 'clothing' },
            'hoodie01': { name: 'Graphic Hoodie', baseValue: 80, svg: `<svg viewBox="0 0 100 100" class="item-svg"><path d="M20 40 L80 40 L80 90 L20 90 Z" fill="#555"/><path d="M30 40 C30 20 70 20 70 40" fill="#444"/><text x="50" y="70" font-size="20" fill="#fff" text-anchor="middle">HYPE</text></svg>`, category: 'clothing' },
            'sneaker01': { name: 'Retro Runners', baseValue: 120, svg: `<svg viewBox="0 0 100 50" class="item-svg"><path d="M10 40 L40 40 L50 30 L80 30 L90 40 L95 45 L5 45 Z" fill="#eee" stroke="#000" stroke-width="1"/><path d="M55 30 L60 20 L70 20 L75 30" fill="none" stroke="red" stroke-width="2"/></svg>`, category: 'shoes' },
            'jacket01': { name: 'Techwear Bomber', baseValue: 400, svg: `<svg viewBox="0 0 100 90" class="item-svg"><path d="M10 20 L90 20 L80 80 L20 80 Z" fill="#111" stroke="#0f0" stroke-width="1"/><path d="M10 20 L0 5 L30 20" fill="#222"/><path d="M90 20 L100 5 L70 20" fill="#222"/></svg>`, category: 'clothing' },
            'sneaker02': { name: 'Cosmic Kicks', baseValue: 550, svg: `<svg viewBox="0 0 200 100" class="item-svg"><path d="M20 70 L50 70 L60 50 L100 50 L110 70 L180 70 L170 90 L30 90 Z" fill="none" stroke="#FFD700" stroke-width="3"/><path d="M60 50 L70 30 L90 30 L100 50" fill="none" stroke="#FFD700" stroke-width="3"/><path d="M50 70 Q 40 60 40 50 Q 50 40 60 50" fill="#00FFFF" opacity="0.5"/><path d="M110 70 Q 120 60 120 50 Q 110 40 100 50" fill="#FF00FF" opacity="0.5"/></svg>`, category: 'shoes' },
            'jacket02': { name: 'Holographic Puffer', baseValue: 2500, svg: `<svg viewBox="0 0 100 100" class="item-svg"><defs><linearGradient id="holo" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ff00ff"/><stop offset="100%" stop-color="#00ffff"/></linearGradient></defs><path d="M10 30 L90 30 L80 90 L20 90 Z" fill="url(#holo)"/><path d="M10 30 C10 10 90 10 90 30" fill="url(#holo)"/></svg>`, category: 'clothing' },
        };
        const exoticItems = {
            'crystal01': { name: 'Crimson Crystal', cost: 5000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><path d="M50 10 L20 40 L30 90 L70 90 L80 40 Z" fill="#DC143C" stroke="#FF6347" stroke-width="3"/><path d="M50 10 L50 90 M20 40 L80 40 M30 90 L50 40 L70 90" stroke="#FF0000" stroke-width="1.5" opacity="0.7"/></svg>`, category: 'exotic' },
            'orb01': { name: 'Floating Orb', cost: 10000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><defs><radialGradient id="orbGlow" cx="50%" cy="50%" r="50%"><stop offset="60%" stop-color="rgba(255,215,0,1)"/><stop offset="100%" stop-color="rgba(255,165,0,0)"/></radialGradient></defs><circle cx="50" cy="50" r="25" fill="gold"/><circle cx="50" cy="50" r="40" fill="url(#orbGlow)"/><path d="M30 75 Q 50 65, 70 75" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"/></svg>`, category: 'exotic' },
        };
        const hypeShopItems = {
            'jetpack01': { name: 'Personal Jetpack', points: 50000, svg: `<svg viewBox="0 0 100 100" class="item-svg"><g fill="#FF4500"><rect x="25" y="20" width="20" height="60" rx="10"/><rect x="55" y="20" width="20" height="60" rx="10"/></g><rect x="20" y="50" width="60" height="10" fill="#696969"/><path d="M35 80 L25 100 M65 80 L75 100" stroke="#FFD700" stroke-width="5"/></svg>`, category: 'hype' },
        };
        const allItems = {...clothingItems, ...exoticItems, ...hypeShopItems};

        // --- UTILITY FUNCTIONS ---
        const formatCash = (amount) => `$${Math.floor(amount).toLocaleString()}`;
        const showMessage = (msg) => {
            messageText.textContent = msg;
            messageModal.style.display = 'flex';
        };
        const showConfirmation = (title, text, callback) => {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-text').textContent = text;
            confirmationCallback = callback;
            confirmationModal.style.display = 'flex';
        };
        const logToGame = async (message) => {
            try {
                await addDoc(collection(db, `apps/${appId}/globalLog`), {
                    message: message,
                    timestamp: serverTimestamp()
                });
            } catch (error) { console.error("Error writing to global log:", error); }
        };

        const applyNameStyle = (element, nameStyle) => {
            element.className = '';
            element.style.cssText = '';
            
            if (!nameStyle) return;

            if (nameStyle.animation) {
                element.classList.add(nameStyle.animation);
            }
            if (nameStyle.animation === 'gradient-text' && nameStyle.color && nameStyle.gradientTo) {
                 element.style.backgroundImage = `linear-gradient(to right, ${nameStyle.color}, ${nameStyle.gradientTo})`;
            } else if (nameStyle.color) {
                if (nameStyle.animation === 'animate-glow') {
                    element.style.setProperty('--glow-color', nameStyle.color);
                }
                element.style.color = nameStyle.color;
            }
        };

        // --- RENDER FUNCTIONS ---
        const renderItem = (item, id, container, buttons) => {
            // Fused items have data directly on the object, standard items reference allItems
            const itemData = allItems[item.itemId] || item;
            if (!itemData || !itemData.name || !itemData.svg) {
                console.warn(`Item data not found for itemId: ${item.itemId || id}`);
                return '';
            }
            const value = item.price || itemData.baseValue || item.points;
            const valueDisplay = container === 'hype-shop' ? `${value.toLocaleString()} HP` : formatCash(value);
            const sellerInfo = item.sellerName ? `<p class="text-xs text-gray-400 truncate">Seller: ${item.sellerName}</p>` : '';
            const categoryInfo = itemData.category === 'fused' ? `<p class="text-xs text-purple-400 font-bold">FUSED</p>` : '';

            return `
                <div class="card p-3 rounded-lg flex flex-col justify-between fade-in" data-item-id="${id}" data-item-type="${item.itemId || 'fused'}">
                    <div>
                        ${itemData.svg}
                        <h4 class="font-bold text-md truncate mt-2">${itemData.name}</h4>
                        ${sellerInfo}
                        ${categoryInfo}
                    </div>
                    <div class="mt-2">
                        <p class="text-lg font-orbitron text-cyan-400">${valueDisplay}</p>
                        ${buttons}
                    </div>
                </div>`;
        };
        
        const updatePlayerUI = (playerData) => {
            if (!playerData) return;
            currentPlayer = playerData;

            playerDisplayNameEl.textContent = playerData.displayName;
            applyNameStyle(playerDisplayNameEl, playerData.nameStyle);
            if (!playerData.nameStyle) {
                 playerDisplayNameEl.className = 'font-bold text-yellow-300';
            }
            
            playerLevelEl.textContent = playerData.level || 0;
            playerCashEl.textContent = formatCash(playerData.cash || 0);
            playerHypePointsEl.textContent = (playerData.hypePoints || 0).toLocaleString();
            itemsSoldEl.textContent = (playerData.itemsSold || 0).toLocaleString();
            
            const inventoryVal = Object.values(playerData.inventory || {}).reduce((acc, item) => {
                 const itemData = allItems[item.itemId] || item;
                return acc + (itemData.baseValue || 0);
            }, 0);
            inventoryValueEl.textContent = formatCash(inventoryVal);
            netWorthEl.textContent = formatCash((playerData.cash || 0) + inventoryVal);

            getStarterPackBtn.disabled = playerData.hasStarterPack;
            buyLootBoxBtn.disabled = (playerData.cash || 0) < 500;

            playerInventoryEl.innerHTML = Object.entries(playerData.inventory || {})
                .map(([id, item]) => renderItem(item, id, 'inventory', `<button class="btn sell-btn w-full text-sm mt-1 bg-yellow-600 hover:bg-yellow-700">Sell</button>`))
                .join('');
        };
        
        const updateMarketplaceUI = (listings) => {
            marketplaceEl.innerHTML = Object.entries(listings)
                .map(([id, item]) => {
                    const buyButton = item.sellerId !== currentUserId
                        ? `<button class="btn buy-btn w-full text-sm mt-1 bg-green-500 hover:bg-green-600">Buy</button>`
                        : `<button class="btn delist-btn w-full text-sm mt-1 bg-red-700 hover:bg-red-800">Delist</button>`;
                    return renderItem(item, id, 'marketplace', buyButton);
                }).join('');
        };

        const updateShopUI = (shopId, element, items, buttonClass, buttonText, valueType) => {
            element.innerHTML = Object.entries(items)
                .map(([id, itemData]) => {
                    const value = itemData.cost || itemData.points || itemData.baseValue;
                    const item = { itemId: id, [valueType]: value };
                    const buttons = `<button class="btn ${buttonClass} w-full text-sm mt-1 bg-cyan-600 hover:bg-cyan-700">${buttonText}</button>`;
                    return renderItem(item, id, shopId, buttons);
                }).join('');
        };
        
        const updateGameLogUI = (logs) => {
            gameLogEl.innerHTML = logs.map(log => `<div class="fade-in">${log.message}</div>`).join('');
            gameLogEl.scrollTop = gameLogEl.scrollHeight;
        };

        const updateChatUI = (messages) => {
            chatBox.innerHTML = messages.map(msg => {
                const align = msg.userId === currentUserId ? 'self-end' : 'self-start';
                const bgColor = msg.userId === currentUserId ? 'bg-cyan-800' : 'bg-gray-700';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${msg.displayName}: `;
                if (msg.nameStyle) {
                    applyNameStyle(nameSpan, msg.nameStyle);
                } else {
                    nameSpan.className = msg.isAdmin ? 'text-red-400 font-bold' : 'text-yellow-300 font-bold';
                }

                const messageSpan = document.createElement('span');
                messageSpan.className = 'text-white';
                messageSpan.textContent = msg.message;

                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${align} ${bgColor} fade-in`;
                messageDiv.appendChild(nameSpan);
                messageDiv.appendChild(messageSpan);
                
                return messageDiv.outerHTML;
            }).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        // --- DATABASE INTERACTIONS & GAME LOGIC ---
        async function initializePlayer(user) {
            currentUserId = user.uid;
            playerIdEl.textContent = currentUserId;
            const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
            let playerSnap = await getDoc(playerRef);

            if (!playerSnap.exists()) {
                const initialData = {
                    displayName: `Player-${currentUserId.substring(0, 5)}`,
                    cash: 100, level: 1, hypePoints: 0, itemsSold: 0, inventory: {}, hasStarterPack: false, nameStyle: null,
                };
                await setDoc(playerRef, initialData);
                playerSnap = await getDoc(playerRef);
                logToGame(`A new player has arrived: ${initialData.displayName}`);
            }
            onSnapshot(playerRef, (doc) => updatePlayerUI(doc.data()));
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            getStarterPackBtn.addEventListener('click', async () => {
                if (currentPlayer.hasStarterPack) return;
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                        const playerDoc = await transaction.get(playerRef);
                        if (!playerDoc.exists() || playerDoc.data().hasStarterPack) throw "Already has starter pack.";
                        
                        const starterItems = {
                            [`item_${Date.now()}_1`]: { itemId: 'tee01' },
                            [`item_${Date.now()}_2`]: { itemId: 'cap01' },
                            [`item_${Date.now()}_3`]: { itemId: 'sneaker01' }
                        };
                        transaction.update(playerRef, {
                            hasStarterPack: true, cash: increment(200),
                            ...Object.keys(starterItems).reduce((acc, key) => ({...acc, [`inventory.${key}`]: starterItems[key]}), {})
                        });
                    });
                    logToGame(`${currentPlayer.displayName} got a starter pack!`);
                    showMessage("Starter pack received!");
                } catch (error) { console.error("Starter Pack Error: ", error); showMessage("Could not get starter pack."); }
            });

            buyLootBoxBtn.addEventListener('click', async () => {
                if (currentPlayer.cash < 500) return;
                try {
                    const lootTable = { ...clothingItems, ...Object.fromEntries(Object.entries(exoticItems).slice(0,2))};
                    const itemKeys = Object.keys(lootTable);
                    const randomItemId = itemKeys[Math.floor(Math.random() * itemKeys.length)];
                    const newItemId = `item_${Date.now()}`;
                    await updateDoc(doc(db, `apps/${appId}/players`, currentUserId), { cash: increment(-500), [`inventory.${newItemId}`]: { itemId: randomItemId } });
                    const itemName = allItems[randomItemId].name;
                    logToGame(`${currentPlayer.displayName} opened a loot box and found a ${itemName}!`);
                    showMessage(`You found a ${itemName}!`);
                } catch (error) { console.error("Loot Box Error: ", error); showMessage("Failed to open loot box."); }
            });

            playerInventoryEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('sell-btn')) {
                    const itemEl = e.target.closest('[data-item-id]');
                    itemToSellId = itemEl.dataset.itemId;
                    const itemType = itemEl.dataset.itemType;
                    const itemData = allItems[itemType] || currentPlayer.inventory[itemToSellId];
                    
                    sellItemDisplay.innerHTML = renderItem(itemData, itemToSellId, 'sell-modal', '');
                    const aiPrice = Math.floor(itemData.baseValue * 0.7);
                    aiSellPriceEl.textContent = formatCash(aiPrice);
                    sellToAIBtn.dataset.price = aiPrice;
                    sellPriceInput.value = itemData.baseValue;
                    sellModal.style.display = 'flex';
                }
            });

            cancelSellBtn.addEventListener('click', () => sellModal.style.display = 'none');
            closeMessageBtn.addEventListener('click', () => messageModal.style.display = 'none');

            confirmSellBtn.addEventListener('click', async () => {
                const price = parseInt(sellPriceInput.value);
                if (!itemToSellId || isNaN(price) || price <= 0) { showMessage("Invalid price."); return; }
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                        const playerDoc = await transaction.get(playerRef);
                        const inventory = playerDoc.data().inventory;
                        const itemToSell = inventory[itemToSellId];
                        if (!itemToSell) throw "Item not found in inventory.";

                        const newListingRef = doc(collection(db, `apps/${appId}/marketplace`));
                        const listingData = allItems[itemToSell.itemId] ? { ...itemToSell } : { ...itemToSell, name: itemToSell.name, svg: itemToSell.svg, baseValue: itemToSell.baseValue };
                        
                        transaction.set(newListingRef, {
                            ...listingData, price: price, sellerId: currentUserId, sellerName: currentPlayer.displayName
                        });
                        
                        delete inventory[itemToSellId];
                        transaction.update(playerRef, { inventory: inventory });
                    });

                    const itemName = (allItems[currentPlayer.inventory[itemToSellId]?.itemId] || currentPlayer.inventory[itemToSellId])?.name;
                    logToGame(`${currentPlayer.displayName} listed a ${itemName} for ${formatCash(price)}.`);
                    showMessage("Item listed on the marketplace!");
                    sellModal.style.display = 'none';
                } catch (error) { console.error("Listing Error: ", error); showMessage(`Failed to list item. ${error}`); }
            });
            
            sellToAIBtn.addEventListener('click', async () => {
                const price = parseInt(sellToAIBtn.dataset.price);
                 if (!itemToSellId || isNaN(price) || price <= 0) return;

                try {
                    const itemName = (allItems[currentPlayer.inventory[itemToSellId]?.itemId] || currentPlayer.inventory[itemToSellId])?.name;
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                        const playerDoc = await transaction.get(playerRef);
                        const inventory = playerDoc.data().inventory;
                        if (!inventory[itemToSellId]) throw "Item not in inventory";
                        
                        delete inventory[itemToSellId];
                        transaction.update(playerRef, { inventory: inventory, cash: increment(price) });
                    });
                    logToGame(`${currentPlayer.displayName} quick-sold a ${itemName} for ${formatCash(price)}.`);
                    showMessage("Item sold!");
                    sellModal.style.display = 'none';
                } catch(e) { console.error("AI Sell Error: ", e); showMessage("Failed to sell item."); }
            });

            marketplaceEl.addEventListener('click', async (e) => {
                const listingEl = e.target.closest('[data-item-id]');
                if (!listingEl) return;
                const listingId = listingEl.dataset.itemId;

                if (e.target.classList.contains('buy-btn')) {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const listingRef = doc(db, `apps/${appId}/marketplace`, listingId);
                            const listingDoc = await transaction.get(listingRef);
                            if (!listingDoc.exists()) throw "Listing no longer available.";

                            const listing = listingDoc.data();
                            const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                            const playerDoc = await transaction.get(playerRef);
                            if (playerDoc.data().cash < listing.price) throw "Not enough cash.";
                            
                            const sellerRef = doc(db, `apps/${appId}/players`, listing.sellerId);
                            const newItemId = `item_${Date.now()}`;
                            
                            const { price, sellerId, sellerName, ...itemData } = listing;

                            transaction.update(playerRef, { cash: increment(-listing.price), [`inventory.${newItemId}`]: itemData });
                            transaction.update(sellerRef, { cash: increment(listing.price), itemsSold: increment(1) });
                            transaction.delete(listingRef);
                        });
                        const itemName = listingEl.querySelector('h4').textContent;
                        logToGame(`${currentPlayer.displayName} bought a ${itemName}.`);
                        showMessage("Purchase successful!");
                    } catch (error) { console.error("Purchase Error:", error); showMessage(`Purchase failed: ${error}`); }
                } else if (e.target.classList.contains('delist-btn')) {
                     try {
                        await runTransaction(db, async (transaction) => {
                            const listingRef = doc(db, `apps/${appId}/marketplace`, listingId);
                            const listingDoc = await transaction.get(listingRef);
                            if (!listingDoc.exists()) throw "Listing not found.";
                            
                            const listing = listingDoc.data();
                            if(listing.sellerId !== currentUserId) throw "Not your listing.";

                            const playerRef = doc(db, `apps/${appId}/players`, currentUserId);
                            const newItemId = `item_${Date.now()}`;
                            const { price, sellerId, sellerName, ...itemData } = listing;
                            transaction.update(playerRef, { [`inventory.${newItemId}`]: itemData });
                            transaction.delete(listingRef);
                        });
                        showMessage("Item delisted and returned to inventory.");
                    } catch (error) { console.error("Delist Error:", error); showMessage(`Failed to delist: ${error}`); }
                }
            });

            Object.keys(tabs).forEach(tabKey => {
                tabs[tabKey].addEventListener('click', () => {
                    Object.values(tabs).forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
                    Object.values(containers).forEach(c => c.classList.add('hidden'));
                    tabs[tabKey].classList.replace('tab-inactive', 'tab-active');
                    containers[tabKey].classList.remove('hidden');
                });
            });

            const setupShopListener = (containerId, buttonClass, shopItems, valueType, costField) => {
                document.getElementById(containerId).addEventListener('click', async (e) => {
                    if (!e.target.classList.contains(buttonClass)) return;
                    const itemEl = e.target.closest('[data-item-id]');
                    const itemId = itemEl.dataset.itemType;
                    const itemData = shopItems[itemId];
                    const cost = itemData[costField];
                    if (currentPlayer[valueType] < cost) { showMessage(`Not enough ${valueType === 'cash' ? 'Cash' : 'Hype Points'}.`); return; }
                    try {
                        const newItemId = `item_${Date.now()}`;
                        await updateDoc(doc(db, `apps/${appId}/players`, currentUserId), { [valueType]: increment(-cost), [`inventory.${newItemId}`]: { itemId: itemId } });
                        showMessage(`You bought a ${itemData.name}!`);
                        logToGame(`${currentPlayer.displayName} bought a ${itemData.name} from a shop.`);
                    } catch (error) { console.error("Shop purchase error:", error); showMessage("Purchase failed."); }
                });
            };

            setupShopListener('pawn-shop-container', 'buy-pawn-item-btn', clothingItems, 'cash', 'baseValue');
            setupShopListener('exotic-wares-container', 'buy-exotic-item-btn', exoticItems, 'cash', 'cost');
            setupShopListener('hype-shop-container', 'buy-hype-item-btn', hypeShopItems, 'hypePoints', 'points');

            refreshPawnStockBtn.addEventListener('click', () => {
                updateShopUI('pawn-shop', pawnShopEl, clothingItems, 'buy-pawn-item-btn', 'Buy', 'baseValue');
                showMessage("Pawn shop stock refreshed.");
            });

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageText = chatInput.value.trim();
                if (messageText === '' || !currentUserId || !currentPlayer) return;
                for (const pattern of BANNED_WORDS) {
                    if (pattern.test(messageText)) { showMessage("Your message contains inappropriate language."); chatInput.value = ''; return; }
                }
                try {
                    await addDoc(collection(db, `apps/${appId}/globalChat`), {
                        userId: currentUserId, displayName: currentPlayer.displayName, message: messageText,
                        timestamp: serverTimestamp(), isAdmin: isAdmin, nameStyle: currentPlayer.nameStyle || null
                    });
                    chatInput.value = '';
                } catch (error) { console.error("Error sending chat message: ", error); showMessage(`Error sending message.`); }
            });
            
            document.getElementById('cancel-confirmation').addEventListener('click', () => { confirmationModal.style.display = 'none'; confirmationCallback = null; });
            document.getElementById('confirm-action').addEventListener('click', () => {
                if (confirmationCallback) confirmationCallback();
                confirmationModal.style.display = 'none'; confirmationCallback = null;
            });
        }

        function setupAdminEventListeners() {
            document.getElementById('confirm-admin-login').addEventListener('click', () => {
                const user = document.getElementById('admin-user').value;
                const pass = document.getElementById('admin-pass').value;
                if (user === 'DAVE' && pass === 'CATS') {
                    isAdmin = true; adminPanel.classList.remove('hidden'); adminLoginModal.style.display = 'none';
                    logToGame('Admin access granted.'); showMessage('Admin access granted.');
                } else { showMessage('Invalid admin credentials.'); }
            });
            adminLoginBtn.addEventListener('click', () => adminLoginModal.style.display = 'flex');
            document.getElementById('cancel-admin-login').addEventListener('click', () => adminLoginModal.style.display = 'none');

            const setupAdminAction = (buttonId, idInputId, valueInputId, action) => {
                document.getElementById(buttonId).addEventListener('click', async () => {
                    const targetId = document.getElementById(idInputId).value.trim();
                    const valueEl = document.getElementById(valueInputId);
                    const value = valueEl ? (valueEl.type === 'number' ? parseInt(valueEl.value) : valueEl.value) : null;
                    if (!targetId) { showMessage("Player ID is required."); return; }
                    await action(targetId, value);
                });
            };

            setupAdminAction('admin-change-name-btn', 'admin-name-id', 'admin-new-name', async (id, newName) => {
                if (!newName) { showMessage("New name is required."); return; }
                await updateDoc(doc(db, `apps/${appId}/players`, id), { displayName: newName });
                showMessage(`Player ${id}'s name changed.`);
            });
            setupAdminAction('admin-give-cash-btn', 'admin-cash-id', 'admin-cash-amount', async (id, amount) => {
                if (isNaN(amount)) { showMessage("Valid amount is required."); return; }
                await updateDoc(doc(db, `apps/${appId}/players`, id), { cash: increment(amount) });
                showMessage(`Gave ${formatCash(amount)} to player ${id}.`);
            });
            setupAdminAction('admin-give-item-btn', 'admin-item-id', 'admin-item-select', async (id, itemId) => {
                const newItemId = `item_${Date.now()}`;
                await updateDoc(doc(db, `apps/${appId}/players`, id), { [`inventory.${newItemId}`]: { itemId: itemId } });
                showMessage(`Gave ${allItems[itemId].name} to player ${id}.`);
            });

            document.getElementById('admin-set-name-style-btn').addEventListener('click', async () => {
                const targetId = document.getElementById('admin-cosmetic-id').value.trim();
                if (!targetId) { showMessage("Player ID is required."); return; }
                const animation = document.getElementById('admin-name-animation').value;
                const color = document.getElementById('admin-name-color').value.trim();
                const gradientTo = document.getElementById('admin-gradient-to').value.trim();
                const nameStyle = { animation: animation || null, color: color || null, gradientTo: gradientTo || null };
                try {
                    await updateDoc(doc(db, `apps/${appId}/players`, targetId), { nameStyle: nameStyle });
                    showMessage(`Style updated for player ${targetId}.`);
                } catch (error) { console.error("Error setting name style:", error); showMessage("Failed to set style."); }
            });

            document.getElementById('admin-broadcast-image-btn').addEventListener('click', async () => {
                const imageUrl = document.getElementById('admin-image-url').value.trim();
                const duration = parseInt(document.getElementById('admin-image-duration').value);
                if (!imageUrl || isNaN(duration) || duration <= 0) { showMessage("Valid URL and duration required."); return; }
                try {
                    const expiry = Date.now() + (duration * 1000);
                    await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { globalImage: { url: imageUrl, expiry: expiry } }, { merge: true });
                    showMessage(`Broadcasting image for ${duration}s.`);
                } catch (error) { console.error("Error broadcasting image:", error); showMessage("Broadcast failed."); }
            });
            
            document.getElementById('admin-set-bg-effect-btn').addEventListener('click', async () => {
                 const effect = document.getElementById('admin-bg-effect').value;
                 try {
                    await setDoc(doc(db, `apps/${appId}/globalState`, 'main'), { backgroundEffect: effect || null }, { merge: true });
                    showMessage(`Background effect set to: ${effect || 'None'}.`);
                 } catch (error) { console.error("Error setting BG effect:", error); showMessage("Failed to set effect."); }
            });

            document.getElementById('admin-load-inventory-btn').addEventListener('click', async () => {
                const targetId = document.getElementById('admin-fusion-id').value.trim();
                if (!targetId) { showMessage("Player ID required to load inventory."); return; }
                const fuseBtn = document.getElementById('admin-fuse-items-btn');
                const item1Select = document.getElementById('admin-fuse-item1');
                const item2Select = document.getElementById('admin-fuse-item2');
                item1Select.innerHTML = item2Select.innerHTML = '<option>Loading...</option>';
                item1Select.disabled = item2Select.disabled = fuseBtn.disabled = true;

                try {
                    const playerRef = doc(db, `apps/${appId}/players`, targetId);
                    const playerSnap = await getDoc(playerRef);
                    if (!playerSnap.exists()) throw new Error("Player not found.");
                    
                    const inventory = playerSnap.data().inventory || {};
                    const options = Object.entries(inventory).map(([invId, item]) => {
                        const itemData = allItems[item.itemId] || item;
                        return `<option value="${invId}">${itemData.name}</option>`
                    }).join('');

                    if (options) {
                        item1Select.innerHTML = item2Select.innerHTML = options;
                        item1Select.disabled = item2Select.disabled = fuseBtn.disabled = false;
                    } else {
                         item1Select.innerHTML = item2Select.innerHTML = '<option>Inventory Empty</option>';
                    }
                } catch (error) {
                    console.error("Error loading inventory for fusion:", error);
                    showMessage(`Failed to load inventory: ${error.message}`);
                    item1Select.innerHTML = item2Select.innerHTML = '<option>Load Failed</option>';
                }
            });

            document.getElementById('admin-fuse-items-btn').addEventListener('click', async () => {
                const targetId = document.getElementById('admin-fusion-id').value.trim();
                const item1Id = document.getElementById('admin-fuse-item1').value;
                const item2Id = document.getElementById('admin-fuse-item2').value;

                if (!targetId || !item1Id || !item2Id) { showMessage("Player and two items must be selected."); return; }
                if (item1Id === item2Id) { showMessage("Cannot fuse an item with itself."); return; }
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(db, `apps/${appId}/players`, targetId);
                        const playerDoc = await transaction.get(playerRef);
                        if (!playerDoc.exists()) throw new Error("Player not found for transaction.");
                        
                        const inventory = playerDoc.data().inventory;
                        const item1 = inventory[item1Id];
                        const item2 = inventory[item2Id];
                        if (!item1 || !item2) throw new Error("One or both items not found in inventory.");

                        const data1 = allItems[item1.itemId] || item1;
                        const data2 = allItems[item2.itemId] || item2;

                        // Create new fused item
                        const name1Parts = data1.name.split(' ');
                        const name2Parts = data2.name.split(' ');
                        const newName = `${name1Parts[0]} ${name2Parts.slice(1).join(' ')}`;
                        
                        const svg1 = data1.svg.match(/<svg[^>]*>([\s\S]*)<\/svg>/)[1];
                        const svg2 = data2.svg.match(/<svg[^>]*>([\s\S]*)<\/svg>/)[1];
                        const newSvg = `<svg viewBox="0 0 100 100" class="item-svg"><g transform="scale(0.9) translate(5 5)">${svg1}</g><g transform="scale(0.7) translate(15 15) rotate(10)">${svg2}</g></svg>`;

                        const newValue = Math.floor((data1.baseValue + data2.baseValue) * 1.5);

                        const fusedItem = {
                            name: newName,
                            svg: newSvg,
                            baseValue: newValue,
                            category: 'fused'
                        };

                        // Update inventory
                        delete inventory[item1Id];
                        delete inventory[item2Id];
                        inventory[`fused_${Date.now()}`] = fusedItem;
                        
                        transaction.update(playerRef, { inventory: inventory });
                    });
                    logToGame(`An admin created a new fused item: ${name.value} for player ${targetId}`);
                    showMessage("Fusion successful! A new item has been created.");
                } catch (error) {
                    console.error("Fusion Error:", error);
                    showMessage(`Fusion failed: ${error.message}`);
                }
            });

            adminClearChatBtn.addEventListener('click', () => {
                showConfirmation("Clear Global Chat?", "This will permanently delete all messages for everyone.", async () => {
                    if (!isAdmin) { showMessage("You are not authorized."); return; }
                    const chatCollectionRef = collection(db, `apps/${appId}/globalChat`);
                    const querySnapshot = await getDocs(chatCollectionRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    logToGame("Global chat has been cleared by an admin.");
                    showMessage("Global chat cleared.");
                });
            });

            adminResetBtn.addEventListener('click', () => {
                const targetId = document.getElementById('admin-reset-id').value.trim();
                if (!targetId) { showMessage("Player ID required."); return; }
                showConfirmation(`RESET Player ${targetId}?`, "This will wipe their data. This cannot be undone.", async () => {
                     if (!isAdmin) { showMessage("You are not authorized."); return; }
                     const initialData = {
                         displayName: `Player-${targetId.substring(0, 5)}`, cash: 100, level: 1, hypePoints: 0,
                         itemsSold: 0, inventory: {}, hasStarterPack: false, nameStyle: null
                     };
                     await setDoc(doc(db, `apps/${appId}/players`, targetId), initialData);
                     logToGame(`Player ${targetId} has been reset by an admin.`);
                     showMessage(`Player ${targetId} was reset.`);
                });
            });
        }

        // --- INITIALIZATION ---
        async function main() {
            const itemOptions = Object.keys(allItems).map(id => `<option value="${id}">${allItems[id].name}</option>`).join('');
            adminItemSelect.innerHTML = itemOptions;
            
            updateShopUI('pawn-shop', pawnShopEl, clothingItems, 'buy-pawn-item-btn', 'Buy', 'baseValue');
            updateShopUI('exotic-wares', exoticWaresEl, exoticItems, 'buy-exotic-item-btn', 'Buy', 'cost');
            updateShopUI('hype-shop', hypeShopEl, hypeShopItems, 'buy-hype-item-btn', 'Claim', 'points');
            
            setupEventListeners();
            setupAdminEventListeners();

            onSnapshot(query(collection(db, `apps/${appId}/marketplace`), orderBy("price", "asc")), (snapshot) => {
                const listings = {}; snapshot.forEach(doc => listings[doc.id] = doc.data()); updateMarketplaceUI(listings);
            });
            onSnapshot(query(collection(db, `apps/${appId}/globalLog`), orderBy("timestamp", "desc"), limit(50)), (snapshot) => {
                const logs = snapshot.docs.map(doc => doc.data()).reverse(); updateGameLogUI(logs);
            });
            onSnapshot(query(collection(db, `apps/${appId}/globalChat`), orderBy("timestamp", "asc"), limit(100)), (snapshot) => {
                const messages = snapshot.docs.map(doc => doc.data()); updateChatUI(messages);
            });
            
            onSnapshot(doc(db, `apps/${appId}/globalState`, 'main'), (docSnap) => {
                if (!docSnap.exists()) return;
                const state = docSnap.data();
                const now = Date.now();

                // Background Effect
                document.body.className = 'text-white'; // Reset
                if (state.backgroundEffect) {
                    document.body.classList.add(state.backgroundEffect);
                }

                // Global Image
                const imageContainer = document.getElementById('global-image-container');
                const imageEl = document.getElementById('global-image-element');
                if (globalImageTimeout) clearTimeout(globalImageTimeout);
                if (state.globalImage && state.globalImage.url && state.globalImage.expiry > now) {
                    imageEl.src = state.globalImage.url;
                    imageContainer.classList.replace('hidden', 'flex');
                    globalImageTimeout = setTimeout(() => imageContainer.classList.replace('flex','hidden'), state.globalImage.expiry - now);
                } else {
                    imageContainer.classList.replace('flex','hidden');
                }
            });
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await initializePlayer(user);
                    loadingScreen.style.display = 'none';
                    gameContainer.classList.remove('hidden');
                } else { await signInAnonymously(auth); }
            });
        }

        main();

    </script>
</body>
</html>
