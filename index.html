<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        video {
            transform: scaleX(-1); /* Mirror effect for webcam */
            object-fit: cover;
            height: 100%;
            width: 100%;
        }
        .video-container {
            min-height: 480px; /* Ensures video container has a good size */
        }
    </style>
</head>
<body id="main-body" class="bg-gradient-to-br from-gray-900 to-gray-800 text-white flex items-center justify-center min-h-screen transition-colors duration-500">

    <div class="absolute top-4 left-4 text-xs text-gray-500 font-semibold">Version 1t</div>

    <div id="theme-switcher" class="absolute top-4 right-4 flex items-center space-x-2">
        <div data-theme="indigo" class="theme-dot w-6 h-6 rounded-full bg-indigo-500 cursor-pointer ring-2 ring-offset-2 ring-offset-gray-800 ring-transparent hover:ring-white"></div>
        <div data-theme="sunset" class="theme-dot w-6 h-6 rounded-full bg-orange-500 cursor-pointer ring-2 ring-offset-2 ring-offset-gray-800 ring-transparent hover:ring-white"></div>
        <div data-theme="ocean" class="theme-dot w-6 h-6 rounded-full bg-cyan-500 cursor-pointer ring-2 ring-offset-2 ring-offset-gray-800 ring-transparent hover:ring-white"></div>
        <div data-theme="forest" class="theme-dot w-6 h-6 rounded-full bg-green-500 cursor-pointer ring-2 ring-offset-2 ring-offset-gray-800 ring-transparent hover:ring-white"></div>
    </div>

    <div class="container mx-auto p-4 max-w-6xl">
        <h1 id="main-title" class="text-4xl font-bold text-center mb-6 text-indigo-400 transition-colors duration-500">Random Video Chat</h1>

        <div id="status" class="text-center mb-4 p-3 rounded-lg bg-black bg-opacity-20 text-gray-300">Welcome! Click "Start" to find a chat partner.</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
            <div id="local-video-wrapper" class="video-container bg-gray-800 rounded-xl shadow-2xl overflow-hidden ring-2 ring-offset-4 ring-offset-gray-900 transition-all duration-500">
                <h2 class="text-lg font-semibold p-3 bg-black bg-opacity-30 absolute top-0 left-0 w-full z-10">You</h2>
                <video id="localVideo" autoplay playsinline muted></video>
            </div>
            <div id="remote-video-wrapper" class="video-container bg-gray-800 rounded-xl shadow-2xl overflow-hidden ring-2 ring-offset-4 ring-offset-gray-900 transition-all duration-500">
                <h2 class="text-lg font-semibold p-3 bg-black bg-opacity-30 absolute top-0 left-0 w-full z-10">Partner</h2>
                 <div id="remote-video-placeholder" class="flex items-center justify-center h-full">
                    <p class="text-gray-500">Waiting for partner...</p>
                </div>
                <video id="remoteVideo" autoplay playsinline class="hidden"></video>
            </div>
        </div>

        <div class="flex justify-center space-x-4">
            <button id="startButton" class="text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg transform hover:scale-105 bg-indigo-600 hover:bg-indigo-500">Start</button>
            <button id="hangupButton" class="text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-lg transform hover:scale-105 bg-red-600 hover:bg-red-500" disabled>Hang Up</button>
        </div>
         <div class="text-center mt-4 text-sm text-gray-500">
            Your ID: <span id="userId" class="font-mono"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBcKpDm14W4GZqQncV1LOtS3Hn5t1kK-hw",
          authDomain: "omegle-c7bdb.firebaseapp.com",
          projectId: "omegle-c7bdb",
          storageBucket: "omegle-c7bdb.appspot.com",
          messagingSenderId: "470349324814",
          appId: "1:470349324814:web:8271072b8d4cd0de01125f",
          measurementId: "G-P65WBJMXX3"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-omegle-clone';

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- UI Elements ---
        const ui = {
            startButton: document.getElementById('startButton'),
            hangupButton: document.getElementById('hangupButton'),
            localVideo: document.getElementById('localVideo'),
            remoteVideo: document.getElementById('remoteVideo'),
            statusDiv: document.getElementById('status'),
            userIdSpan: document.getElementById('userId'),
            remoteVideoPlaceholder: document.getElementById('remote-video-placeholder'),
            themeSwitcher: document.getElementById('theme-switcher'),
            mainTitle: document.getElementById('main-title'),
            localVideoWrapper: document.getElementById('local-video-wrapper'),
            remoteVideoWrapper: document.getElementById('remote-video-wrapper'),
        };

        // --- WebRTC Configuration ---
        const servers = { /* ... same as before ... */ };

        let pc = null;
        let localStream = null;
        let remoteStream = null;
        let currentRoomId = null;
        let userId = null;
        let isCallActive = false;
        
        let unsubscribeRoom = null;
        let unsubscribeCallerCandidates = null;
        let unsubscribeCalleeCandidates = null;

        // --- Authentication ---
        async function authSetup() {
            try {
                await signInAnonymously(auth);
            } catch(e) { console.error("Authentication failed", e); }
            onAuthStateChanged(auth, user => {
                if (user) { userId = user.uid; ui.userIdSpan.textContent = userId; } 
                else { userId = null; ui.userIdSpan.textContent = ''; }
            });
        }
        
        // --- Theming Engine ---
        const themes = {
            indigo: { title: 'text-indigo-400', button: 'bg-indigo-600 hover:bg-indigo-500', ring: 'ring-indigo-500' },
            sunset: { title: 'text-orange-400', button: 'bg-orange-600 hover:bg-orange-500', ring: 'ring-orange-500' },
            ocean: { title: 'text-cyan-400', button: 'bg-cyan-600 hover:bg-cyan-500', ring: 'ring-cyan-500' },
            forest: { title: 'text-green-400', button: 'bg-green-600 hover:bg-green-500', ring: 'ring-green-500' },
        };
        
        function applyTheme(themeName) {
            const theme = themes[themeName];
            const allThemes = Object.values(themes);
            
            ui.mainTitle.classList.remove(...allThemes.map(t => t.title));
            ui.startButton.classList.remove(...allThemes.map(t => t.button.split(' ')).flat());
            ui.localVideoWrapper.classList.remove(...allThemes.map(t => t.ring));
            ui.remoteVideoWrapper.classList.remove(...allThemes.map(t => t.ring));

            ui.mainTitle.classList.add(theme.title);
            ui.startButton.classList.add(...theme.button.split(' '));
            ui.localVideoWrapper.classList.add(theme.ring);
            ui.remoteVideoWrapper.classList.add(theme.ring);
        }
        
        ui.themeSwitcher.addEventListener('click', (e) => {
            if (e.target.classList.contains('theme-dot')) {
                applyTheme(e.target.dataset.theme);
            }
        });
        
        // --- Core Functions ---
        async function startMedia() {
            if (localStream) return true; // Already started
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                ui.localVideo.srcObject = localStream;
            } catch (error) {
                console.error("Error accessing media devices.", error);
                ui.statusDiv.textContent = "Could not access camera/microphone. Please allow permissions.";
                return false;
            }
            return true;
        }
        
        async function startCall() {
            if (!userId) {
                ui.statusDiv.textContent = "Authenticating..."; setTimeout(startCall, 500); return;
            }
            
            ui.startButton.disabled = true;
            const mediaSuccess = await startMedia();
            if (!mediaSuccess) {
                ui.startButton.disabled = false; return;
            }
            
            pc = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            ui.hangupButton.disabled = false;
            isCallActive = true;
            ui.statusDiv.textContent = "Searching for a partner...";

            const waitingPoolRef = collection(db, `artifacts/${appId}/public/data/waiting_pool`);
            const q = query(waitingPoolRef, where("status", "==", "waiting"));
            const waitingDocs = await getDocs(q);
            const otherWaitingDocs = waitingDocs.docs.filter(doc => doc.data().userId !== userId);

            if (otherWaitingDocs.length === 0) {
                const waitingDocRef = await addDoc(waitingPoolRef, { userId, status: "waiting", createdAt: new Date() });
                listenForPartner(waitingDocRef.id);
            } else {
                const waitingDoc = otherWaitingDocs[0];
                await createAndJoinRoom(waitingDoc.id, waitingDoc.data().userId);
            }
        }
        
        function listenForPartner(waitingDocId) {
             const waitingDocRef = doc(db, `artifacts/${appId}/public/data/waiting_pool`, waitingDocId);
            unsubscribeRoom = onSnapshot(waitingDocRef, async (docSnap) => {
                const data = docSnap.data();
                if (data && data.status === "connected" && data.roomId) {
                    currentRoomId = data.roomId;
                    if(unsubscribeRoom) unsubscribeRoom(); 
                    await joinRoom(data.roomId);
                    await deleteDoc(waitingDocRef);
                }
            });
        }
        
        async function createAndJoinRoom(waitingDocId, partnerId) {
            const roomRef = doc(collection(db, `artifacts/${appId}/public/data/rooms`));
            currentRoomId = roomRef.id;
            setupPeerConnectionListeners(roomRef, 'caller');
            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);
            await setDoc(roomRef, { offer: offerDescription, callerId: userId, calleeId: partnerId });
            await updateDoc(doc(db, `artifacts/${appId}/public/data/waiting_pool`, waitingDocId), { status: "connected", roomId: currentRoomId, partnerId: userId });
            unsubscribeRoom = onSnapshot(roomRef, (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
        }
        
        async function joinRoom(roomId) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
            const roomSnapshot = await getDoc(roomRef);
            if (roomSnapshot.exists()) {
                 setupPeerConnectionListeners(roomRef, 'callee');
                const roomData = roomSnapshot.data();
                await pc.setRemoteDescription(new RTCSessionDescription(roomData.offer));
                const answerDescription = await pc.createAnswer();
                await pc.setLocalDescription(answerDescription);
                await updateDoc(roomRef, { answer: answerDescription });
            } else {
                endCall();
            }
        }
        
        function setupPeerConnectionListeners(roomRef, role) {
            pc.oniceconnectionstatechange = () => {
                ui.statusDiv.textContent = `Status: ${pc.iceConnectionState}`;
                if (pc.iceConnectionState === 'failed') pc.restartIce();
            };
            pc.onconnectionstatechange = () => { if (pc.connectionState === 'disconnected') endCall(); };
            pc.ontrack = (event) => {
                if (ui.remoteVideo.srcObject !== event.streams[0]) {
                    remoteStream = event.streams[0];
                    ui.remoteVideo.srcObject = remoteStream;
                    ui.remoteVideo.classList.remove('hidden');
                    ui.remoteVideoPlaceholder.classList.add('hidden');
                    ui.statusDiv.textContent = "Connected!";
                    ui.remoteVideo.play().catch(e => console.error("Remote video play failed:", e));
                }
            };
            const [localCandidates, remoteCandidates] = role === 'caller' 
                ? [collection(roomRef, 'callerCandidates'), collection(roomRef, 'calleeCandidates')]
                : [collection(roomRef, 'calleeCandidates'), collection(roomRef, 'callerCandidates')];
                
            pc.onicecandidate = (event) => event.candidate && addDoc(localCandidates, event.candidate.toJSON());
            
            if(unsubscribeCallerCandidates) unsubscribeCallerCandidates();
            if(unsubscribeCalleeCandidates) unsubscribeCalleeCandidates();

            unsubscribeCalleeCandidates = onSnapshot(remoteCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
        }
        
        async function endCall() {
            if (!isCallActive) return;

            if (pc) { pc.close(); pc = null; }
            if (remoteStream) { remoteStream.getTracks().forEach(track => track.stop()); remoteStream = null; }
            
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribeCallerCandidates) unsubscribeCallerCandidates();
            if (unsubscribeCalleeCandidates) unsubscribeCalleeCandidates();
            unsubscribeRoom = unsubscribeCallerCandidates = unsubscribeCalleeCandidates = null;
            
            ui.remoteVideo.srcObject = null;
            ui.remoteVideo.classList.add('hidden');
            ui.remoteVideoPlaceholder.classList.remove('hidden');
            
            ui.statusDiv.textContent = "Call ended. Click 'Start' to find a new partner.";
            ui.startButton.disabled = false;
            ui.hangupButton.disabled = true;
            isCallActive = false;

            if (currentRoomId) {
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                const collections = ['callerCandidates', 'calleeCandidates'];
                for (const coll of collections) {
                    const snapshot = await getDocs(collection(roomRef, coll));
                    snapshot.forEach(async (d) => await deleteDoc(d.ref));
                }
                await deleteDoc(roomRef);
                currentRoomId = null;
            }
        }
        
        async function fullCleanup() {
            await endCall();
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
        }

        // --- Initializers ---
        authSetup();
        applyTheme('indigo'); // Set default theme
        ui.startButton.onclick = startCall;
        ui.hangupButton.onclick = endCall;
        window.onbeforeunload = fullCleanup;

    </script></body>
</html>
