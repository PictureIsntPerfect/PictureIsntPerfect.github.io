<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CypherLink</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for the Y2K/PS2/Graffiti Vibe */
        body {
            font-family: 'VT323', monospace;
            background-color: #1a1a2e;
            color: #e0e0e0;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 0, 255, 0.2), transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(0, 255, 255, 0.2), transparent 40%),
                url('https://www.transparenttextures.com/patterns/lined-paper.png');
            background-attachment: fixed;
            overflow-x: hidden;
        }

        .cyber-glitch-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 2.5rem;
            color: #f0f;
            text-shadow: 
                -2px -2px 0 #0ff, 
                2px 2px 0 #ff0;
            animation: glitch 1.5s infinite;
        }

        @keyframes glitch {
            0%, 100% { text-shadow: -2px -2px 0 #0ff, 2px 2px 0 #ff0; }
            25% { text-shadow: 2px 2px 0 #0ff, -2px -2px 0 #ff0; }
            50% { text-shadow: 2px -2px 0 #0ff, -2px 2px 0 #ff0; }
            75% { text-shadow: -2px 2px 0 #0ff, 2px -2px 0 #ff0; }
        }

        .video-container {
            border: 4px solid;
            border-image: linear-gradient(45deg, #f0f, #0ff) 1;
            box-shadow: 0 0 15px #f0f, 0 0 15px #0ff inset;
            background: repeating-linear-gradient(
                45deg,
                rgba(0,0,0,0.2),
                rgba(0,0,0,0.2) 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
            animation: border-flicker 2s infinite alternate;
        }
        
        @keyframes border-flicker {
            from { box-shadow: 0 0 15px #f0f, 0 0 15px #0ff inset; }
            to { box-shadow: 0 0 25px #0ff, 0 0 25px #f0f inset; }
        }

        .video-placeholder {
            background-image: url('https://placehold.co/600x400/1a1a2e/e0e0e0?text=Awaiting Signal...');
            background-size: cover;
            background-position: center;
        }

        video { transform: scaleX(-1); }

        .control-button {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(45deg, #4a00e0, #8e2de2);
            border: 2px solid #0ff;
            color: white;
            text-shadow: 1px 1px 2px black;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px #0ff;
        }

        .control-button:hover { transform: translateY(-2px); box-shadow: 0 6px #f0f; }
        .control-button:active { transform: translateY(2px); box-shadow: 0 2px #f0f; }
        .control-button:disabled { background: #555; color: #999; border-color: #777; box-shadow: 0 4px #777; cursor: not-allowed; }

        .chat-box { background: rgba(0, 0, 0, 0.5); border: 2px solid #ff0; backdrop-filter: blur(5px); height: 300px; }
        .chat-input { background: #222; border: 1px solid #ff0; color: #e0e0e0; }
        .chat-input::placeholder { color: #888; }

        .graffiti-art { position: absolute; width: 300px; height: 200px; background-size: contain; background-repeat: no-repeat; opacity: 0.6; pointer-events: none; }
        #graffiti1 { background-image: url('https://storage.googleapis.com/gemini-prod-us-west1-assets/generated_images/cypherlink_graffiti_1.png'); top: 10%; left: 5%; transform: rotate(-15deg); }
        #graffiti2 { background-image: url('https://storage.googleapis.com/gemini-prod-us-west1-assets/generated_images/cypherlink_graffiti_2.png'); bottom: 5%; right: 5%; transform: rotate(10deg); }
        
        .status-bar { background: rgba(0,0,0,0.7); border: 1px solid #f0f; padding: 5px 10px; text-shadow: 1px 1px 2px #f0f; }
        
        /* Modal Styles */
        .modal-backdrop { background-color: rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .modal-content { background-color: #1a1a2e; border: 2px solid #f0f; box-shadow: 0 0 20px #f0f; }
        .modal-input { background: #333; border: 1px solid #0ff; color: #e0e0e0; font-family: 'VT323', monospace; }

        /* Admin Panel Styles */
        #admin-icon { cursor: pointer; transition: transform 0.3s ease; }
        #admin-icon:hover { transform: scale(1.1) rotate(15deg); }
        #admin-panel { background: rgba(10, 0, 20, 0.9); border-top: 4px solid #ff0; backdrop-filter: blur(8px); }
        .admin-room-card { background: rgba(0,0,0,0.4); border: 1px solid #8e2de2; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Name Modal -->
    <div id="nameModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="modal-content p-8 rounded-lg text-center w-full max-w-sm">
            <h2 class="text-2xl text-cyan-300 mb-4 font-bold">ENTER YOUR ALIAS</h2>
            <form id="nameForm">
                <input type="text" id="nameInput" class="modal-input w-full p-3 text-lg text-center rounded-md" placeholder="Your Name..." required maxlength="15">
                <button type="submit" class="control-button w-full py-3 px-6 rounded-lg mt-4">ENTER CYPHER</button>
            </form>
        </div>
    </div>
    
    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="modal-content p-8 rounded-lg text-center w-full max-w-sm">
            <h2 class="text-2xl text-red-500 mb-4 font-bold">ADMIN ACCESS</h2>
            <form id="adminLoginForm">
                <input type="text" id="adminUserInput" class="modal-input w-full p-3 text-lg rounded-md mb-3" placeholder="Username...">
                <input type="password" id="adminPassInput" class="modal-input w-full p-3 text-lg rounded-md mb-4" placeholder="Password...">
                <button type="submit" class="control-button w-full py-3 px-6 rounded-lg">LOGIN</button>
                <p id="adminLoginError" class="text-red-500 mt-2 h-4"></p>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="fixed top-0 left-0 w-full h-full z-40 p-8 overflow-y-auto hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-4xl font-bold text-yellow-300" style="font-family: 'Press Start 2P', cursive;">ADMIN MONITOR</h2>
            <button id="closeAdminPanel" class="text-4xl text-red-500">&times;</button>
        </div>
        <div id="admin-rooms-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Admin room cards will be injected here -->
        </div>
    </div>

    <!-- Main App -->
    <div class="absolute top-4 right-4 z-30" id="admin-icon-container">
        <svg id="admin-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 256 256"><path fill="#ff0" d="M224.2,160a95.81,95.81,0,0,0-23.33-60.34,96,96,0,0,0-145.74,0A95.81,95.81,0,0,0,31.8,160H16a8,8,0,0,0,0,16H31.8a95.81,95.81,0,0,0,23.33,60.34,96,96,0,0,0,145.74,0A95.81,95.81,0,0,0,224.2,176H240a8,8,0,0,0,0-16ZM128,200a64,64,0,1,1,64-64A64.07,64.07,0,0,1,128,200Z"/><path fill="#1a1a2e" d="M168,128a8,8,0,0,1-8,8H96a8,8,0,0,1,0-16h64A8,8,0,0,1,168,128ZM144,96a12,12,0,1,1-12-12A12,12,0,0,1,144,96ZM100,84a12,12,0,1,0,12,12A12,12,0,0,0,100,84Z"/></svg>
    </div>

    <div class="graffiti-art" id="graffiti1"></div>
    <div class="graffiti-art" id="graffiti2"></div>

    <div class="max-w-7xl mx-auto text-center mb-8">
        <h1 class="cyber-glitch-text">CypherLink</h1>
        <p class="text-lg text-gray-400 mt-2">Connecting the underground. Enter the stream.</p>
    </div>

    <div id="status-bar" class="status-bar max-w-4xl mx-auto rounded-lg mb-4 text-center">
        <p id="status-text">STATUS: OFFLINE // Press START to connect</p>
        <p class="text-xs text-gray-500 mt-1">Your ID: <span id="user-id-display"></span></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-6xl mx-auto">
        <div class="video-container rounded-lg p-2 aspect-video"><video id="localVideo" class="w-full h-full rounded-md object-cover" autoplay muted playsinline></video></div>
        <div id="remote-video-container" class="video-container rounded-lg p-2 aspect-video video-placeholder"><video id="remoteVideo" class="w-full h-full rounded-md object-cover" autoplay playsinline></video></div>
    </div>

    <div class="flex justify-center items-center space-x-4 my-6">
        <button id="startButton" class="control-button py-3 px-6 rounded-lg" disabled>START</button>
        <button id="nextButton" class="control-button py-3 px-6 rounded-lg" disabled>NEXT</button>
        <button id="hangupButton" class="control-button py-3 px-6 rounded-lg" disabled>HANG UP</button>
    </div>

    <div class="max-w-4xl mx-auto">
        <div id="chat-messages" class="chat-box rounded-t-lg p-4 overflow-y-auto flex flex-col-reverse"></div>
        <form id="chat-form" class="flex">
            <input type="text" id="chat-input" class="chat-input flex-grow p-3 rounded-bl-lg focus:outline-none focus:ring-2 focus:ring-f0f" placeholder="Type message...">
            <button type="submit" id="send-button" class="control-button px-6 rounded-br-lg rounded-tl-none rounded-bl-none" disabled>SEND</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcKpDm14W4GZqQncV1LOtS3Hn5t1kK-hw",
            authDomain: "omegle-c7bdb.firebaseapp.com",
            projectId: "omegle-c7bdb",
            storageBucket: "omegle-c7bdb.firebasestorage.app",
            messagingSenderId: "470349324814",
            appId: "1:470349324814:web:8271072b8d4cd0de01125f",
            measurementId: "G-P65WBJMXX3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }], iceCandidatePoolSize: 10 };

        // Global state
        let pc = new RTCPeerConnection(servers);
        let localStream = null, remoteStream = null, currentRoomId = null, unsubscribeRoom = null, userName = 'guest';
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        
        // DOM Elements
        const el = (id) => document.getElementById(id);
        const startButton = el('startButton'), nextButton = el('nextButton'), hangupButton = el('hangupButton');
        const localVideo = el('localVideo'), remoteVideo = el('remoteVideo');
        const chatForm = el('chat-form'), chatInput = el('chat-input'), sendButton = el('send-button'), chatMessages = el('chat-messages');
        const statusText = el('status-text'), userIdDisplay = el('user-id-display');
        const nameModal = el('nameModal'), nameForm = el('nameForm'), nameInput = el('nameInput');
        const adminIcon = el('admin-icon'), adminLoginModal = el('adminLoginModal'), adminLoginForm = el('adminLoginForm');
        const adminPanel = el('admin-panel'), closeAdminPanel = el('closeAdminPanel'), adminRoomsContainer = el('admin-rooms-container');
        const adminUserInput = el('adminUserInput'), adminPassInput = el('adminPassInput'), adminLoginError = el('adminLoginError');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            nameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                userName = nameInput.value.trim();
                userId = `${userName}_${Math.random().toString(36).substr(2, 5)}`;
                userIdDisplay.textContent = userId;
                nameModal.classList.add('hidden');
                startButton.disabled = false;
            });

            adminIcon.addEventListener('click', () => adminLoginModal.classList.remove('hidden'));
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (adminUserInput.value === 'KHEMIST' && adminPassInput.value === 'omegle') {
                    adminLoginModal.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    initializeAdminPanel();
                } else {
                    adminLoginError.textContent = 'Invalid credentials.';
                    setTimeout(() => adminLoginError.textContent = '', 2000);
                }
            });
            closeAdminPanel.addEventListener('click', () => adminPanel.classList.add('hidden'));
        });

        // --- Core Logic ---
        const start = async () => {
            updateStatus("INITIALIZING...");
            startButton.disabled = true;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                pc.ontrack = event => {
                    if (!remoteStream) {
                        remoteStream = new MediaStream();
                        remoteVideo.srcObject = remoteStream;
                        el('remote-video-container').classList.remove('video-placeholder');
                    }
                    remoteStream.addTrack(event.track);
                };
                await findOrCreateRoom();
            } catch (error) {
                console.error("Error starting up:", error);
                updateStatus("ERROR: Could not access camera/mic.");
                resetState();
            }
        };

        const findOrCreateRoom = async () => {
            updateStatus("SEARCHING for a partner...");
            const roomsRef = collection(db, 'rooms');
            const q = query(roomsRef, where('answered', '==', false), limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                await createRoom();
            } else {
                const roomDoc = snapshot.docs[0];
                await joinRoom(roomDoc.id, roomDoc.data());
            }
        };
        
        const createRoom = async () => {
            updateStatus("CREATING new room. Waiting...");
            const roomRef = await addDoc(collection(db, 'rooms'), { 
                offered: false, answered: false, createdAt: new Date(), messages: [], participants: [userId]
            });
            currentRoomId = roomRef.id;
            const offerCandidates = collection(roomRef, 'offerCandidates');
            pc.onicecandidate = e => e.candidate && addDoc(offerCandidates, e.candidate.toJSON());
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await updateDoc(roomRef, { offer: { sdp: offer.sdp, type: offer.type }, offered: true });
            listenForAnswer(roomRef, collection(roomRef, 'answerCandidates'));
        };

        const joinRoom = async (roomId, roomData) => {
            updateStatus("Found room! CONNECTING...");
            currentRoomId = roomId;
            const roomRef = doc(db, 'rooms', roomId);
            await updateDoc(roomRef, { participants: [...(roomData.participants || []), userId] });
            pc.onicecandidate = e => e.candidate && addDoc(collection(roomRef, 'answerCandidates'), e.candidate.toJSON());
            await pc.setRemoteDescription(new RTCSessionDescription(roomData.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await updateDoc(roomRef, { answer: { sdp: answer.sdp, type: answer.type }, answered: true });
            updateStatus("CONNECTION ESTABLISHED!");
            enableChatAndNext();
            onSnapshot(collection(roomRef, 'offerCandidates'), s => s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            listenForMessages(roomRef);
        };
        
        const listenForAnswer = (roomRef, answerCandidates) => {
             unsubscribeRoom = onSnapshot(roomRef, async (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    updateStatus("CONNECTION ESTABLISHED!");
                    enableChatAndNext();
                }
            });
            onSnapshot(answerCandidates, s => s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            listenForMessages(roomRef);
        };
        
        const listenForMessages = (roomRef) => {
            onSnapshot(roomRef, (snapshot) => {
                if (!snapshot.exists()) {
                    updateStatus("Partner disconnected. Searching...");
                    resetForNext();
                } else {
                    const data = snapshot.data();
                    if (data && data.messages) displayMessages(data.messages);
                }
            });
        };
        
        const displayMessages = (messages) => {
            chatMessages.innerHTML = messages.slice().reverse().map(msg => {
                const senderName = msg.sender.split('_')[0];
                const senderClass = msg.sender === userId ? 'text-right' : 'text-left';
                const bubbleClass = msg.sender === userId ? 'bg-fuchsia-600 ml-auto' : 'bg-cyan-600 mr-auto';
                return `<div class="p-2 my-1 rounded-lg max-w-xs ${senderClass}">
                            <p class="text-xs text-gray-400 mb-1">${senderName}</p>
                            <p class="${bubbleClass} p-2 rounded-xl inline-block">${msg.text}</p>
                        </div>`;
            }).join('');
        };

        const sendMessage = async (e) => {
            e.preventDefault();
            const text = chatInput.value;
            if (text.trim() === '' || !currentRoomId) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            const roomDoc = await getDoc(roomRef);
            if(roomDoc.exists()){
                const newMessages = [...(roomDoc.data().messages || []), { text, sender: userId, timestamp: new Date() }];
                await updateDoc(roomRef, { messages: newMessages });
            }
            chatInput.value = '';
        };

        const hangup = async () => {
            updateStatus("Disconnecting...");
            if (unsubscribeRoom) unsubscribeRoom();
            if (currentRoomId) {
                try { await deleteDoc(doc(db, 'rooms', currentRoomId)); } catch(e) { console.error("Error deleting room", e); }
            }
            resetState();
            updateStatus("OFFLINE // Press START to connect");
        };
        
        const next = async () => {
            updateStatus("Finding next partner...");
            await hangup();
            setTimeout(start, 500);
        }

        // --- Helper & UI Functions ---
        const resetState = () => {
            if (pc) pc.close();
            pc = new RTCPeerConnection(servers);
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            if(remoteStream) remoteStream.getTracks().forEach(t => t.stop());
            localStream = null; remoteStream = null;
            localVideo.srcObject = null; remoteVideo.srcObject = null;
            el('remote-video-container').classList.add('video-placeholder');
            startButton.disabled = userName === 'guest'; nextButton.disabled = true; hangupButton.disabled = true;
            sendButton.disabled = true; chatInput.disabled = true;
            chatMessages.innerHTML = ''; currentRoomId = null;
        };
        
        const resetForNext = () => {
            if (unsubscribeRoom) unsubscribeRoom();
            if (pc) pc.close();
            pc = new RTCPeerConnection(servers);
            remoteVideo.srcObject = null;
            el('remote-video-container').classList.add('video-placeholder');
            nextButton.disabled = true; hangupButton.disabled = true; sendButton.disabled = true; chatInput.disabled = true;
            chatMessages.innerHTML = ''; currentRoomId = null;
            findOrCreateRoom();
        };
        
        const enableChatAndNext = () => {
            nextButton.disabled = false; hangupButton.disabled = false; sendButton.disabled = false; chatInput.disabled = false;
        };
        
        const updateStatus = (text) => { statusText.textContent = `STATUS: ${text}`; };

        // --- Admin Panel Logic ---
        const initializeAdminPanel = () => {
            const roomsRef = collection(db, 'rooms');
            onSnapshot(roomsRef, (snapshot) => {
                adminRoomsContainer.innerHTML = ''; // Clear existing rooms
                snapshot.forEach(doc => {
                    const room = doc.data();
                    const roomId = doc.id;
                    const card = document.createElement('div');
                    card.className = 'admin-room-card rounded-lg p-4';
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-cyan-300 truncate">Room: ${roomId}</h3>
                        <p class="text-sm text-gray-400">Participants: ${room.participants.join(', ')}</p>
                        <div class="grid grid-cols-2 gap-2 my-2">
                            <div class="bg-black rounded h-24 flex items-center justify-center text-gray-500">Vid 1</div>
                            <div class="bg-black rounded h-24 flex items-center justify-center text-gray-500">Vid 2</div>
                        </div>
                        <div class="text-xs h-32 overflow-y-auto bg-black/50 p-1 rounded border border-gray-600">
                            ${(room.messages || []).map(m => `<p><span class="text-yellow-400">${m.sender.split('_')[0]}:</span> ${m.text}</p>`).join('')}
                        </div>
                        <div class="flex space-x-2 mt-2">
                            <button class="text-xs bg-red-600 hover:bg-red-500 p-1 rounded w-full">End Chat</button>
                            <button class="text-xs bg-yellow-600 hover:bg-yellow-500 p-1 rounded w-full">Warn User</button>
                        </div>
                    `;
                    adminRoomsContainer.appendChild(card);
                });
            });
        };

        // Event Listeners
        startButton.onclick = start;
        hangupButton.onclick = hangup;
        nextButton.onclick = next;
        chatForm.onsubmit = sendMessage;
        
        // Initial state
        resetState();

    </script>
</body>
</html>
