<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat Support</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the chat application */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Style for the typing indicator */
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #94a3b8;
            color: #94a3b8;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }

        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }

        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #94a3b8;
            color: #94a3b8;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }

        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #94a3b8;
            color: #94a3b8;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }

        @keyframes dotFlashing {
            0% {
                background-color: #94a3b8;
            }
            50%,
            100% {
                background-color: #cbd5e1;
            }
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col h-screen antialiased text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
        <div class="flex items-center space-x-3">
            <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            <h1 class="text-xl font-bold text-slate-700">Live Chat Support</h1>
            <span id="user-role-display" class="text-sm font-medium bg-slate-200 text-slate-600 px-2 py-1 rounded-full"></span>
        </div>
        <button id="admin-login-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-200">
            Admin Login
        </button>
        <div id="admin-info" class="hidden items-center space-x-3">
            <span class="font-semibold">Admin Mode</span>
            <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition duration-200">
                Logout
            </button>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col p-4 md:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-xl flex flex-col flex-1 max-w-4xl w-full mx-auto">
            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 p-6 overflow-y-auto">
                <!-- FIX: Added a prominent warning for the user to fix their security rules -->
                <div id="rules-warning" class="m-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg">
                    <p class="font-bold">Configuration Needed</p>
                    <p>If the chat is not loading or you see "Missing or insufficient permissions" errors in the console, you MUST update your Firestore Security Rules. Please see the detailed comments in the JavaScript section of this file (around line 250) for step-by-step instructions.</p>
                </div>
            </div>
            <!-- Message Input -->
            <div class="bg-slate-50 border-t border-slate-200 p-4">
                <form id="message-form" class="flex items-center space-x-4">
                    <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-1 w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200" required>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-200 flex items-center">
                        Send
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </main>
    
    <!-- Admin Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Admin Login</h2>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-200">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyC553UPBeuwAUdINVJ5AqZMUIZ1DwwY73E",
          authDomain: "liveadmintalk.firebaseapp.com",
          projectId: "liveadmintalk",
          storageBucket: "liveadmintalk.firebasestorage.app",
          messagingSenderId: "278045849471",
          appId: "1:278045849471:web:efb2ed547b6fd57f7b4c4a",
          measurementId: "G-C13C2QVX3C"
        };

        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, setDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- DOM Elements ---
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginModal = document.getElementById('login-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const userRoleDisplay = document.getElementById('user-role-display');
        const adminInfo = document.getElementById('admin-info');
        const logoutBtn = document.getElementById('logout-btn');

        // --- App State ---
        let isAdmin = false;
        let authUser = null;
        let unsubscribe = null; // To store the snapshot listener
        const CHAT_ID = "main-chat-room"; // A single chat room for this implementation

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authUser = user;
                checkAdminPersistence();
                listenToMessages();
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });

        function checkAdminPersistence() {
            if(sessionStorage.getItem('isAdmin') === 'true' && authUser) {
                setAdminView();
            } else {
                setUserView();
            }
        }
        
        // --- View Management ---
        function setAdminView() {
            isAdmin = true;
            adminLoginBtn.classList.add('hidden');
            adminInfo.classList.remove('hidden');
            adminInfo.classList.add('flex');
            userRoleDisplay.textContent = "Admin";
            userRoleDisplay.classList.remove('bg-slate-200', 'text-slate-600');
            userRoleDisplay.classList.add('bg-indigo-100', 'text-indigo-700');
            sessionStorage.setItem('isAdmin', 'true');
        }

        function setUserView() {
            isAdmin = false;
            adminLoginBtn.classList.remove('hidden');
            adminInfo.classList.add('hidden');
            userRoleDisplay.textContent = "Spike (You)";
            userRoleDisplay.classList.remove('bg-indigo-100', 'text-indigo-700');
            userRoleDisplay.classList.add('bg-slate-200', 'text-slate-600');
            sessionStorage.removeItem('isAdmin');
        }

        // --- Modal Logic ---
        adminLoginBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => loginModal.classList.add('hidden'));
        window.addEventListener('click', (event) => {
            if (event.target === loginModal) {
                loginModal.classList.add('hidden');
            }
        });

        // --- Admin Login ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'KHEMIST' && password === 'ThisIsMySite1212') {
                setAdminView();
                loginModal.classList.add('hidden');
                loginForm.reset();
                loginError.classList.add('hidden');
            } else {
                loginError.textContent = 'Invalid username or password.';
                loginError.classList.remove('hidden');
            }
        });

        // --- Logout ---
        logoutBtn.addEventListener('click', () => {
            setUserView();
        });

        // --- Firestore Chat Logic ---
        // 
        // VITAL STEP FOR THIS APP TO WORK:
        // The errors "Missing or insufficient permissions" mean your Firestore Security Rules
        // are blocking the app. You MUST update them in your Firebase project.
        //
        // HOW TO FIX:
        // 1. Go to your Firebase Console: https://console.firebase.google.com/
        // 2. Select your project ("liveadmintalk").
        // 3. In the left menu, go to Build > Firestore Database.
        // 4. At the top of the Firestore page, click the "Rules" tab.
        // 5. Delete everything in the rules editor and paste the following code:
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // This rule allows any authenticated user (including anonymous ones)
            // to read and write messages. This is simple and works for this app.
            match /chats/{chatId}/messages/{messageId} {
              allow read, write: if request.auth != null;
            }
          }
        }
        */
        // 6. Click "Publish". The app should start working immediately.
        //
        const messagesColRef = collection(db, "chats", CHAT_ID, "messages");

        // Send message
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!authUser) {
                console.error("You are not signed in. Please refresh the page.");
                return;
            }
            const messageText = messageInput.value.trim();
            if (messageText) {
                try {
                    await addDoc(messagesColRef, {
                        text: messageText,
                        createdAt: serverTimestamp(),
                        uid: authUser.uid,
                        isAdmin: isAdmin
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error sending message:", error);
                    console.error("Could not send message. See console for details.");
                }
            }
        });

        // Listen for new messages
        function listenToMessages() {
            if (!authUser) return; 
            if (unsubscribe) {
                unsubscribe();
            }
            
            const q = query(messagesColRef);
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                messages.sort((a, b) => {
                    const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                    return timeA - timeB;
                });
                
                renderMessages(messages);
            }, (error) => {
                console.error("Error listening to messages: ", error);
            });
        }
        
        // Render messages to the DOM
        function renderMessages(messages) {
            // FIX: Hide the rules warning once we successfully get data.
            const rulesWarning = document.getElementById('rules-warning');
            
            // Clear existing messages. Don't clear the warning if it's the only thing there.
            if(messages.length > 0 && rulesWarning) {
                 rulesWarning.style.display = 'none';
                 chatMessages.innerHTML = '';
            } else if (rulesWarning) {
                rulesWarning.style.display = 'block';
                chatMessages.innerHTML = '';
                chatMessages.appendChild(rulesWarning);
            } else {
                 chatMessages.innerHTML = '';
            }

            if (messages.length > 0) {
                 messages.forEach(msg => {
                    const messageEl = createMessageElement(msg);
                    chatMessages.appendChild(messageEl);
                });
            } else {
                 if (rulesWarning.style.display == 'none') {
                    chatMessages.innerHTML = `<div class="text-center text-slate-500 my-4">No messages yet. Start the conversation!</div>`;
                 }
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function createMessageElement(msg) {
            const wrapper = document.createElement('div');
            const bubble = document.createElement('div');
            const timestamp = document.createElement('div');

            const isMyMessage = (isAdmin && msg.isAdmin) || (!isAdmin && !msg.isAdmin);
            
            wrapper.classList.add('flex', 'mb-4');
            wrapper.classList.add(isMyMessage ? 'justify-end' : 'justify-start');

            bubble.classList.add('rounded-lg', 'px-4', 'py-2', 'max-w-xs', 'lg:max-w-md');
            bubble.textContent = msg.text;
            bubble.classList.add(isMyMessage ? 'bg-indigo-600' : 'bg-slate-200');
            bubble.classList.add(isMyMessage ? 'text-white' : 'text-slate-800');

            timestamp.classList.add('text-xs', 'text-slate-400', 'mt-1');
            timestamp.classList.add(isMyMessage ? 'text-right' : 'text-left');
            if (msg.createdAt) {
                timestamp.textContent = new Date(msg.createdAt.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            wrapper.appendChild(bubble);
            
            const container = document.createElement('div');
            container.appendChild(wrapper);

            const roleLabel = document.createElement('div');
            roleLabel.classList.add('text-xs', 'font-bold', 'mb-1');
            roleLabel.classList.add(isMyMessage ? 'text-right' : 'text-left');
            roleLabel.classList.add(msg.isAdmin ? 'text-indigo-500' : 'text-slate-500');
            roleLabel.textContent = msg.isAdmin ? 'Admin' : 'Spike';
            
            const messageContentContainer = document.createElement('div');
            if (isMyMessage) {
                 messageContentContainer.classList.add('flex', 'flex-col', 'items-end');
            }
            messageContentContainer.appendChild(roleLabel);
            messageContentContainer.appendChild(bubble);
            messageContentContainer.appendChild(timestamp);

            return messageContentContainer;
        }

    </script>
</body>
</html>
